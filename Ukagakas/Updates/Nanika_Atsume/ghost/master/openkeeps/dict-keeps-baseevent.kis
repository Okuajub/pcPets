#==============================================================================
#
# ??ｿｽ?ｿｽu??ｿｽ?ｿｽﾘ和??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽﾈ易ス??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽg(Kawari Easy Event Programmed Script)
#  ??ｿｽ?ｿｽ??ｿｽ?ｿｽ{??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#
# ??ｿｽ?ｿｽj??ｿｽ?ｿｽd??ｿｽ?ｿｽd??ｿｽ?ｿｽo??ｿｽ?ｿｽr??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ   ??ｿｽ?ｿｽF??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# OpenKEEPS??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ    : ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽd??ｿｽ?ｿｽd??ｿｽ?ｿｽo??ｿｽ?ｿｽr??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽW??ｿｽ?ｿｽF??ｿｽ?ｿｽN??ｿｽ?ｿｽg??ｿｽ?ｿｽ`??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# OpenKEEPS??ｿｽ?ｿｽy??ｿｽ?ｿｽ[??ｿｽ?ｿｽW  : http://keeps.sourceforge.jp
# Version2.0 alpha1 2002.09.25 22:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 alpha2 2002.09.27 22:07??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 alpha3 2002.09.28 20:07??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 alpha4 2002.09.28 22:06??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 alpha5 2002.09.30 21:45??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 beta1  2002.10.07 00:03??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 beta2  2002.10.12 00:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 RC1    2002.10.31 23:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 RC2    2002.11.10 22:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0 RC3    2002.11.25 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.0        2002.12.01 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.1.0      2003.01.03 12:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.1.1      2003.01.26 23:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.1.2      2003.03.03 23:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2        2003.04.01 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2.1      2003.04.14 22:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2.2      2003.05.01 18:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2.3      2003.05.18 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2.4      2003.06.16 23:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.2.5      2003.07.31 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version2.3.0 snapshot0309211444 2003.09.21 15:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.0      2004.06.06 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.1      2004.06.10 21:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.2      2004.06.19 23:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.3      2004.06.20 18:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.4      2004.06.27 11:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.5      2004.07.03 11:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.6      2004.07.10 13:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.7      2004.07.18 22:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.8      2004.07.25 21:45??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.0.9      2004.08.08 18:45??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.0      2004.09.12 14:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.1      2004.09.19 23:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.2      2004.09.26 23:15??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.3      2004.10.16 16:15??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.4      2004.10.30 22:45??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.5      2004.11.13 20:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.6      2004.11.23 22:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.1.9      2005.01.10 22:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a1    2005.04.29 23:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a2    2005.05.01 12:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a3    2005.05.04 02:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a4    2005.05.22 21:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a5    2005.09.29 23:45??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a6    2005.10.17 00:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a7    2005.10.30 22:00??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# Version3.3.0a8    2005.11.06 17:30??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#
#==============================================================================
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ象：??ｿｽ?ｿｽu??ｿｽ?ｿｽﾘ和??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽvPhase 8.2.2 ??ｿｽ?ｿｽy??ｿｽ?ｿｽﾑ擾ｿｽﾊ互奇ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#           ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽi??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽu??ｿｽ?ｿｽf??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽjMATERIA period 583 ??ｿｽ?ｿｽﾈ擾ｿｽ
#           CROW??ｿｽ?ｿｽASSP??ｿｽ?ｿｽAninix??ｿｽ?ｿｽA??ｿｽ?ｿｽU??ｿｽ?ｿｽﾑ鯉ｿｽﾅの難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#==============================================================================


#==============================================================================
#??ｿｽ?ｿｽﾈ会ｿｽ GET SHIORI/3.0??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg
#==============================================================================


#??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽf??ｿｽ?ｿｽ[??ｿｽ?ｿｽ^??ｿｽ?ｿｽﾇ搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ==================================================

System.Callback.OnLoad : $(
	# ??ｿｽ?ｿｽZ??ｿｽ?ｿｽ[??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ有??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ迴会ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ閧ｷ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	foreach @i kp.datasaveparam $(.inc @entnum $(.size ${@i}));
	if $[ ! ${@entnum} ] $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽt??ｿｽ?ｿｽ@??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽ[??ｿｽ?ｿｽu??ｿｽ?ｿｽf??ｿｽ?ｿｽ[??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr kp.isfirstboot 1;
	);

	# ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ不??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ終??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr kp.iscrashed 0;
	if $[ ($(GetInteger closemode) == 0 || $(.size closemode) == 0) && ${kp.isfirstboot} != 1 ] $(
		.setstr kp.iscrashed 1;
		LogMsg "This ghost terminated abnormally at the previous session.";
	);

	# ??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ^??ｿｽ?ｿｽﾌデ??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽl??ｿｽ?ｿｽﾝ抵ｿｽ
	.setstr cntwork $(MinCalc);
	.setstr worktime.OS 0;

	if $[ $(.size Character0) == 0 ] $(GetDescript);
	if $[ $(.size freeze) == 0 ] $(resetFreeze);
	if $[ $(.size sw.randomtalk) == 0 ] $(RandomtalkOn);
	.setstr kp.bootmutex 0;

	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ`??ｿｽ?ｿｽF??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽp??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr BeforeMailNo 0;
	.setstr BeforeMailByte 0;

	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽU??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	GetifExist kp.callback.OnLoad;
)

#==============================================================================



#(OnMinuteChange)====================================================


event.OnMinuteChange : $(
	if ${iconizing} $(
		SecureInc minimizedtime;
		SecureInc time.iconize;
		SecureInc time.iconize.total;
	) else $(
		SecureInc time.desktop;
		SecureInc time.desktop.total;
	);
	.setstr worktime.OS $(IntReference 0);
	.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});
	.setstr @min $(date %M);
	if $[${food} != "empty" && ${food} != "none" && (${@min} = '10' || ${@min} = '20' || ${@min} = '30' || ${@min} = '40' || ${@min} = '50' || ${@min} = '00') && $[$(size RandomCat) > 0]] $(
		setstr NewCat $(shift RandomCat); $(
			if $[$[${NewCat} != ${CurrentCat}] && $[${CurrentCat} = "none"]] $(setstr CurrentCat ${NewCat}; return $(TheCatReturns ${CurrentCat}))
			else if $[${NewCat} != ${CurrentCat} && ${NewCat} != ${CurrentCat2} && $[${CurrentCat2} = "none"]] $(setstr CurrentCat2 ${newcat}; return $(TheCatReturns ${CurrentCat2})
			)
		)
	);
	if $[${@min} = '15' || ${@min} = '25' || ${@min} = '35' || ${@min} = '45' || ${@min} = '55' || ${@min} = '05' && ($(length ${CurrentCat}) > 0) && ${CurrentCat} != "none"] $(
		setstr @LeavingCat ${CurrentCat}; setstr CurrentCat "none"; setstr CurrentCat ${CurrentCat2}; setstr CurrentCat2 "none"; return $(TheCatExits ${@LeavingCat})
		);
	if $[$(date %H)$(date %M) > $[${foodTimeOut} + 100] || (${foodTimeOut} >= 2300 && ${foodTimeOut} < 2400 && ($(date %H)$(date %M) > $[${foodTimeOut} - 2300])) || $[$(size RandomCat) = 1]] $(
		setstr foodTimeOut "9999"; 
		if $[${food} = "wet"] $(setstr mode "wetempty"; setstr food "empty") 
		else if $[${food} = "dry"] $(setstr mode "dryempty"; setstr food "empty") 
		else if $[${food} = "dessert"] $(setstr mode "dessertempty"; setstr food "empty")
		);
	if $(isNotFreezing) $(TalkSearch "kp.onminutechange");
)

kp.onminutechange (
	$(TimeTalk),logfile
	$(Worktime)
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onminutechange

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN(TimeTalk)--------------------------------------------------

=kis
function TimeTalk $(
	.setstr kp.nowtime $(KPdate %s);
	.setstr @talkentry $(EntrySearch "kp.timetalk");
	if $[ $(.length ${@talkentry}) != 0 ] $(.entry @talkentry);
	.clear kp.nowtime;
);
=end

kp.timetalk (
	TalkTime.$(KPdate %Y_%m%d_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %m%d_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %w_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %H%M ${kp.nowtime})
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.timetalk

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : TimeTalk

#??ｿｽ?ｿｽo??ｿｽ?ｿｽﾟ趣ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(WorkTime)------------------------------------------------------------

=kis
function Worktime $(
	if $(GetString parawork) $(
		# WorktimeB
		# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔで計??ｿｽ?ｿｽZ
		.setstr cntwork $(GetInteger cntwork);
		.setstr worktime $(GetInteger worktime);
		# ??ｿｽ?ｿｽL??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆの搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ以難ｿｽ??ｿｽ?ｿｽﾈゑｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		if $[ ( $(MinCalc) - ${cntwork} ) < 60 ] $(return);
		.inc worktime $[ ( $(MinCalc) - ${cntwork} ) / 60 ];
		.inc cntwork $[ $(MinCalc) - ${cntwork} ];
	) else $(
		# WorktimeA
		# ??ｿｽ?ｿｽV??ｿｽ?ｿｽX??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔで計??ｿｽ?ｿｽZ
		.setstr @cntwork.OS $(GetInteger cntwork.OS);
		.setstr worktime ${worktime.OS};
		if $[ $(.size cntwork.OS) == 0 ] $(
			# OS??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ擾ｿｽ??ｿｽ?ｿｽ謫ｾ??ｿｽ?ｿｽﾈゑｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ謫ｾ??ｿｽ?ｿｽﾌみで終??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr cntwork.OS ${worktime.OS};
			return;
		);
		.setstr cntwork.OS ${worktime.OS};
		# ??ｿｽ?ｿｽL??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆの搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ以難ｿｽ??ｿｽ?ｿｽﾈゑｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		if $[ ( ${worktime.OS} - ${@cntwork.OS} ) < 1 ] $(return);
	);
	# WorktimeX
	# ??ｿｽ?ｿｽL??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽﾈ擾ｿｽ)??ｿｽ?ｿｽo??ｿｽ?ｿｽﾟゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr kp.modifier $(ModifierSearch "kp.worktime" ${worktime});
	.setstr @talkentry $(EntrySearch "kp.worktimetalk");
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄてゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽs??ｿｽ?ｿｽv??ｿｽ?ｿｽﾈ費ｿｽ??ｿｽ?ｿｽﾈので記??ｿｽ?ｿｽq??ｿｽ?ｿｽ?ｿｽ?ｿｽ?(03\07/01)
	if $[ $(.length ${@talkentry}) != 0 ] $(.entry @talkentry);
	.clear kp.modifier;
);
=end

kp.worktimetalk (
	TalkWorktime.${kp.modifier},
	TalkWorktime,
	TalkGeneral
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.worktimetalk

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : Worktime

#OS??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ取得??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN(OSworktime)----------------------------------------------

System.Callback.OnLoad : $(
	KTM.RunTask $(
		KTM.CreateTask
		"OSworktime"
		KTM.TRUE
		task.OSworktime.proc
		KTM.RANK4
	);
)

task.OSworktime.proc : $(
	# ??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽOnSecondChange??ｿｽ?ｿｽ??ｿｽ?ｿｽOS??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ??ｿｽ?ｿｽ謫ｾ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ鯉ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ~
	# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ閧ｷ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ轤ｩ??ｿｽ?ｿｽﾌ趣ｿｽ??ｿｽ?ｿｽﾔ擾ｿｽ??ｿｽ?ｿｽﾍ奇ｿｽ??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌタ??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽRUN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽK??ｿｽ?ｿｽv??ｿｽ?ｿｽﾍ厄ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if $[ ! $(.size cntwork.OS) ] $(.setstr cntwork.OS ${worktime.OS});
	KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
	return;
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : task.OSworktime.proc

#==============================================================================


#??ｿｽ?ｿｽb??ｿｽ?ｿｽP??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnSecondChange)====================================================

#??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏゑｿｽ驍ｲ??ｿｽ?ｿｽﾆ（??ｿｽ?ｿｽﾂまゑｿｽP??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ）??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ

#??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ(TalkKasanari)??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽ(TalkMikire)
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN(Talkevent)??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ使??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnSecondChange : $(
	# OS??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ??ｿｽ?ｿｽ謫ｾ
	.setstr worktime.OS $(IntReference 0);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛの費ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽR??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ責任??ｿｽ?ｿｽﾅ行??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
	if $[ $(isNotFreezing) && $(KTM.GetMailNo AITalk) ] $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ{??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌエ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		Talk $(KTM.GetMailMessage AITalk);
		while $(KTM.GetMailNo AITalk) $(
			KTM.DeleteMail AITalk;
		);
	);
)

#??ｿｽ?ｿｽﾖ連??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ

System.Callback.OnLoad : $(
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆの重??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	KTM.RunTask $(
		KTM.CreateTask
		"TimeTalkCheck"
		task.timetalkcheck.cond
		task.timetalkcheck.proc
		KTM.RANK1
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN
	KTM.RunTask $(
		KTM.CreateTask
		"AITalk"
		task.TalkEvent.cond
		task.TalkEvent.proc
		KTM.RANK1
		task.TalkEvent.init
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽ
	KTM.RunTask $(
		KTM.CreateTask
		"MikireTalk"
		task.TalkMikire.cond
		task.TalkMikire.proc
		KTM.RANK1
		task.TalkMikire.init
	);
	# ??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ
	KTM.RunTask $(
		KTM.CreateTask
		"KasanariTalk"
		task.TalkKasanari.cond
		task.TalkKasanari.proc
		KTM.RANK1
		task.TalkKasanari.init
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽNMutex??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	KTM.CreateMutex AITalk;
	silent;
)

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN(TalkEvent)---------------------------------------------------------

task.TalkEvent.init : $(
	if $[ ${interval} < 1 || $(.size interval) == 0 ] $(
		.setstr interval ${interval.default};
	);
	resetTalkcount;
	.setstr kp.cnttalkevent 0;
)

task.TalkEvent.cond : $[ $(isNotFreezing) && $(isRandomtalkOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkEvent.proc : $(
	# ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽr??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ、??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if $[ ${System.Request.Status} == "talking" ] $(resetTalkcount; return);
	SecureDec cnttalk 1 0;
	.setstr @interval $(GetInteger kp.currentinterval 0);
	SecureInc kp.cnttalkevent 1 ${@interval};
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ闕橸ｿｽﾝで会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ闕橸ｿｽﾝ終??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ57??ｿｽ?ｿｽb??ｿｽ?ｿｽﾅ趣ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN
	if $[ ${kp.cnttalkevent} >= ${@interval} && ${cnttalk} > 57 ] $(
		.setstr cnttalk 57;
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ~??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾅなゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if ${cnttalk} $(return);
	if $(KTM.LockMutex AITalk) $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ~??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾅ、AITalk Mutex??ｿｽ?ｿｽm??ｿｽ?ｿｽﾛ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		if $(.size talkqueue) $(
			# ??ｿｽ?ｿｽ??ｿｽ?ｿｽU??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ変奇ｿｽ
			.setstr tempsentence $(.shift talkqueue);
			.setstr @talk "!tempsentence";
		) else $(
			# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ暦ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽAtempsentence??ｿｽ?ｿｽﾍ不??ｿｽ?ｿｽv
			if $(.size tempsentence) $(.clear tempsentence);
			.setstr @talk "sentence";
		);
		KTM.PostMail AITalk ${@talk};
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
		.setstr kp.cnttalkevent 0;
	);
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	task.TalkEvent.init,
	task.TalkEvent.cond,
	task.TalkEvent.proc
)

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽ(TalkMikire)------------------------------------------------------------

task.TalkMikire.init : $(.setstr flagmikire 0 ; .setstr cntmikire 5)

task.TalkMikire.cond : $[ $(isNotFreezing) && $(isMikireOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkMikire.proc : $(
	if ${System.Request.Reference1} $(
		# mikire1
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		SecureDec cntmikire 1 0;
		# ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽP??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		if ${cntmikire} $(return);
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN
		.setstr flagmikire 1;
		.setstr cntmikire 60;
		.setstr @talk "TalkMikire";
	) else $(
		# mikire2
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?
		.setstr cntmikire 5;
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾄなゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		if $[ ! $(GetInteger flagmikire) ] $(return);
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr flagmikire 0;
		.setstr @talk "TalkMikirez";
	);
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk ${@talk};
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
	);
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	task.TalkMikire.init,
	task.TalkMikire.cond,
	talk.TalkMikire.proc
)

#??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ(TalkKasanari)----------------------------------------------------------

task.TalkKasanari.init : $(.setstr cntkasanari 8)

task.TalkKasanari.cond : $[ $(isNotFreezing) && $(isKasanariOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkKasanari.proc : $(
	if $[ ! ${System.Request.Reference2} ] $(
		# ??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾈゑｿｽ
		.setstr cntkasanari 8;
		return;
	);
	# ??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?
	SecureDec cntkasanari 1 0;
	# ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽP??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if ${cntkasanari} $(return);
	# ??ｿｽ?ｿｽd??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr cntkasanari 60;
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk "TalkKasanari";
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
	);
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	task.TalkKasanari.init,
	task.TalkKasanari.cond,
	task.TalkKasanari.proc
)

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝチ??ｿｽ?ｿｽF??ｿｽ?ｿｽb??ｿｽ?ｿｽN------------------------------------------------
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽOnMinuteChange??ｿｽ?ｿｽﾅト??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌなゑｿｽA??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅはなゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ40??ｿｽ?ｿｽb??ｿｽ?ｿｽﾌ趣ｿｽ??ｿｽ?ｿｽﾉチ??ｿｽ?ｿｽF??ｿｽ?ｿｽb??ｿｽ?ｿｽN
task.timetalkcheck.cond : $[ $(isNotFreezing) && $(KPdate %r) == 40 ]

task.timetalkcheck.proc : $(
	.setstr kp.nowtime $[ $(KPdate %s) + 20 ];
	.setstr @talkentry $(EntrySearch "kp.timetalk");
	if $[ $(.length ${@talkentry}) != 0 ] $(resetTalkcount);
	.clear kp.nowtime;
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : task.timetalkcheck.cond, task.timetalkcheck.proc

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ_??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg(OnOKTalkCtrl)======================================
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ場合??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ_??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ}??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ\![raise]??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ艪ｷ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛに使??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽﾆ趣ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ`??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽBOpenKEEPS??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽGhost ID(kp.gid)??ｿｽ?ｿｽﾆ、
#Reference0??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾉのみ機??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽB

event.OnOKTalkCtrl : $(
	if $[ $(Reference 0) != ${kp.gid} ] $(return);
	#if $[ $(.tolower ${System.Request.SecurityLevel}) != "local" ] $(return);

	.setstr @cmd $(Reference 1);
	if $[ ${@cmd} == "stop" ] $(
		RandomtalkOff;
	) else if $[ ${@cmd} == "start" ] $(
		RandomtalkOn;
	) else if $[ ${@cmd} == "freeze" ] $(
		RandomtalkOff;
		setFreeze;
	) else if $[ ${@cmd} == "reset" ] $(
		RandomtalkOn;
		resetFreeze;
	);
	silent;
)

#==============================================================================

#(OnFirstBoot)=========================================================

event.OnFirstBoot : $(
	if ${kp.isfirstboot} $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ真??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈのでパ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		FirstInitCond;
		.setstr kp.isfirstboot 0;
	);
	InitCond;
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜでに擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｩ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if $(NonNegReference 0) $(
		.setstr kp.modifier "Vanished";
		.setstr count.delete $(NonNegReference 0);
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA
	GetifExist kp.callback.OnFirstBoot;
	TalkSafeSearch "kp.onfirstboot";
	.clear kp.modifier;
)

=kis
function FirstInitCond $(
	.setstr SnowballName ${WhitecatNames};
	.setstr ToonyName ${GreywhitecatNames};
	.setstr FirestarName ${OrangecatNames};
	.setstr RomeoName ${BlackcatNames};
	.setstr GrayName ${GreycatNames};
	.setstr GreystripeName ${GreystripecatNames};
	.setstr RandomCat "none";
	.setstr CurrentCat "none";
	.setstr CurrentCat2 "none";
	.setstr food "empty";
	.setstr mode "dryempty";
	.setstr count.boot 0;
	.setstr count.delete 0;
	.setstr time.desktop.total 0;
	.setstr time.iconize.total 0;
	if $[ $(.size user) == 0 ] $(.setstr username ${username.default});
);
=end

kp.onfirstboot (
	TalkFirstboot.${count.delete}.${timezone},
	TalkFirstboot.${count.delete},
	TalkFirstboot.${kp.modifier}.${timezone},
	TalkFirstboot.${kp.modifier},
	TalkFirstboot.${timezone},
	TalkFirstboot,
	TalkGeneral
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onfirstboot

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : FirstInitCond

#==============================================================================


#??ｿｽ?ｿｽﾊ擾ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnBoot)==============================================================

event.OnBoot : $(
	if $[ ! ${kp.bootmutex} ] $(
		# OnGhostCalled??ｿｽ?ｿｽﾅ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽOnBoot??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏゑｿｽ
		InitCond;
		GetifExist kp.callback.OnBoot;
	);
	BootCondSearch;
	TalkSafeSearch "kp.onboot"$(if $(isCrashed) "2");
	.clear kp.modifier;
)

kp.onboot (
	TalkBootup.${timezone}.$(KPdate %m%d),
	TalkBootup.$(KPdate %m%d),
	TalkBootup.${kp.modifier},
	TalkBootup.${timezone},
	TalkBootup,
	TalkGeneral
)

# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# TalkCrashed??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽkp.onboot??ｿｽ?ｿｽﾆ具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
.setstr kp.onboot2 "TalkCrashed";
.copy kp.onboot kp.onboot2;
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onboot,kp.onboot2

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ変更(OnGhostChanged/OnGhostCalled)==========================

event.OnGhostChanged : $(
	# ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌは、InitCond??ｿｽ?ｿｽﾌ前??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(closemode??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏゑｿｽ驍ｩ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)
	.setstr @isRebooted $(isRebooted);
	if ${@isRebooted} $(
		# ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)
		resetFreeze;
		InheritCond;
		.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});
	) else $(
		# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切替起??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		InitCond;
	);
	BootCondSearch;
	GhostChangedCommon "ghostchanged" ${@isRebooted};
	.clear kp.modifier;
)

event.OnGhostCalled : $(
	#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ場合??ｿｽ?ｿｽA??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ有??ｿｽ?ｿｽ闢ｾ??ｿｽ?ｿｽﾈゑｿｽ
	InitCond;
	BootCondSearch;
	GhostChangedCommon "ghostcalled" 0;
	.clear kp.modifier;
)

=kis
# OnGhostChanged/OnGhostCalled??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ghostchanged/ghostcalled
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ2??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ^??ｿｽ?ｿｽA??ｿｽ?ｿｽ痰､??ｿｽ?ｿｽﾈゑｿｽU
function GhostChangedCommon $(
	if $[ $(.size @arg) != 3 ] $(return);

	.setstr beforeghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr beforename $(NormReference 2);
	);
	SearchKeyword "kp."$@arg[1]"words" $(Reference 1);
	GetifExist kp.callback.OnGhostChanged;
	TalkSafeSearch "kp.on"$@arg[1]$(
		if $(isCrashed)
			"2"
		else if $@arg[2]
			"3"
	);
	.clear scriptwords;
	.clear beforeghost;
	.clear beforename;
);
=end

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ2??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽ`??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽZ??ｿｽ?ｿｽ[??ｿｽ?ｿｽW
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl:    ***ghost,***name??ｿｽ?ｿｽﾍ趣ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾉセ??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#          ??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ、scriptwords??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉキ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
function SearchKeyword $(
	if $[ $(.size @arg) != 3 ] $(return);

	# ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr @ghostwords $(EntrySearch $@arg[1]);
	if $[ $(.length ${@ghostwords}) != 0 ] $(
		# script1
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾖのコ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr @ghostscript $(StringUserNormalize $@arg[2]);
		# script2
		loop $(EntrySize ${@ghostwords}) $(
			.setstr @i ${-1};
			.setstr scriptwords $(EntryRefer ${@ghostwords} ${@i});
			if $[ ${@ghostscript} =~ ${scriptwords} ] $(break);
			.clear scriptwords;
		);
	);
);
=end

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanged.ghostname (
	TalkGhostChangedEx.${beforeghost}.${beforename}.$(KPdate %m%d).${scriptwords},
	TalkGhostChangedEx.${beforeghost}.${beforename}.$(KPdate %m%d),
	TalkGhostChangedEx.${beforeghost}.${beforename}.${scriptwords},
	TalkGhostChangedEx.${beforeghost}.${beforename}
)
kp.onghostcalled.ghostname (
	TalkGhostCalledEx.${beforeghost}.${beforename}.$(KPdate %m%d).${scriptwords},
	TalkGhostCalledEx.${beforeghost}.${beforename}.$(KPdate %m%d),
	TalkGhostCalledEx.${beforeghost}.${beforename}.${scriptwords},
	TalkGhostCalledEx.${beforeghost}.${beforename}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanged.normal (
	TalkGhostChanged.${beforeghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostChanged.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostChanged.${beforeghost}.$(KPdate %m%d),
	TalkGhostChanged.${beforeghost}.${scriptwords},
	TalkGhostChanged.__other__.$(KPdate %m%d),
	TalkGhostChanged.__other__.${scriptwords},
	TalkGhostChanged.${beforeghost}
)
kp.onghostcalled.normal (
	TalkGhostCalled.${beforeghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostCalled.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostCalled.${beforeghost}.$(KPdate %m%d),
	TalkGhostCalled.${beforeghost}.${scriptwords},
	TalkGhostCalled.__other__.$(KPdate %m%d),
	TalkGhostCalled.__other__.${scriptwords},
	TalkGhostCalled.${beforeghost}
)

# ??ｿｽ?ｿｽﾄ用??ｿｽ?ｿｽI??ｿｽ?ｿｽﾈ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanged.general (
	TalkGhostChanged
)
kp.onghostcalled.general (
	TalkGhostCalled
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ関係??ｿｽ?ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanged.timetalk (
	TalkGhostChanged.${kp.modifier}
)
kp.onghostcalled.timetalk (
	TalkGhostCalled.${kp.modifier}
)

# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.ghostchangedwords.ghostname (
	GhostChangedWords.${beforeghost}.${beforename}
)
kp.ghostcalledwords.ghostname (
	GhostCalledWords.${beforeghost}.${beforename}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌキ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.ghostchangedwords.normal (
	GhostChangedWords.${beforeghost},
	GhostChangedWords.__other__
)
kp.ghostcalledwords.normal (
	GhostCalledWords.${beforeghost},
	GhostCalledWords.__other__
)

#??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘ替趣ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ優??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾊゑｿｽﾝ抵ｿｽ
=kis
if ${kp.config.useghostchangetimefirst} $(
	.copy kp.onghostchanged.timetalk kp.onghostchanged;
	.copy kp.onghostcalled.timetalk kp.onghostcalled;
);
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostchanged.ghostname kp.onghostchanged;
	.copy kp.ghostchangedwords.ghostname kp.ghostchangedwords;
	.copy kp.onghostcalled.ghostname kp.onghostcalled;
	.copy kp.ghostcalledwords.ghostname kp.ghostcalledwords;
);
.copy kp.onghostchanged.normal kp.onghostchanged;
.copy kp.onghostcalled.normal kp.onghostcalled;
if $[ ! ${kp.config.useghostchangetimefirst} ] $(
	.copy kp.onghostchanged.timetalk kp.onghostchanged;
	.copy kp.onghostcalled.timetalk kp.onghostcalled;
);
# changed/called??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽAOnBoot??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝゑｿｽ
.copy kp.onghostchanged.general kp.onghostchanged;
.copy kp.onboot kp.onghostchanged;
.copy kp.ghostchangedwords.normal kp.ghostchangedwords;
.copy kp.onghostcalled.general kp.onghostcalled;
.copy kp.onboot kp.onghostcalled;
.copy kp.ghostcalledwords.normal kp.ghostcalledwords;
=end

# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# TalkCrashed??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽkp.onghostchanged??ｿｽ?ｿｽﾆ具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
.setstr kp.onghostchanged2 "TalkCrashed";
.copy kp.onghostchanged kp.onghostchanged2;
.setstr kp.onghostcalled2 "TalkCrashed";
.copy kp.onghostcalled kp.onghostcalled2;
=end

# ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# TalkRebooted??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽD??ｿｽ?ｿｽ謔ｳ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽkp.onghostchanged??ｿｽ?ｿｽﾆ具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
.setstr kp.onghostchanged3 "TalkRebooted";
.copy kp.onghostchanged kp.onghostchanged3;
# OnGhostCalled??ｿｽ?ｿｽﾍ再起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ暦ｿｽ??ｿｽ?ｿｽ骼厄ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ闢ｾ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ必??ｿｽ?ｿｽv??ｿｽ?ｿｽﾈゑｿｽ
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onghostchanged,
	kp.onghostchanged2,
	kp.onghostchanged3,
	ghostchangedwords,
	kp.onghostcalled,
	kp.onghostcalled2,
	ghostcalledwords
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : GhostChangedCommon, SearchKeyword

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnGhostCallComplete)=================================

event.OnGhostCallComplete : $(
	.setstr nextghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr nextname $(NormReference 2);
	);
	SearchKeyword "kp.ghostcallcompletewords" $(Reference 1);
	if $[ ${System.Request.Status} == "talking" ] $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽOnGhostCalling??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄなゑｿｽ
		.setstr @talkentry $(EntrySearch "kp.onghostcallcomplete");
		if $[ $(.length ${@talkentry}) != 0 ] $(
			Sys.SaveHeader ${kp.onghostcallcompleteheader};
			KTM.PostMail OnGhostCallComplete ${@talkentry};
			KTM.RunTask ${kp.onghostcallcompletetask};
			return;
		);
	) else $(
		# ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅはなゑｿｽ??ｿｽ?ｿｽﾌで包ｿｽ??ｿｽ?ｿｽﾊに会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		TalkSearch "kp.onghostcallcomplete";
	);
	.clear scriptwords;
	.clear nextghost;
	.clear nextname;
)

# ??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN
task.GhostCallComplete.init : $(.setstr $(KTM.Local counter) 5)

task.GhostCallComplete.cond : $[ ${System.Request.Status} != "talking" ]

task.GhostCallComplete.proc : $(
	# ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉなゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ5??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜで待ゑｿｽ
	SecureDec $(KTM.Local counter) 1 0;
	if ${$(KTM.Local counter)} $(return);

	# ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾂ能
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk "!task.GhostCallComplete.procsub";
		# 5??ｿｽ?ｿｽb??ｿｽ?ｿｽﾒ機??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr $(KTM.Local counter) 5;
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
		KTM.PostMail SYSTEM M_STOP ${kp.onghostcallcompletetask};
	);
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛにト??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽu??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽV??ｿｽ?ｿｽ[??ｿｽ?ｿｽW??ｿｽ?ｿｽ??ｿｽ?ｿｽ
task.GhostCallComplete.procsub : $(
	# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ最鯉ｿｽﾌゑｿｽ??ｿｽ?ｿｽﾌゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈので、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽﾇみ費ｿｽﾎゑｿｽ
	while $(KTM.GetMailNo OnGhostCallComplete) $(
		.setstr @talk $(KTM.GetMailMessage OnGhostCallComplete);
		KTM.DeleteMail OnGhostCallComplete;
	);
	# ??ｿｽ?ｿｽw??ｿｽ?ｿｽb??ｿｽ?ｿｽ_??ｿｽ?ｿｽ??ｿｽ?ｿｽOnGhostCallComplete??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽﾔに包ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	Sys.LoadHeader ${kp.onghostcallcompleteheader};
	EntryRefer ${@talk};
	Sys.RewindHeader;
	.clear scriptwords;
	.clear nextghost;
	.clear nextname;
)

# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆヘ??ｿｽ?ｿｽb??ｿｽ?ｿｽ_??ｿｽ?ｿｽX??ｿｽ?ｿｽ^??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
.setstr kp.onghostcallcompletetask $(
	KTM.CreateTask
	"DelayedOnGhostCallComplete"
	task.GhostCallComplete.cond
	task.GhostCallComplete.proc
	KTM.RANK0
	task.GhostCallComplete.init
);
.setstr kp.onghostcallcompleteheader $(Sys.CreateHeaderHandle);
=end

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostcallcomplete.ghostname (
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.$(KPdate %m%d).${scriptwords},
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.${scriptwords},
	TalkGhostCallCompleteEx.${nextghost}.${nextname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostcallcomplete.normal (
	TalkGhostCallComplete.${nextghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostCallComplete.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostCallComplete.${nextghost}.$(KPdate %m%d),
	TalkGhostCallComplete.${nextghost}.${scriptwords},
	TalkGhostCallComplete.__other__.$(KPdate %m%d),
	TalkGhostCallComplete.__other__.${scriptwords},
	TalkGhostCallComplete.${nextghost}
)

# ??ｿｽ?ｿｽﾄ用??ｿｽ?ｿｽI??ｿｽ?ｿｽﾈ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostcallcomplete.general (
	TalkGhostCallComplete,
	TalkGeneralComplete
)

# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.ghostcallcompletewords.ghostname (
	GhostCallCompleteWords.${nextghost}.${nextname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌキ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.ghostcallcompletewords.normal (
	GhostCallCompleteWords.${nextghost},
	GhostCallCompleteWords.__other__
)

#??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘ替趣ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ優??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾊゑｿｽﾝ抵ｿｽ
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostcallcomplete.ghostname kp.onghostcallcomplete;
	.copy kp.ghostcallcompletewords.ghostname kp.ghostcallcompletewords;
);
.copy kp.onghostcallcomplete.normal kp.onghostcallcomplete;
.copy kp.onghostcallcomplete.general kp.onghostcallcomplete;
.copy kp.ghostcallcompletewords.normal kp.ghostcallcompletewords;
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onghostcallcomplete,
	kp.ghostcallcompletewords,
	task.GhostCallComplete.init,
	task.GhostCallComplete.cond,
	task.GhostCallComplete.proc,
	task.GhostCallComplete.procsub,
	kp.onghostcallcompletetask,
	kp.onghostcallcompleteheader
)

#==============================================================================


#??ｿｽ?ｿｽﾊ擾ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ================================================
#??ｿｽ?ｿｽZ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔで再呼び出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍｢??ｿｽ?ｿｽﾍ久??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽﾉ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛの各??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾗゑｿｽ
=kis
function BootCondSearch $(
	.setstr kp.modifier $(ModifierSearch "kp.boot.short" $[ $(MinCalc) - ${endtime} ]);
	if $[ ${kp.modifier} == "nothing" ] $(
		.setstr kp.modifier $(ModifierSearch "kp.boot.long" $[ $(DayCalc) - ${endday} ]);
	);
);
=end

# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ(!=??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ)??ｿｽ?ｿｽﾌタ??ｿｽ?ｿｽC??ｿｽ?ｿｽ}??ｿｽ?ｿｽE??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
=kis
function InitCond $(
	resetFreeze;
	KTM.PostMail "FreezeCheck" "M_MSG" ${System.Request.ID};
	# ??ｿｽ?ｿｽx??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽE??ｿｽ?ｿｽF??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[
	.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽd??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh??ｿｽ?ｿｽ~??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽmutex??ｿｽ?ｿｽ`??ｿｽ?ｿｽF??ｿｽ?ｿｽb??ｿｽ?ｿｽN
	if $(GetString kp.bootmutex) $(return);
	.setstr kp.bootmutex 1;
	.inc count.boot;
	.setstr time.desktop 0;
	.setstr time.iconize 0;
	.setstr minimizedtime 0;
	.setstr worktime 0;
	.setstr closemode 0;
	.setstr mousecount 0;
	.setstr res.phase 0;
	if $[!${mode}] $(setstr mode "none");
	if $[!${food}] $(setstr food "none");
	if $[!${mode}] $(setstr foodTimeOut "9999");
	if $[!${SnowballName}] $(setstr SnowballName ${WhitecatNames});
	if $[!${ToonyName}] $(setstr ToonyName ${GreywhitecatNames});
	if $[!${FirestarName}] $(setstr FirestarName ${OrangecatNames});
	if $[!${RomeoName}] $(setstr RomeoName ${BlackcatNames});
	if $[!${GrayName}] $(setstr GrayName ${GreycatNames});
	if $[!${GreystripeName}] $(setstr GreystripeName ${GreystripecatNames});
	if $[!${RandomCat}] $(setstr RandomCat "none");
	if $[!${CurrentCat}] $(setstr CurrentCat "none");
	if $[!${CurrentCat2}] $(setstr CurrentCat2 "none");
	SaveData;
);
=end

# OnGhostChanged??ｿｽ?ｿｽﾅ再起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾇゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ閧ｷ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ1)
=kis
function isRebooted $(
	if $[ $(Reference 0) == ${Character0} && ${closemode} == 3 ] $(
		if $[ $(Reference 2) == ${System.SelfName} ] $(
			return 1;
		) else if $[ $(Reference 2) == "" && $(MinCalc) - ${endtime} <= 3 ] $(
			return 1;
		);
	);
	return 0;
);
=end


# SSP??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽﾇみ搾ｿｽ??ｿｽ?ｿｽﾝ趣ｿｽ??ｿｽ?ｿｽR??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ
event.OnCacheRestore : $(
	GetifExist kp.callback.OnLoad;
	# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏなゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	split @tasklist $(KTM.Tasklist) "|";
	foreach @task @tasklist $(
		if $(.match_at ${@task} "FreezeCheck/") $(
			KTM.RunTask $(.substr ${@task} 12);
			return;
		);
	);
)

# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏなゑｿｽ??ｿｽ?ｿｽﾉなるこ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN

task.freezecheck.init : $(
	if $[ $(GetInteger closemode) == 3 ] $(
		# ??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈのゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ轤ｩ??ｿｽ?ｿｽﾈので、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr $(KTM.Local counter) 58;
	) else if $[ $(GetInteger closemode) == 2 ] $(
		# ??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽﾅ再起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		InheritCond;
		.dec count.boot 1 0;
	) else $(
		.setstr $(KTM.Local counter) 0;
	);
)

task.freezecheck.proc : $(
	if $[ $(isNotFreezing) || $(KTM.GetMailNo FreezeCheck) ] $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ{??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽﾉ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ?ｿｽ?ｿｽ??ｿｽ?ｿｽu??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄなゑｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽﾆ鯉ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
		# ??ｿｽ?ｿｽﾄ度??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌはキ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr $(KTM.Local counter) 0;
		while $(KTM.GetMailNo FreezeCheck) $(KTM.DeleteMail FreezeCheck);
		return;
	);
	.inc $(KTM.Local counter);
	if $[ ${$(KTM.Local counter)} == 60 ] $(
		# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ60??ｿｽ?ｿｽb??ｿｽ?ｿｽﾔフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏなゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ繧ｾ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		resetFreeze;
		InheritCond;
		return;
	);
)

# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ
System.Callback.OnLoad : $(
	# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽY??ｿｽ?ｿｽﾄ趣ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	KTM.RunTask $(
		KTM.CreateTask
		"FreezeCheck"
		KTM.TRUE
		task.freezecheck.proc
		KTM.RANK4
		task.freezecheck.init
	)
)

# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ}??ｿｽ?ｿｽE??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ継??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# InitCond??ｿｽ?ｿｽ??ｿｽ?ｿｽ闖ｭ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ繧｢??ｿｽ?ｿｽB??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ再起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽB
=kis
function InheritCond $(
	KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽd??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh??ｿｽ?ｿｽ~??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽmutex??ｿｽ?ｿｽ`??ｿｽ?ｿｽF??ｿｽ?ｿｽb??ｿｽ?ｿｽN
	if $(GetString kp.bootmutex) $(return);
	.setstr kp.bootmutex 1;
	SecureInc count.boot;
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌケ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽﾉなゑｿｽﾌゑｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌで、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	SecureInc time.iconize $(GetInteger time.iconize.before);
	SecureInc time.desktop $(GetInteger time.desktop.before);
	.setstr minimizedtime 0;
	if $(GetString parawork) $(
		.setstr worktime $[ ( ${time.desktop} + ${time.iconize} ) / 60 ];
		SecureDec cntwork $[ ( ${time.desktop} + ${time.iconize} ) % 60 ];
	 ) else $(
		.setstr worktime 0;
	);
	.setstr closemode 0;
	.setstr mousecount 0;
	.setstr res.phase 0;
	SaveData;
);
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : task.freezecheck.init, task.freezecheck.proc

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : BootCondSearch,InitCond,InheritCond

#==============================================================================



#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽQ******************************************************************

#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnClose)=================================================================

event.OnClose : $(
	SetCloseCond;
	.setstr closemode 1;
	CloseCondSearch;
	TalkSafeSearch "kp.onclose";
	)\w9\w9\-

kp.onclose (
	TalkClose.${timezone}.$(KPdate %m%d),
	TalkClose.$(KPdate %m%d),
	TalkClose.${kp.modifier},
	TalkClose.${timezone},
	TalkClose,
	TalkGeneral,
	!kp.onclosedefault
)

kp.onclosedefault : \1\s[10]\0\s[0]

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onclose, kp.onclosedefault

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾖ変更??ｿｽ?ｿｽA??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnGhostChanging/OnGhostCalling)==================

event.OnGhostChanging : $(
	SetCloseCond;
	.setstr closemode 1;
	if $[ $(Reference 0) == ${Character0} && ( ! $(Reference 2) || $(Reference 2) == ${System.SelfName} ) ] $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾍ趣ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr closemode 3;
	);
	CloseCondSearch;
	GhostChangingCommon "ghostchanging";
	.clear kp.modifier;
)

event.OnGhostCalling : $(
	GhostChangingCommon "ghostcalling";
	.clear kp.modifier;
)

=kis
# OnGhostChanging/OnGhostCalling??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ghostchanging/ghostcalling
function GhostChangingCommon $(
	if $[ $(.size @arg) != 2 ] $(return);

	if $[ ${System.Request.Reference1} == "automatic" ] $(
		.setstr kp.modifier "Auto";
	);
	.setstr nextghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr nextname $(NormReference 2);
	);
	TalkSafeSearch "kp.on"$@arg[1]$(
		if $[ ${closemode} == 3 ]
			"2"
	);
	.clear nextghost;
	.clear nextname;
);
=end

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanging.ghostname (
	TalkGhostChangingEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostChangingEx.${nextghost}.${nextname}
)
kp.onghostcalling.ghostname (
	TalkGhostCallingEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostCallingEx.${nextghost}.${nextname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanging.normal (
	TalkGhostChanging.${nextghost}.$(KPdate %m%d),
	TalkGhostChanging.__other__.$(KPdate %m%d),
	TalkGhostChanging.${nextghost}
)
kp.onghostcalling.normal (
	TalkGhostCalling.${nextghost}.$(KPdate %m%d),
	TalkGhostCalling.__other__.$(KPdate %m%d),
	TalkGhostCalling.${nextghost}
)

# ??ｿｽ?ｿｽﾄ用??ｿｽ?ｿｽI??ｿｽ?ｿｽﾈ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanging.general (
	TalkGhostChanging
)
kp.onghostcalling.general (
	TalkGhostCalling,
	TalkGeneralBegin
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ関係??ｿｽ?ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onghostchanging.timetalk (
	TalkGhostChanging.${kp.modifier}
)
kp.onghostcalling.timetalk (
	TalkGhostCalling.${kp.modifier}
)

#??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘ替趣ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ優??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾊゑｿｽﾝ抵ｿｽ
=kis
if ${kp.config.useghostchangetimefirst} $(
	.copy kp.onghostchanging.timetalk kp.onghostchanging;
	.copy kp.onghostcalling.timetalk kp.onghostcalling;
);
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostchanging.ghostname kp.onghostchanging;
	.copy kp.onghostcalling.ghostname kp.onghostcalling;
);
.copy kp.onghostchanging.normal kp.onghostchanging;
.copy kp.onghostcalling.normal kp.onghostcalling;
if $[ ! ${kp.config.useghostchangetimefirst} ] $(
	.copy kp.onghostchanging.timetalk kp.onghostchanging;
	.copy kp.onghostcalling.timetalk kp.onghostcalling;
);
# OnGhostChanging??ｿｽ?ｿｽﾌ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽAOnClose??ｿｽ?ｿｽﾌ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ托ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝゑｿｽ
# OnGhostCalling??ｿｽ?ｿｽﾍ托ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ
.copy kp.onghostchanging.general kp.onghostchanging;
.copy kp.onclose onghostchanging;
.copy kp.onghostcalling.general kp.onghostcalling;
=end

# ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# TalkRebooting??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽD??ｿｽ?ｿｽ謔ｳ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽkp.onghostchanged??ｿｽ?ｿｽﾆ具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# OnGhostCalling??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ
=kis
.setstr kp.onghostchanging2 "TalkRebooting";
.copy kp.onghostchanging kp.onghostchanging2;
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onghostchanging,	kp.onghostchanging2,kp.onghostcalling

#==============================================================================


#??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ終??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽb??ｿｽ?ｿｽN==============================================

event2.OnTranslate : $(
	.setstr @ref0 $(GetString System.Request.Reference0 0);
	# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ関係??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ帰??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if $[	$(.match ${@ref0} "\\![change,ghost,") < 0
		&&	$(.match ${@ref0} "\\-") < 0
		&&	$(.match ${@ref0} "\\![reload,shiori]") < 0
		&&	$(.match ${@ref0} "\\![reload,ghost]") < 0
	] $(return);
	.setstr @ref0len $(.length ${@ref0});
	.setstr @i 0;
	while $[ ${@i} < ${@ref0len} ] $(
		.setstr @c $(sslex_char_at ${@ref0} ${@i});
		if $(.match_at ${@c} "\\![change,ghost,") $(
			# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			if $[ $(.setstr @pos $(GetCloseParenthesis ${@c}) ; .entry @pos) > 0 ] $(
				# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊは閉ゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(=??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)
				.setstr @ghost $(.substr ${@c} 16 $[ ${@pos} - 16 ]);
				if $[ ${System.OwnerGhost} == ${@ghost} ] $(
					# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
					.setstr @exit 3;
					break;
				) else if ${(System.InstalledGhost+kp.specialghostname)&@ghost} $(
					# ??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
					.setstr @exit 1;
					break;
				);
			);
		) else if $[ ${@c} == "\\-" ] $(
			# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr @exit 1;
			break;
		) else if $[ ${@c} == "\\![reload,shiori]" || ${@c} == "\\![reload,ghost]" ] $(
			#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr @exit 3;
			break;
		);
		.inc @i $(.length ${@c});
	);
	# @exit??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if ${@exit} $(SetCloseCond ; .setstr closemode ${@exit});
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ機??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾂゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ?
kp.specialghostname : random, sequential, lastinstalled

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.specialghostname

#==============================================================================


#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ================================================================
#??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔでの終??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽﾍ切ゑｿｽﾖゑｿｽ

=kis
function CloseCondSearch $(
	.setstr kp.modifier $(ModifierSearch "kp.close.short" ${ghosttime.now});
);
=end

=kis
#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ、??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽA??ｿｽ?ｿｽC??ｿｽ?ｿｽR??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ、??ｿｽ?ｿｽf??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽg??ｿｽ?ｿｽb??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽb??ｿｽ?ｿｽg
function SetCloseCond $(
	setFreeze;
	.setstr endtime $(MinCalc);
	.setstr endday $(DayCalc);
	if $(.size time.iconize) $(
		.setstr time.iconize.before $(GetInteger time.iconize);
	);
	if $(.size time.desktop) $(
		.setstr time.desktop.before $(GetInteger time.desktop);
	);
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽd??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh??ｿｽ?ｿｽ~??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽmutex
	.setstr kp.bootmutex 0;
	# ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾌク??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA
	.setstr kp.iscrashed 0;
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾌク??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA
	.setstr kp.isfirstboot 0;
);
=end

# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊセ??ｿｽ?ｿｽ[??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ)
# SSP??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnCacheSuspend)??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
System.Callback.OnUnload , event.OnCacheSuspend : $(
	# closemode=0: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ栞??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh
	# closemode=1: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ記??ｿｽ?ｿｽ^??ｿｽ?ｿｽﾏみ、??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽﾈ外
	# closemode=2: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	# closemode=3: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ記??ｿｽ?ｿｽ^??ｿｽ?ｿｽﾏみ、??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈ外:    closemode??ｿｽ?ｿｽ??ｿｽ?ｿｽNULL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽﾙ擾ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr @closemode $(GetInteger closemode);
	if  $[ ${@closemode} == 0 ] $(
		.setstr closemode 3;
		SetCloseCond;
		Backup;
	) else if $[ ${@closemode} == 1 ] $(
		SaveData;
		ClearData;
	) else if $[ ${@closemode} == 2 ] $(
		SetCloseCond;
		Backup;
	) else if $[ ${@closemode} == 3 ] $(
		Backup;
	) else $(
		SetCloseCond;
		SaveData;
		ClearData;
	);
	LogMsg (
		$(if $[ ${System.Request.ID} =~ "Cache" ] "Suspend" else "Unload")
		" at "$(.date %s)
	) "closemode='"${@closemode}"'";
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : dataclearparam

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : CloseCondSearch,SetCloseCond

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ/??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ*******************************************************

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnOtherGhostBooted)========================================

event.OnOtherGhostBooted : $(
	.setstr bootedghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr bootedname $(NormReference 2);
	);
	SearchKeyword "kp.otherghostbootedwords" $(Reference 1);
	TalkSearch "kp.onotherghostbooted";
	.clear scriptwords;
	.clear bootedghost;
	.clear bootedname;
)

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostbooted.ghostname (
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.$(KPdate %m%d),
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.${scriptwords},
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostbooted.normal (
	TalkOtherGhostBooted.${bootedghost}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBooted.__other__.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBooted.${bootedghost}.$(KPdate %m%d),
	TalkOtherGhostBooted.${bootedghost}.${scriptwords},
	TalkOtherGhostBooted.__other__.$(KPdate %m%d),
	TalkOtherGhostBooted.__other__.${scriptwords},
	TalkOtherGhostBooted.${bootedghost}
)

# ??ｿｽ?ｿｽﾄ用??ｿｽ?ｿｽI??ｿｽ?ｿｽﾈ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostbooted.general (
	TalkOtherGhostBooted,
	TalkGeneral
)

# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.otherghostbootedwords.ghostname (
	OtherGhostBootedWords.${bootedghost}.${bootedname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌキ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.otherghostbootedwords.normal (
	OtherGhostBootedWords.${bootedghost},
	OtherGhostBootedWords.__other__
)

#??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘ替趣ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ優??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾊゑｿｽﾝ抵ｿｽ
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onotherghostbooted.ghostname kp.onotherghostbooted;
	.copy kp.otherghostbootedwords.ghostname kp.otherghostbootedwords;
);
.copy kp.onotherghostbooted.normal kp.onotherghostbooted;
.copy kp.onotherghostbooted.general kp.onotherghostbooted;
.copy kp.otherghostbootedwords.normal kp.otherghostbootedwords;
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onotherghostbooted, kp.otherghostbootedwords

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnOtherGhostClosed)========================================

event.OnOtherGhostClosed : $(
	.setstr closedghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr closedname $(NormReference 2);
	);
	SearchKeyword "kp.otherghostclosedwords" $(Reference 1);
	TalkSearch "kp.onotherghostclosed";
	.clear scriptwords;
	.clear closedghost;
	.clear closedname;
)

# ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostclosed.ghostname (
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.$(KPdate %m%d),
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.${scriptwords},
	TalkOtherGhostClosedEx.${closedghost}.${closedname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostclosed.normal (
	TalkOtherGhostClosed.${closedghost}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosed.__other__.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosed.${closedghost}.$(KPdate %m%d),
	TalkOtherGhostClosed.${closedghost}.${scriptwords},
	TalkOtherGhostClosed.__other__.$(KPdate %m%d),
	TalkOtherGhostClosed.__other__.${scriptwords},
	TalkOtherGhostClosed.${closedghost}
)

# ??ｿｽ?ｿｽﾄ用??ｿｽ?ｿｽI??ｿｽ?ｿｽﾈ切ゑｿｽﾖゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
kp.onotherghostclosed.general (
	TalkOtherGhostClosed,
	TalkGeneral
)

# ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.otherghostclosedwords.ghostname (
	OtherGhostClosedWords.${closedghost}.${closedname}
)

# ??ｿｽ?ｿｽﾊ擾ｿｽﾌキ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg
kp.otherghostclosedwords.normal (
	OtherGhostClosedWords.${closedghost},
	OtherGhostClosedWords.__other__
)

#??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽﾉ会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄ、??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘ替趣ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ優??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾊゑｿｽﾝ抵ｿｽ
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onotherghostclosed.ghostname kp.onotherghostclosed;
	.copy kp.otherghostclosedwords.ghostname kp.otherghostclosedwords;
);
.copy kp.onotherghostclosed.normal kp.onotherghostclosed;
.copy kp.onotherghostclosed.general kp.onotherghostclosed;
.copy kp.otherghostclosedwords.normal kp.otherghostclosedwords;
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onotherghostclosed, kp.otherghostclosedwords

#==============================================================================


#??ｿｽ?ｿｽ}??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽQ************************************************************

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅダ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN(OnMouseDoubleClick)==============================

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅダ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛに趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽﾂつゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ使??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ茨ｿｽﾅシ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽﾆダ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽﾌ具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで抵ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽD??ｿｽ?ｿｽ謔ｳ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnMouseDoubleClick : $(
	if $(isNotFreezing) $(
		SetMouseCond useother;
		TalkSearch "kp.onmousedoubleclick";
		ClearMouseCond;
	);
)

kp.onmousedoubleclick (
	C${characterscope}Double.${mousezone}.${surfacenum},
	C${characterscope}Double.${mousezone},
	C${characterscope}Doubleclick
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onmousedoubleclick

#==============================================================================


#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅシ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN(OnMouseClick)==================================

#??ｿｽ?ｿｽﾌ茨ｿｽw??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ??ｿｽ?ｿｽ:Bust,Face??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾍ厄ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ茨ｿｽﾅのダ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN??ｿｽ?ｿｽﾆの具ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

event.OnMouseClick : $(
	if $(isNotFreezing) $(
		if $[ $(Reference 4) == "" && ! $(Reference 5) ] $(return);
		SetMouseCond;
		TalkSearch "kp.onmousesingleclick"$(IntReference 5);
		ClearMouseCond;
	);
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN
kp.onmousesingleclick0 ( 
	C${characterscope}Single.${mousezone}.${surfacenum},
	C${characterscope}Single.${mousezone},
	C${characterscope}Singleclick
)

# ??ｿｽ?ｿｽE??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN
kp.onmousesingleclick1 ( 
	C${characterscope}SingleRight.${mousezone}.${surfacenum},
	C${characterscope}SingleRight.${mousezone},
	C${characterscope}SingleclickRight
)

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ/??ｿｽ?ｿｽz??ｿｽ?ｿｽC??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽN
kp.onmousesingleclick2 ( 
	C${characterscope}SingleMiddle.${mousezone}.${surfacenum},
	C${characterscope}SingleWheel.${mousezone}.${surfacenum},
	C${characterscope}SingleMiddle.${mousezone},
	C${characterscope}SingleWheel.${mousezone},
	C${characterscope}SingleclickMiddle,
	C${characterscope}SingleclickWheel
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onmousesingleclick0,
	kp.onmousesingleclick1,
	kp.onmousesingleclick2
)

#==============================================================================


#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅのマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾚ難ｿｽ(OnMouseMove)===============================

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾌ擾ｿｽﾅマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛに趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅや胸??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈどに使??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnMouseMove : $(
	if $(isNotFreezing) $(
		if ${System.Request.Reference4} $(
			# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ阡ｻ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ茨ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉカ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			SetMouseCond;
			# beforemousestate??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr beforemousestate $(GetString beforemousestate);
			if $[ ${characterscope}"/"${mousezone} == ${beforemousestate} ] $(
				# ??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ前??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ茨ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				SecureInc mousecount;
				# stroke.limit??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr stroke.limit $(NonNegative $(GetString stroke.limit));
				if $[ ${stroke.limit} == ${mousecount} ] $(
					# ??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ定し??ｿｽ?ｿｽ??ｿｽ?ｿｽlimit??ｿｽ?ｿｽﾉ達??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌでト??ｿｽ?ｿｽ[??ｿｽ?ｿｽN
					TalkSearch "kp.onmousemove.stroke";
					NextStrokeSearch;
				);
			) else $(
				# ??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ前??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ違う??ｿｽ?ｿｽﾌ茨ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr beforemousestate ${characterscope}"/"${mousezone};
				FirstStrokeSearch;
			);
			ClearMouseCond;
		) else $(
			# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ阡ｻ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ茨ｿｽO
			.setstr mousecount 0;
		);
	);
)

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽlimit??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽE??ｿｽ?ｿｽﾝ抵ｿｽ(NextStrokeSearch)
# mousecount??ｿｽ?ｿｽﾍ茨ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ
function NextStrokeSearch $(
	# ??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ謫ｾ
	.setstr @option $(EntryName $(EntrySearch "kp.onmousemove.option"));
	# tmp.stroke??ｿｽ?ｿｽ??ｿｽ?ｿｽres.phase??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr tmp.stroke $(GetString tmp.stroke);
	.setstr res.phase $(NonNegative $(GetString res.phase));
	# res.phase??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽV??ｿｽ?ｿｽt??ｿｽ?ｿｽg
	if $[ $(.find ${@option} "loopall") >= 0 ] $(
		# phase??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr mousecount $[ ${mousecount} % $(NonNegative $(GetString ${tmp.stroke} "-1")) ];
		.setstr res.phase $[ ( ${res.phase} + 1 ) % $(.size ${tmp.stroke}) ];
	) else $(
		# phase??ｿｽ?ｿｽﾍ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ飽??ｿｽ?ｿｽa
		if $[ $(.find ${@option} "looplast") >= 0 && ${res.phase} == $(.size ${tmp.stroke}) - 1 ] $(
			# ??ｿｽ?ｿｽﾅ鯉ｿｽ??ｿｽ?ｿｽphase??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr mousecount 0;
		);
		# phase??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ飽??ｿｽ?ｿｽa??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾂつ托ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		SecureInc res.phase 1 $[ $(.size ${tmp.stroke}) - 1 ];
	);
	.setstr stroke.limit $(NonNegative $(GetString ${tmp.stroke} ${res.phase}));
);
=end

=kis
# ??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽlimit??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽE??ｿｽ?ｿｽﾝ抵ｿｽ(FirstStrokeSearch)
function FirstStrokeSearch $(
	.setstr mousecount 0;
	.setstr res.phase 0;
	.setstr tmp.stroke $(EntryName $(EntrySearch "kp.onmousemove.limit"));
	if $[ $(.length ${tmp.stroke}) == 0 ] $(
		# limit??ｿｽ?ｿｽﾍ設定さ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、??ｿｽ?ｿｽf??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽl??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽ
		.setstr tmp.stroke "kp.onmousemove.defaultlimit";
	);
	.setstr stroke.limit $(NonNegative $(GetString ${tmp.stroke} 0));
);
=end

# limit??ｿｽ?ｿｽﾝ定が??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾌデ??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg
kp.onmousemove.defaultlimit : 1

# limit
kp.onmousemove.limit (
	C${characterscope}Stroke.limit.${mousezone}.${surfacenum},
	C${characterscope}Stroke.limit.${mousezone}
)

# ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN
kp.onmousemove.stroke (
	C${characterscope}Stroke.${res.phase}.${mousezone}.${surfacenum},
	C${characterscope}Stroke.${res.phase}.${mousezone},
	C${characterscope}Stroke.${mousezone}.${surfacenum},
	C${characterscope}Stroke.${mousezone}
)

# ??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ抵ｿｽ
kp.onmousemove.option (
	C${characterscope}Stroke.option.${mousezone}.${surfacenum},
	C${characterscope}Stroke.option.${mousezone},
	C${characterscope}Stroke.option
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onmousemove.defaultlimit,
	kp.onmousemove.limit,
	kp.onmousemove.stroke,
	kp.onmousemove.option
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : FirstStrokeSearch, NextStrokeSearch

#==============================================================================


#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽz??ｿｽ?ｿｽC??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ](OnMouseWheel)================================

event.OnMouseWheel : $(
	if $(isNotFreezing) $(
		SetMouseCond useother;
		TalkSearch "kp.onmousewheel";
		ClearMouseCond;
	);
)

kp.onmousewheel (
	C${characterscope}Wheel.${kp.wheelvalue}.${mousezone}.${surfacenum},
	C${characterscope}Wheel.${kp.wheelvalue}.${mousezone},
	C${characterscope}Wheel.Both.${mousezone}.${surfacenum},
	C${characterscope}Wheel.Both.${mousezone},
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onmousewheel

#==============================================================================


#??ｿｽ?ｿｽ}??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ関撰ｿｽ==========================================================

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉセ??ｿｽ?ｿｽb??ｿｽ?ｿｽg(SetMouseCond)
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ : ??ｿｽ?ｿｽuuseother??ｿｽ?ｿｽv??ｿｽ?ｿｽﾈゑｿｽReference4??ｿｽ?ｿｽ??ｿｽ?ｿｽNULL??ｿｽ?ｿｽﾌ趣ｿｽmousezone??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽu__other__??ｿｽ?ｿｽv??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#           ??ｿｽ?ｿｽﾈ暦ｿｽ??ｿｽ?ｿｽﾂ能??ｿｽ?ｿｽB
=kis
function SetMouseCond $(
	.setstr characterscope $(NonNegReference 3);
	.setstr surfacenum $(GetInteger SurfaceC${characterscope});
	.setstr mousezone $(EntNamReference 4);
	# useother??ｿｽ?ｿｽI??ｿｽ?ｿｽv??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ「__other__??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	if $[ $@arg[1] == "useother" && ! ${System.Request.Reference4} ] $(
		.setstr mousezone "__other__";
	);
	# Reference2??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽA??ｿｽ?ｿｽz??ｿｽ?ｿｽC??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ]??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs
	if ${System.Request.Reference2} $(
		if $[ $(IntReference 2) > 0 ] $(
			.setstr kp.wheelvalue "Plus";
		) else $(
			.setstr kp.wheelvalue "Minus";
		);
	);
);
=end

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA(ClearMouseCond)
=kis
function ClearMouseCond $(
	.clear characterscope;
	.clear surfacenum;
	.clear mousezone;
	.clear kp.wheelvalue;
);
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : SetMouseCond, ClearMouseCond

#==============================================================================


#??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ変会ｿｽ??ｿｽ?ｿｽn****************************************************************

#??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾖ連(OnWindowState...)==================================================
#freeze??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ}??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽiWinAMP??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅ費ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾂ能??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾗ）

#??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽn(OnWindowStateMinimize)---------------------------------------------

event.OnWindowStateMinimize : $(
	setFreeze;
	.setstr iconizing 1;
	.setstr minimizedtime 0;
	GetifExist kp.callback.OnWindowStateMinimize;
	silent;
)

#??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ逡懶ｿｽA(OnWindowStateRestore)------------------------------------------

event.OnWindowStateRestore : $(
	resetFreeze;
	.setstr iconizing 0;
	GetifExist kp.callback.OnWindowStateRestore;
	.setstr kp.modifier $(ModifierSearch "kp.minimizedtime" ${minimizedtime});
	TalkSafeSearch "kp.onwindowstaterestore";
	.clear kp.modifier;
)

kp.onwindowstaterestore (
	TalkRestore.${kp.modifier},
	TalkRestore,
	TalkGeneral
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onwindowstaterestore

#==============================================================================


#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnSurface...)==============================================

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽ謫ｾ(OnSurfaceChange)---------------------------------------

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛに趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA\0,\1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｼ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌサ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#SurfaceC(0/1)??ｿｽ?ｿｽﾉ格??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽB

event.OnSurfaceChange : $(
	.setstr SurfaceC0 $(IntReference 0);
	.setstr SurfaceC1 $(IntReference 1);
	# SSP??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽReference2??ｿｽ?ｿｽﾉ対会ｿｽ
	.clear @msg;
	.split @msg $(Reference 2) ",";
	if $[ $(.size @msg) > 1 ] $(
		# ??ｿｽ?ｿｽﾓ厄ｿｽ??ｿｽ?ｿｽﾌゑｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽb??ｿｽ?ｿｽZ??ｿｽ?ｿｽ[??ｿｽ?ｿｽW??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr SurfaceC$(NonNegative $@msg[0]) $(Integer $@msg[1]);
	);
)

#MATERIA??ｿｽ?ｿｽﾌ場合OnSurfaceChange??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾗ、OnTranslate??ｿｽ?ｿｽﾅ托ｿｽﾖ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#Thanx to ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(akira-k@blue.interq.or.jp) ??ｿｽ?ｿｽcoriginal code

# event2.OnTranslate??ｿｽ?ｿｽﾍ、event.OnTranslate??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ追会ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
event2.OnTranslate : $(
	if $[ ${System.Request.Sender} != "embryo" ] $(return);
	SSParser ${System.Request.Reference0};
)

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽe??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ最鯉ｿｽﾌサ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ謫ｾ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽX??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽg
# ??ｿｽ?ｿｽﾟゑｿｽl : ??ｿｽ?ｿｽﾈゑｿｽ(SurfaceC*??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉサ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[)
function SSParser $(
	if $[ $(.size @arg) != 2 ] $(return);

	# ??ｿｽ?ｿｽf??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ\0??ｿｽ?ｿｽ??ｿｽ?ｿｽ
	.setstr @side 0;
	.setstr @i 0;
	.setstr @length $(.length $@arg[1]);
	while $[ ${@i} < ${@length} ] $(
		.setstr @c $(sslex_char_at $@arg[1] ${@i});
		if $[ $(.length ${@c}) > 1 ] $(
			# ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ対象単??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ@word??ｿｽ?ｿｽ??ｿｽ?ｿｽ
			.setstr @word $(substr ${@c} 1);
			if $(.match_at ${@word} "e") $(
				# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌで会ｿｽﾍ打ゑｿｽ??ｿｽ?ｿｽﾘゑｿｽ
				break;
			) else if $[ $(.match_at ${@word} "0") || $(.match_at ${@word} "h") ] $(
				# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ迹､??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr @side 0;
			) else if $[ $(.match_at ${@word} "1") || $(.match_at ${@word} "u") ] $(
				# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゅう??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr @side 1;
			) else if $(.match_at ${@word} "p[") $(
				# \p[]??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr @side $(
					.substr ${@word}"]" 2 $[ $(GetCloseParenthesis ${@word}"]" 1) - 2 ]
				);
				# ??ｿｽ?ｿｽX??ｿｽ?ｿｽR??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽﾍ必??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.setstr @side $(NonNegative ${@side});
			) else if $(.match_at ${@word} "s[") $(
				# ??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽ謫ｾ
				.setstr SurfaceC${@side} $(
					.substr ${@word}"]" 2 $[ $(GetCloseParenthesis ${@word}"]" 1) - 2 ]
				);
				# ??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽﾍ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ費ｿｽ
				.setstr SurfaceC${@side} $(Integer ${SurfaceC${@side}});
			);
		);
		.inc @i $(.length ${@c});
	);
);
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : SSParser

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA(OnSurfaceRestore)----------------------------------------------

#??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽM??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽﾈ擾ｿｽﾔゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽﾊ擾ｿｽ@\0:??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX0 \1:??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX10??ｿｽ?ｿｽj
#??ｿｽ?ｿｽﾟゑｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ~??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽﾌ包ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾌみ、??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ??ｿｽ?ｿｽB

event.OnSurfaceRestore : $(
	.setstr kp.surfacec0 $(IntReference 0);
	.setstr kp.surfacec1 $(IntReference 1);
	# ??ｿｽ?ｿｽﾈ会ｿｽ??ｿｽ?ｿｽATalkSearch??ｿｽ?ｿｽﾌ変形
	.setstr @talkentry $(EntrySearch "kp.onsurfacerestore");
	if $[ $(.length ${@talkentry}) != 0 ] $(
		.setstr @str $(EntryRefer ${@talkentry});
		#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽf??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽﾅはク??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA
		.clear kp.internaltalkflag;
		if $[ $(.length ${@str}) != 0 ] $(
			# ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽSSTP??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾅはなゑｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾘ具ｿｽ??ｿｽ?ｿｽﾌフ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ
			.setstr kp.internaltalkflag 1;
			# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽb??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾌみ、??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽJ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽb??ｿｽ?ｿｽg
			if $(GetPlainText ${@str}) $(resetTalkcount);
			.entry @str;
		);
	);
	.clear kp.surfacec0;
	.clear kp.surfacec1;
)

kp.onsurfacerestore (
	TalkReturn.${kp.surfacec0}_${kp.surfacec1},
	TalkReturn.${kp.surfacec1},
	TalkReturn.${kp.surfacec0},
	TalkReturn
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onsurfacerestore

#==============================================================================


#??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽQ**********************************************************

#Vanish??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾖ連(OnVanish...)===================================================
#freeze??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾝ抵ｿｽ

event.OnVanishSelecting : $(
	setFreeze;
	Talk "TalkVanishSelecting";
)
event.OnVanishSelected : $(
	setFreeze;
	Talk "TalkVanishSelected";
)
event.OnVanishCancel : $(
	resetFreeze;
	Talk "TalkVanishCancel";
)
event.OnVanishButtonHold : $(
	resetFreeze;
	Talk "TalkVanishButtonHold";
)

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽVanish??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ鯉ｿｽ??ｿｽ?ｿｽ--------------------------------------------

event.OnVanished : $(
	if $[ ! ${kp.bootmutex} ] $(
		# SSP??ｿｽ?ｿｽﾅは、??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ托ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽﾄゑｿｽOnVanished??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		InitCond;
		GetifExist kp.callback.OnGhostChanged;
	);
	.setstr beforeghost $(StringNormalize $(VanishedGhostSearch));
	TalkSafeSearch "kp.onghostchanged.vanish";
	.clear beforeghost;
)

kp.onghostchanged.vanish (
	TalkOtherGhostVanished.${beforeghost},
	TalkOtherGhostVanished
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onghostchanged.vanish

=kis
# MATERIA583??ｿｽ?ｿｽﾌバ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾅ、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽVanish??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾎ搾ｿｽ
# vanish??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾅ擾ｿｽ??ｿｽ?ｿｽﾅ難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ??ｿｽ?ｿｽB
# MATERIA??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽﾅゑｿｽOnVanished??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽO??ｿｽ?ｿｽﾌ茨ｿｽReference0??ｿｽ?ｿｽ??ｿｽ?ｿｽﾔゑｿｽ
function VanishedGhostSearch $(
	if $[ ${System.Request.Sender} != "embryo" ] $(
		return ${System.Request.Reference0};
	);

	.setstr @time "2000/01/0100:00:00";
	.textload @line "..\\..\\..\\..\\log\\vanish.txt";
	foreach @i @line $(
		.clear @j;
		.split @j ${@i} $(.chr 1);
		.clear @k;
		.split @k $@j[-1] " ";
		if $[ $(.compare $@k[0]$@k[2] ${@time}) >= 0 ] $(
			.setstr @time $@k[0]$@k[2];
			.setstr @ghost $@j[0];
		);
	);
	return ${@ghost};
);
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : VanishedGhostSearch

#==============================================================================


##InputBox??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ（OnUserInput??ｿｽ?ｿｽj============================================

event.OnUserInput : $(
	Talk $(
		if $[ ${System.Request.Reference1} == "timeout" ]
			"TalkInputTimeOut."
		else
			"TalkInput."
	)$(EntNamReference 0);
)

#==============================================================================


#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽi\q??ｿｽ?ｿｽj??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnChoiceSelect)================================
#??ｿｽ?ｿｽu\q??ｿｽ?ｿｽv??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnChoiceSelect : $(
	if $(.size kp.menuformname) $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr @menuformname $(.encode_entryname ${kp.menuformname});
		.clear kp.menuformname;
		.setstr kp.menuidcounter 0;
		Talk "MenuForm."${@menuformname};
	) else if $(.size kp.MenuGroup) $(
		# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ包ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ選??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ定さ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｩ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、
		# ??ｿｽ?ｿｽ纓晢ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ移ゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr kp.MenuGroup2 $(.encode_entryname ${kp.MenuGroup});
		.clear kp.MenuGroup;
		TalkSearch "kp.onchoiceselect";
		.clear kp.MenuGroup2;
	) else $(
		Talk "Select."$(EntNamReference 0);
	);
)

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ定す??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv
# ??ｿｽ?ｿｽﾟゑｿｽl:  ??ｿｽ?ｿｽﾈゑｿｽ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl:    ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ場合??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
function setMenuGroup $(
	if $[ $(.size @arg) <= 1 ] $(
		.clear kp.MenuGroup;
	) else $(
		.setstr kp.MenuGroup $(.encode_entryname $@arg[1]);
	);
);
=end

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ骭ｾ
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽﾟゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
# ??ｿｽ?ｿｽﾟゑｿｽl:  ??ｿｽ?ｿｽﾈゑｿｽ
function MenuForm $(
	if $[ $(.size @arg) != 2 ] $(return);
	.setstr kp.menuformname $@arg[1];
	.setstr kp.menuidcounter 0;
);
=end

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ\q??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾈ易難ｿｽ??ｿｽ?ｿｽﾍ用??ｿｽ?ｿｽR??ｿｽ?ｿｽ}??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ難ｿｽ??ｿｽ?ｿｽe
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl:    ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ戻ゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ骼橸ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽn??ｿｽ?ｿｽﾔ目なゑｿｽ
#          ID??ｿｽ?ｿｽ??ｿｽ?ｿｽn-1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
function Menu.q $(
	if $[ $(.size @arg) != 2 ] $(return);
	.setstr kp.menuidcounter $(GetInteger kp.menuidcounter);
	.setstr @i ${kp.menuidcounter};
	.inc kp.menuidcounter;
	return "\\q["$@arg[1]","${@i}"]";
);
=end

=kis
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽ??ｿｽ?ｿｽ\q??ｿｽ?ｿｽ^??ｿｽ?ｿｽO??ｿｽ?ｿｽﾈ易難ｿｽ??ｿｽ?ｿｽﾍ用??ｿｽ?ｿｽR??ｿｽ?ｿｽ}??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh(ID??ｿｽ?ｿｽt)
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ難ｿｽ??ｿｽ?ｿｽe
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ2??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ: ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽID
# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl:    ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ戻ゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ骼橸ｿｽA??ｿｽ?ｿｽw??ｿｽ?ｿｽ閧ｵ??ｿｽ?ｿｽ??ｿｽ?ｿｽID??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
function Menu.q.id $(
	if $[ $(.size @arg) != 3 ] $(return);
	SecureInc kp.menuidcounter;
	return "\\q["$@arg[1]","$@arg[2]"]";
);
=end

# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽp??ｿｽ?ｿｽﾌカ??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^
kp.menuidcounter : 0

kp.onchoiceselect (
	Select.${kp.MenuGroup2}.$(EntNamReference 0),
	Select.$(EntNamReference 0)
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onchoiceselect

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : setMenuGroup

#==============================================================================


#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽE??ｿｽ?ｿｽg??ｿｽ?ｿｽiOnChoiceTimeout??ｿｽ?ｿｽj=========================================
#??ｿｽ?ｿｽu\q??ｿｽ?ｿｽv??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ闔橸ｿｽﾔ包ｿｽ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽw??ｿｽ?ｿｽb??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽZ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽﾌ選??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽu??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄび出??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾗ、freeze??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnChoiceTimeout : $(
	resetFreeze;
	if $(.size kp.menuformname) $(
		# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽE??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ包ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽj??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽH??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ定さ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｩ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、
		# ??ｿｽ?ｿｽ纓晢ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ難ｿｽ??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾚゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr kp.menuformname2 $(.encode_entryname ${kp.menuformname});
		.clear kp.menuformname;
		.setstr kp.menuidcounter 0;
		TalkSearch "kp.onchoicetimeout";
		.clear kp.menuformname2;
	) else if $(.size kp.MenuGroup) $(
		# ??ｿｽ?ｿｽ^??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽE??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ包ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ選??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾝ定さ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｩ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、
		# ??ｿｽ?ｿｽ纓晢ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ難ｿｽ??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾚゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr kp.MenuGroup2 $(.encode_entryname ${kp.MenuGroup});
		.clear kp.MenuGroup;
		TalkSearch "kp.onchoicetimeout2";
		.clear kp.MenuGroup2;
	) else $(
		Talk "TalkTimeout";
	);
)

kp.onchoicetimeout (
	MenuFormTimeout.${kp.menuformname2},
	TalkTimeout,
	TalkGeneral
)

kp.onchoicetimeout2 (
	TalkTimeout.${kp.MenuGroup2},
	TalkTimeout,
	TalkGeneral
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onchoicetimeout, kp.onchoicetimeout2

#==============================================================================


#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ\??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ/??ｿｽ?ｿｽO??ｿｽ?ｿｽ黷ｽ(OnChoiceEnter)========================
#??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽﾉマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾆ外??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽﾅゑｿｽ

event.OnChoiceEnter : $(
	if $(.size System.Request.Reference0) $(
		# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉマ??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		.setstr @choice $(EntNamReference 1);
	) else $(
		# ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ}??ｿｽ?ｿｽE??ｿｽ?ｿｽX??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ黷ｽ
		.setstr @choice "NotSelected";
	);
	if $(.size kp.MenuGroup) $(
		EntryRefer Selecting.$(.encode_entryname ${kp.MenuGroup}).${@choice};
	) else $(
		EntryRefer Selecting.${@choice};
	);
)

#==============================================================================


#??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ^??ｿｽ?ｿｽ^??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[(\_a)??ｿｽ?ｿｽﾌ選??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnAnchorSelect)===============================
# ??ｿｽ?ｿｽu\_a??ｿｽ?ｿｽv??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽL??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ^??ｿｽ?ｿｽ^??ｿｽ?ｿｽA??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽﾉ趣ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ

event.OnAnchorSelect : $(Talk "Anchor."$(EntNamReference 0))

#==============================================================================


#??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽQ**********************************************************

#??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽﾖ連(OnUpdate...)=============================================
#??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽJ??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽfreeze??ｿｽ?ｿｽt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO(1)??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄて、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ0??ｿｽ?ｿｽﾉ戻ゑｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

#??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽJ??ｿｽ?ｿｽn(OnUpdateBegin)-------------------------------------------------------

event.OnUpdateBegin : $(
	setFreeze;
	if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
		TalkSearch "kp.onupdatebegin";
	) else $(
		TalkSearch "kp.onupdatebegin.system";
	);
)

kp.onupdatebegin (
	TalkUpdateBegin,
	TalkGeneralBegin
)

kp.onupdatebegin.system (
	SystemupdateBegin.$(NormReference 3),
	SystemupdateBegin,
	TalkGeneralBegin
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onupdatebegin, kp.onupdatebegin.system

#??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnUpdateReady)---------------------------------------------------

event.OnUpdateReady : $(
	setFreeze;
	.setstr UpdateFileTotal $(AdjustOrigin $(NonNegReference 0));
	if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
		TalkSearch "kp.onupdateready";
	) else $(
		TalkSearch "kp.onupdateready.system";
	);
)

kp.onupdateready (
	TalkUpdateReady,
	TalkGeneral
)

kp.onupdateready.system (
	SystemupdateReady.$(NormReference 3),
	SystemupdateReady,
	TalkGeneral
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onupdateready, kp.onupdateready.system

#??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽe??ｿｽ?ｿｽ_??ｿｽ?ｿｽE??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽh??ｿｽ?ｿｽJ??ｿｽ?ｿｽn(OnUpdate.OnDownloadBegin)----------------------------

event.OnUpdate.OnDownloadBegin : $(
	.setstr closemode 2;
	.setstr UpdateFileNo $(AdjustOrigin $(NonNegReference 1));
	TalkSearch "kp.onupdate.ondownloadbegin";
)

kp.onupdate.ondownloadbegin (
	TalkDownloadBegin,
	TalkGeneralBegin
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.onupdate.ondownloadbegin

#MD5??ｿｽ?ｿｽﾆ搾ｿｽ??ｿｽ?ｿｽJ??ｿｽ?ｿｽn/??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ/??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs---------------------------------------------------------

event.OnUpdate.OnMD5CompareBegin: $(TalkSearch "kp.onupdate.onmd5comparebegin")

kp.onupdate.onmd5comparebegin (
	TalkMD5Begin,
	TalkGeneralBegin
)

event.OnUpdate.OnMD5CompareComplete : $(TalkSearch "kp.onpudate.onmd5comparecomplete")

kp.onpudate.onmd5comparecomplete (
	TalkMD5Complete,
	TalkGeneralComplete
)

event.OnUpdate.OnMD5CompareFailure : $(TalkSearch "kp.onupdate.onmd5comparefailure")

kp.onupdate.onmd5comparefailure (
	TalkMD5Fail,
	TalkGeneralfail
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onupdate.onmd5comparebegin,
	kp.onpudate.onmd5comparecomplete,
	kp.onupdate.onmd5comparefailure
)

#??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(OnUpdateComplete)----------------------------------------------------

event.OnUpdateComplete : $(
	resetFreeze;
	if $[ ${System.Request.Reference0} == "none" ] $(
		.setstr closemode 0;
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
			TalkSearch "kp.onupdatecomplete.none";
		) else $(
			TalkSearch "kp.onupdatecomplete1";
		);
	) else $(
		# ??ｿｽ?ｿｽl??ｿｽ?ｿｽb??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽN??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍ、??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆ難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		GetifExist kp.callback.OnUpdateComplete;
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
			TalkSearch "kp.onupdatecomplete.changed";
		) else $(
			TalkSearch "kp.onupdatecomplete2";
		);
	);
	.clear UpdateFileNo;
	.clear UpdateFileTotal;
)

kp.onupdatecomplete.none (
	TalkUpdatecomplete.none,
	TalkGeneralComplete
)

kp.onupdatecomplete1 (
	SystemupdateNoupdate.$(NormReference 3),
	SystemupdateNoupdate,
	TalkGeneralComplete
)

kp.onupdatecomplete.changed (
	TalkUpdatecomplete.changed,
	TalkGeneralComplete
)

kp.onupdatecomplete2 (
	SystemupdateCompleted.$(NormReference 3),
	SystemupdateCompleted,
	TalkGeneralComplete
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect (
	kp.onupdatecomplete.none,
	kp.onupdatecomplete1,
	kp.onupdatecomplete.changed,
	kp.onupdatecomplete2
)

#??ｿｽ?ｿｽX??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs(OnUpdateFailure)-----------------------------------------------------

event.OnUpdateFailure : $(
	resetFreeze;
	TalkSearch $(
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ]
			"kp.dataupdateerror1"
		else
			"kp.dateupdateerror2"
	);
	.clear UpdateFileNo;
	.clear UpdateFileTotal;
)

kp.dataupdateerror1 (
	TalkUpdatefail.$(NormReference 0),
	TalkUpdatefail.etc,
	TalkGeneralfail
)

kp.dataupdateerror2 (
	SystemupdateFailed.$(NormReference 3).$(NormReference 0),
	SystemupdateFailed.$(NormReference 3).etc,
	SystemupdateFailed.$(NormReference 0),
	SystemupdateFailed.etc,
	TalkGeneralfail
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.dataupdateerror1 , kp.dataupdateerror2

#==============================================================================


#==============================================================================
#??ｿｽ?ｿｽﾈ擾ｿｽGET SHIORI/3.0??ｿｽ?ｿｽC??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg
#==============================================================================


#==============================================================================
#??ｿｽ?ｿｽﾈ会ｿｽNOTIFY SHIORI/3.0
#==============================================================================

#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ謫ｾ(ownerghostname)============================================
#Reference0??ｿｽ?ｿｽﾉ「??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv
#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾘゑｿｽﾖゑｿｽ??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽﾄ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ鯉ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽx??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾚ的??ｿｽ?ｿｽﾅ取得
notify.ownerghostname : $(
	.setstr System.OwnerGhost $(SReference 0);
	if $[ ${Character0} != ${System.OwnerGhost} ] $(
		# Character0??ｿｽ?ｿｽﾆ本??ｿｽ?ｿｽﾌ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ\0??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽﾌで、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽI??ｿｽ?ｿｽﾉ茨ｿｽv??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
		LogMsg "Character0 is NOT equal to the ghost name!";
		.setstr Character0 ${System.OwnerGhost};
	);
	.get "Execute.Ownerghostname";
)

#==============================================================================


#??ｿｽ?ｿｽE??ｿｽ?ｿｽB??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh??ｿｽ?ｿｽE??ｿｽ?ｿｽn??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知(hwnd)==================================================
#Reference0??ｿｽ?ｿｽﾉ「??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ迹､??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX[??ｿｽ?ｿｽo??ｿｽ?ｿｽC??ｿｽ?ｿｽg??ｿｽ?ｿｽl1]??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゅう??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽv
#Reference1??ｿｽ?ｿｽﾉ「??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ迹､??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽo??ｿｽ?ｿｽC??ｿｽ?ｿｽg??ｿｽ?ｿｽl1]??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゅう??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽv
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ黷ｼ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽC??ｿｽ?ｿｽg??ｿｽ?ｿｽl1??ｿｽ?ｿｽﾅ包ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽSystem.Hwnd.shell??ｿｽ?ｿｽASystem.Hwnd.balloon??ｿｽ?ｿｽﾉ格??ｿｽ?ｿｽ[
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Hwnd??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.hwnd : $(
	.clear System.Hwnd.shell;
	.clear System.Hwnd.balloon;
	.split System.Hwnd.shell ${System.Request.Reference0} $(.chr 1);
	.split System.Hwnd.balloon ${System.Request.Reference1} $(.chr 1);
	.get "Execute.Hwnd";
)

#==============================================================================

#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏみゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg(installedghostname)==================================
#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽReference??ｿｽ?ｿｽﾉ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#MATERIA??ｿｽ?ｿｽﾍバ??ｿｽ?ｿｽO??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ黷ｪ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽﾈゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾟ、??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍで獲??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏみゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽSystem.InstalledGhost??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ格??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Installedghostname??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.installedghostname : $(
	.clear System.InstalledGhost;

	if $[ ${System.Request.Sender} != "embryo" ] $(
		# MATERIA??ｿｽ?ｿｽﾈ外
		.setstr @i 0;
		while $(.size System.Request.Reference${@i}) $(
			.pushstr System.InstalledGhost $(SReference ${@i});
			.inc @i;
		);
	) else $(
		# MATERIA
		GetInstalledGhost;
	);
	.get "Execute.Installedghostname";
)


# ??ｿｽ?ｿｽe??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽghost\master\descript.txt??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ謫ｾ
=kis
function GetInstalledGhost $(
	.readdir @ghostdirs $(.cncpath ../../..);
	foreach @i @ghostdirs $(
		if $(.size @text) $(.clear @text);
		.textload @text $(.cncpath ../../../${@i}/ghost/master/descript.txt);
		loop $(.size @text) $(
			.setstr @j ${-1};
			if $(.match_at $@text[${@j}] "sakura.name,") $(
				.pushstr System.InstalledGhost $(.substr $@text[${@j}] 12);
				break;
			);
		);
	);
);
=end

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : GetInstalledGhost

#==============================================================================

#??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ托ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg(otherghostname)============================================
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾌ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽReference??ｿｽ?ｿｽﾉ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#System.OtherGhost??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽASystem.OtherGhostEx??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
#??ｿｽ?ｿｽu??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽo??ｿｽ?ｿｽC??ｿｽ?ｿｽg??ｿｽ?ｿｽl1]??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ[??ｿｽ?ｿｽo??ｿｽ?ｿｽC??ｿｽ?ｿｽg??ｿｽ?ｿｽl1]??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゅう??ｿｽ?ｿｽT??ｿｽ?ｿｽ[??ｿｽ?ｿｽt??ｿｽ?ｿｽB??ｿｽ?ｿｽX??ｿｽ?ｿｽﾔ搾ｿｽ??ｿｽ?ｿｽv
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Otherghostname??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.otherghostname : $(
	#.clear System.OtherGhost;
	#.clear System.OtherGhostEx;
	.move System.OtherGhost @otherghost;
	.move System.OtherGhostEx @otherghostex;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.clear @ghost;
		.split @ghost $(SReference ${@i}) $(.chr 1);
		.pushstr System.OtherGhost $@ghost[0];
		.pushstr System.OtherGhostEx $(SReference ${@i});
		.inc @i;
	);
	.copy System.OtherGhost @newotherghost;
	.copy System.OtherGhostEx @newotherghostex;
:rem
	if $[ ! $(GetString kp.onotherghostclosedflag) ] $(
		#??ｿｽ?ｿｽV??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ起??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽA??ｿｽ?ｿｽI??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo
		.setstr @i 0;
		while $[ ${@i} < $(size @newotherghostex) ] $(
			.setstr @pos $(.find @otherghostex $(.getcode @newotherghost[${@i}]));
			if $[ ${@pos} >= 0 ] $(
				# ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾆゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ?ｿｽ???ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽO??ｿｽ?ｿｽ??ｿｽ?ｿｽ
				.clear @otherghost[${@pos}];
				.clear @otherghostex[${@pos}];
				.clear @newotherghost[${@i}];
				.clear @newotherghostex[${@i}];
			) else $(
				.inc @i;
			);
		);
		#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾍゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾜゑｿｽ#
	);
	.clear kp.onotherghostclosedflag;
:endrem
	.get "Execute.Otherghostname";
)

#==============================================================================

#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏみシ??ｿｽ?ｿｽF??ｿｽ?ｿｽ??ｿｽ?ｿｽ(installedshellname)====================================
#??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌゴ??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾉイ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽV??ｿｽ?ｿｽF??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽReference??ｿｽ?ｿｽﾉ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#System.InstalledShell??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉシ??ｿｽ?ｿｽF??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Installedshellname??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.installedshellname : $(
	.clear System.InstalledShell;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.pushstr System.InstalledShell $(SReference ${@i});
		.inc @i;
	);
	.get "Execute.Installedshellname";
)

#==============================================================================

#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾏみバ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ(installedballoonname)================================
#??ｿｽ?ｿｽC??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ撰ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽReference??ｿｽ?ｿｽﾉ通知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#System.InstalledBalloon??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉバ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Installedballoonname??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.installedballoonname : $(
	.clear System.InstalledBalloon;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.pushstr System.InstalledBalloon $(SReference ${@i});
		.inc @i;
	);
	.get "Execute.Installedballoonname";
)

#==============================================================================

#Unique ID??ｿｽ?ｿｽﾊ知(uniqueid)=======================================================
#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽﾉ偽??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽID??ｿｽ?ｿｽ??ｿｽ?ｿｽ^??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽBSSTP??ｿｽ?ｿｽﾅ難ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾛに必??ｿｽ?ｿｽv??ｿｽ?ｿｽB
#System.UniqueId??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾉ格??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.Uniqueid??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ
notify.uniqueid : $(
	.setstr System.UniqueId ${System.Request.Reference0};
	.get "Execute.Uniqueid";
)

#==============================================================================

#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知(OnNotifySelfInfo)============================================
#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽﾉ関ゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ(\0??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA\1??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽA??ｿｽ?ｿｽV??ｿｽ?ｿｽF??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ)??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.SelfInfo??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

notify.OnNotifySelfInfo : $(
	if $[ ! ${System.SelfName} ] $(.setstr System.SelfName $(SReference 0));
	if $[ ! ${Character0} ] $(.setstr Character0 $(SReference1));
	if $[ ! ${Character1} ] $(.setstr Character1 $(SReference2));
	.setstr System.Shell $(SReference 3);
	.setstr System.ShellPath $(Reference 4);
	.setstr System.Balloon $(SReference 5);
	.setstr System.BalloonPath $(Reference 6);
	.get "Execute.SelfInfo";
)

=kis
# SSP??ｿｽ?ｿｽﾈ外??ｿｽ?ｿｽ??ｿｽ?ｿｽOnNotifySelfInfo??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ驍ｽ??ｿｽ?ｿｽﾟのコ??ｿｽ?ｿｽ}??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽh
function GetDescript $(
	.textload @fin descript.txt;
	if $[ $(.size @fin) == 0 ] $(return);

	.setstr @done 0;
	loop $(.size @fin) $(
		.setstr @i ${-1};
		.setstr @str $@fin[${@i}];
		loop $(.size kp.getdescript.tosearch) $(
			.setstr @j ${-1};
			.setstr @entry $kp.getdescript.tosearch[${@j}];
			if $(.match_at ${@str} ${@entry}) $(
				.setstr $kp.getdescript.toset[${@j}] $(.substr ${@str} $(.length ${@entry}));
				.inc @done;
				break;
			);
		);
		if $[ ${@done} == $(.size kp.getdescript.tosearch) ] $(return);
	);
);
=end

kp.getdescript.tosearch (
	"name,",
	"sakura.name,",
	"kero.name,"
)

kp.getdescript.toset (
	"System.SelfName",
	"Character0",
	"Character1"
)

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象エ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.EntryToProtect : kp.getdescript.tosearch, kp.getdescript.tset

# ??ｿｽ?ｿｽﾛ鯉ｿｽﾎ象関撰ｿｽ??ｿｽ?ｿｽﾅゑｿｽ??ｿｽ?ｿｽ驍ｱ??ｿｽ?ｿｽﾆゑｿｽ骭ｾ
kp.FunctionToProtect : GetDescript

#==============================================================================

#OS??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾊ知(OnNotifyOSInfo)====================================================
#??ｿｽ?ｿｽS??ｿｽ?ｿｽ[??ｿｽ?ｿｽX??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽN??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾄゑｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽOS??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽﾊ知??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽB
#??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽi??ｿｽ?ｿｽ[??ｿｽ?ｿｽ??ｿｽ?ｿｽAExecute.OSInfo??ｿｽ?ｿｽG??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽg??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽs??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ

notify.OnNotifyOSInfo : $(
	.split @vername $(SReference 0) ",";
	.setstr System.OS.Name $@vername[0];
	.setstr System.OS.Version  $@vername[1];
	.setstr worktime.OS $[ $(IntReference 3) / 60 ];
	.setstr cntwork.OS ${worktime.OS};
	.get "Execute.OSInfo";
)

# ??ｿｽ?ｿｽV??ｿｽ?ｿｽX??ｿｽ?ｿｽe??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽﾌ擾ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽ??ｿｽ?ｿｽl
System.OS.Name    : "UNKNOWN"
System.OS.Version : "0.00"

#==============================================================================


#==============================================================================
#??ｿｽ?ｿｽﾈ擾ｿｽNOTIFY SHIORI/3.0
#==============================================================================
