#==============================================================================
#
# ??��?��u??��?��ؘa??��?��??��?��??��?��v??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��p??��?��ȈՃX??��?��N??��?��??��?��??��?��v??��?��g(Kawari Easy Event Programmed Script)
#  ??��?��??��?��{??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��
#
# ??��?��j??��?��d??��?��d??��?��o??��?��r??��?��??��?��??��?��??��?��   ??��?��F??��?��??��?��??��?��??��?��?��???��?��??��?��??��?��??��?��??��?��??��?��??��?��
# OpenKEEPS??��?��??��?��??��?��??��?��    : ??��?��n??��?��??��?��??��?��??��?��??��?��??��?��??��?��j??��?��d??��?��d??��?��o??��?��r??��?��v??��?��??��?��??��?��W??��?��F??��?��N??��?��g??��?��`??��?��[??��?��??��?��
# OpenKEEPS??��?��y??��?��[??��?��W  : http://keeps.sourceforge.jp
# Version2.0 alpha1 2002.09.25 22:30??��?��??��?��
# Version2.0 alpha2 2002.09.27 22:07??��?��??��?��
# Version2.0 alpha3 2002.09.28 20:07??��?��??��?��
# Version2.0 alpha4 2002.09.28 22:06??��?��??��?��
# Version2.0 alpha5 2002.09.30 21:45??��?��??��?��
# Version2.0 beta1  2002.10.07 00:03??��?��??��?��
# Version2.0 beta2  2002.10.12 00:30??��?��??��?��
# Version2.0 RC1    2002.10.31 23:00??��?��??��?��
# Version2.0 RC2    2002.11.10 22:00??��?��??��?��
# Version2.0 RC3    2002.11.25 00:00??��?��??��?��
# Version2.0        2002.12.01 00:00??��?��??��?��
# Version2.1.0      2003.01.03 12:00??��?��??��?��
# Version2.1.1      2003.01.26 23:00??��?��??��?��
# Version2.1.2      2003.03.03 23:00??��?��??��?��
# Version2.2        2003.04.01 00:00??��?��??��?��
# Version2.2.1      2003.04.14 22:00??��?��??��?��
# Version2.2.2      2003.05.01 18:00??��?��??��?��
# Version2.2.3      2003.05.18 00:00??��?��??��?��
# Version2.2.4      2003.06.16 23:00??��?��??��?��
# Version2.2.5      2003.07.31 00:00??��?��??��?��
# Version2.3.0 snapshot0309211444 2003.09.21 15:00??��?��??��?��
# Version3.0.0      2004.06.06 00:00??��?��??��?��
# Version3.0.1      2004.06.10 21:00??��?��??��?��
# Version3.0.2      2004.06.19 23:30??��?��??��?��
# Version3.0.3      2004.06.20 18:30??��?��??��?��
# Version3.0.4      2004.06.27 11:00??��?��??��?��
# Version3.0.5      2004.07.03 11:30??��?��??��?��
# Version3.0.6      2004.07.10 13:30??��?��??��?��
# Version3.0.7      2004.07.18 22:30??��?��??��?��
# Version3.0.8      2004.07.25 21:45??��?��??��?��
# Version3.0.9      2004.08.08 18:45??��?��??��?��
# Version3.1.0      2004.09.12 14:00??��?��??��?��
# Version3.1.1      2004.09.19 23:00??��?��??��?��
# Version3.1.2      2004.09.26 23:15??��?��??��?��
# Version3.1.3      2004.10.16 16:15??��?��??��?��
# Version3.1.4      2004.10.30 22:45??��?��??��?��
# Version3.1.5      2004.11.13 20:30??��?��??��?��
# Version3.1.6      2004.11.23 22:30??��?��??��?��
# Version3.1.9      2005.01.10 22:30??��?��??��?��
# Version3.3.0a1    2005.04.29 23:30??��?��??��?��
# Version3.3.0a2    2005.05.01 12:00??��?��??��?��
# Version3.3.0a3    2005.05.04 02:00??��?��??��?��
# Version3.3.0a4    2005.05.22 21:30??��?��??��?��
# Version3.3.0a5    2005.09.29 23:45??��?��??��?��
# Version3.3.0a6    2005.10.17 00:00??��?��??��?��
# Version3.3.0a7    2005.10.30 22:00??��?��??��?��
# Version3.3.0a8    2005.11.06 17:30??��?��??��?��
#
#==============================================================================
# ??��?��??��?��??��?��??��?��ΏہF??��?��u??��?��ؘa??��?��??��?��??��?��vPhase 8.2.2 ??��?��y??��?��я�ʌ݊�??��?��??��?��
#           ??��?��u??��?��??��?��??��?��??��?��??��?��v??��?��i??��?��??��?��??��?��u??��?��f??��?��??��?��??��?��v??��?��jMATERIA period 583 ??��?��ȏ�
#           CROW??��?��ASSP??��?��Aninix??��?��A??��?��U??��?��ь�ł̓�??��?��??��?��??��?��??��?��l??��?��??��?��
#==============================================================================


#==============================================================================
#??��?��ȉ� GET SHIORI/3.0??��?��C??��?��x??��?��??��?��??��?��g
#==============================================================================


#??��?��N??��?��??��?��??��?��??��?��(??��?��??��?��??��?��??��?��??��?��f??��?��[??��?��^??��?��Ǎ�??��?��??��?��)??��?��??��?��??��?��??��?��==================================================

System.Callback.OnLoad : $(
	# ??��?��Z??��?��[??��?��u??��?��??��?��??��?��̗L??��?��??��?��??��?��??��?��??��?��珉�??��?��N??��?��??��?��??��?��??��?��??��?��ۂ�??��?��??��?��??��?��肷??��?��??��?��
	foreach @i kp.datasaveparam $(.inc @entnum $(.size ${@i}));
	if $[ ! ${@entnum} ] $(
		# ??��?��??��?��??��?��??��?��??��?��t??��?��@??��?��C??��?��??��?��??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��??��?��Z??��?��[??��?��u??��?��f??��?��[??��?��^??��?��??��?��??��?��Ȃ�??��?��̂ŁA??��?��??��?��??��?��??��?��ŏ�??��?��??��?��N??��?��??��?��
		.setstr kp.isfirstboot 1;
	);

	# ??��?��O??��?��??��?��ɕs??��?��??��?��??��?��ȏI??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��A??��?��??��?��p??��?��g??��?��[??��?��N??��?��??��?��b??��?��??��?��
	.setstr kp.iscrashed 0;
	if $[ ($(GetInteger closemode) == 0 || $(.size closemode) == 0) && ${kp.isfirstboot} != 1 ] $(
		.setstr kp.iscrashed 1;
		LogMsg "This ghost terminated abnormally at the previous session.";
	);

	# ??��?��p??��?��??��?��??��?��??��?��??��?��[??��?��^??��?��̃f??��?��t??��?��H??��?��??��?��??��?��g??��?��l??��?��ݒ�
	.setstr cntwork $(MinCalc);
	.setstr worktime.OS 0;

	if $[ $(.size Character0) == 0 ] $(GetDescript);
	if $[ $(.size freeze) == 0 ] $(resetFreeze);
	if $[ $(.size sw.randomtalk) == 0 ] $(RandomtalkOn);
	.setstr kp.bootmutex 0;

	# ??��?��??��?��??��?��[??��?��??��?��??��?��`??��?��F??��?��b??��?��N??��?��p??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��
	.setstr BeforeMailNo 0;
	.setstr BeforeMailByte 0;

	# ??��?��??��?��??��?��[??��?��U??��?��??��?��??��?��N??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
	GetifExist kp.callback.OnLoad;
)

#==============================================================================



#(OnMinuteChange)====================================================


event.OnMinuteChange : $(
	if ${iconizing} $(
		SecureInc minimizedtime;
		SecureInc time.iconize;
		SecureInc time.iconize.total;
	) else $(
		SecureInc time.desktop;
		SecureInc time.desktop.total;
	);
	.setstr worktime.OS $(IntReference 0);
	.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});

	# Nanika Atsume specific..
	# Set a temporary entry called 'min' to the second character of the current minute in 00 format.
	.setstr @min $(char_at $(date %M) 1);
	# The same, but randomly subtract from a range of 0-4, to act as a possibility to randomly get a cat early.
	.setstr @minEarly $[$(char_at $(date %M) 1) - $(rand 5)];
	# Check if the food is out, and if it's the default 'none', and if the min is 0, and if RandomCat is empty.
	if $[${food} != "empty" && ${food} != "none" && (${@min} = '0' || ${@minEarly} = 0) && $[$(size RandomCat) > 0]] $(
		# Set the entry 'NewCat' to the first definition of 'RandomCat' using shift, which deletes the first definition of RandomCat when it returns it as well.
		setstr NewCat $(shift RandomCat); $(
			# If there are no current cats, replace CurrentCat with the newest cat.
			if $[$(find CurrentCat "none") > -1] $(setstr CurrentCat ${NewCat}; return $(TheCatReturns ${NewCat}) )
			# if there are existing cats, and the newest cat isn't already out, insert the newest cat into the Current Cat array at the first position.
			else if $[ $(find CurrentCat ${NewCat}) == -1 ] $( unshift CurrentCat ${NewCat}; return $(TheCatReturns ${NewCat}) ) 
		)
	);
	if $[ $[${@min} = '5'] && $[$(size CurrentCat ) > 0 ] && $[${CurrentCat} != "none"] ] $(
		# Find the leaving cat by grabbing the last entry of CurrentCat, setting it to LeavingCat and then and erasing it from CurrentCat
		setstr @LeavingCat $( pop CurrentCat );
		# Failsafe. If the leaving cat is erroneously "none", move onto the next cat.
		if $[ ${@LeavingCat} == "none" ] $(setstr @LeavingCat $( pop CurrentCat ));
		# Perform the cat exiting function with the value of LeavingCat.
		TheCatExits ${@LeavingCat};
		);
	if $[ $( date %H )$( date %M ) > $[ ${foodTimeOut} + 100 ] || ( ${foodTimeOut} >= 2300 && ${foodTimeOut} < 2400 && ( $(date %H)$(date %M) > $[${foodTimeOut} - 2300] ) ) || $[$(size RandomCat) = 1] ] $(
		# Set the time the food was set out to an impossible to trump number to avoid errors if the user comes back on another day after food's emptied
		setstr foodTimeOut "9999"; 
		# Set the food and appearance mode to the according empty state
		if $[${food} = "wet"] $(setstr mode "wetempty"; setstr food "empty") 
		else if $[${food} = "dry"] $(setstr mode "dryempty"; setstr food "empty") 
		else if $[${food} = "dessert"] $(setstr mode "dessertempty"; setstr food "empty")
		);
	if $(isNotFreezing) $(TalkSearch "kp.onminutechange");
)

kp.onminutechange (
	$(TimeTalk),logfile
	$(Worktime)
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onminutechange

#??��?��??��?��??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��g??��?��[??��?��N(TimeTalk)--------------------------------------------------

=kis
function TimeTalk $(
	.setstr kp.nowtime $(KPdate %s);
	.setstr @talkentry $(EntrySearch "kp.timetalk");
	if $[ $(.length ${@talkentry}) != 0 ] $(.entry @talkentry);
	.clear kp.nowtime;
);
=end

kp.timetalk (
	TalkTime.$(KPdate %Y_%m%d_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %m%d_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %w_%H%M ${kp.nowtime}),
	TalkTime.$(KPdate %H%M ${kp.nowtime})
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.timetalk

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : TimeTalk

#??��?��o??��?��ߎ�??��?��??��?��(WorkTime)------------------------------------------------------------

=kis
function Worktime $(
	if $(GetString parawork) $(
		# WorktimeB
		# ??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��v??��?��??��?��??��?��??��?��??��?��ԂŌv??��?��Z
		.setstr cntwork $(GetInteger cntwork);
		.setstr worktime $(GetInteger worktime);
		# ??��?��L??��?��^??��?��??��?��??��?��??��?��??��?��Ƃ̍�??��?��??��?��1??��?��??��?��??��?��Ԉȓ�??��?��Ȃ�A??��?��??��?��
		if $[ ( $(MinCalc) - ${cntwork} ) < 60 ] $(return);
		.inc worktime $[ ( $(MinCalc) - ${cntwork} ) / 60 ];
		.inc cntwork $[ $(MinCalc) - ${cntwork} ];
	) else $(
		# WorktimeA
		# ??��?��V??��?��X??��?��e??��?��??��?��??��?��ʒm??��?��??��?��??��?��ԂŌv??��?��Z
		.setstr @cntwork.OS $(GetInteger cntwork.OS);
		.setstr worktime ${worktime.OS};
		if $[ $(.size cntwork.OS) == 0 ] $(
			# OS??��?��N??��?��??��?��??��?��??��?��??��?��ԏ�??��?��擾??��?��Ȃ�A??��?��??��?��??��?��擾??��?��݂̂ŏI??��?��??��?��
			.setstr cntwork.OS ${worktime.OS};
			return;
		);
		.setstr cntwork.OS ${worktime.OS};
		# ??��?��L??��?��^??��?��??��?��??��?��??��?��??��?��Ƃ̍�??��?��??��?��1??��?��??��?��??��?��Ԉȓ�??��?��Ȃ�A??��?��??��?��
		if $[ ( ${worktime.OS} - ${@cntwork.OS} ) < 1 ] $(return);
	);
	# WorktimeX
	# ??��?��L??��?��^??��?��??��?��??��?��??��?��??��?��??��?��??��?��1??��?��??��?��??��?��??��?��(??��?��ȏ�)??��?��o??��?��߂�??��?��??��?��
	.setstr kp.modifier $(ModifierSearch "kp.worktime" ${worktime});
	.setstr @talkentry $(EntrySearch "kp.worktimetalk");
	# ??��?��??��?��??��?��??��?��??��?��??��?��??��?��b??��?��t??��?��??��?��??��?��O??��?��??��?��ĂĂ�??��?��??��?��??��?��??��?��??��?��A??��?��s??��?��v??��?��Ȕ�??��?��Ȃ̂ŋL??��?��q??��?��?��?��?(03\07/01)
	if $[ $(.length ${@talkentry}) != 0 ] $(.entry @talkentry);
	.clear kp.modifier;
);
=end

kp.worktimetalk (
	TalkWorktime.${kp.modifier},
	TalkWorktime,
	TalkGeneral
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.worktimetalk

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : Worktime

#OS??��?��N??��?��??��?��??��?��??��?��??��?��Ԏ擾??��?��^??��?��X??��?��N(OSworktime)----------------------------------------------

System.Callback.OnLoad : $(
	KTM.RunTask $(
		KTM.CreateTask
		"OSworktime"
		KTM.TRUE
		task.OSworktime.proc
		KTM.RANK4
	);
)

task.OSworktime.proc : $(
	# ??��?��ŏ�??��?��??��?��OnSecondChange??��?��??��?��OS??��?��N??��?��??��?��??��?��??��?��??��?��Ԃ�??��?��擾??��?��A??��?��??��?��??��?��̌�^??��?��X??��?��N??��?��??��?��~
	# ??��?��S??��?��[??��?��X??��?��g??��?��L??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��??��?��??��?��o??��?��??��?��??��?��肷??��?��??��?��?��???��?��A??��?��??��?��??��?��炩??��?��̎�??��?��ԏ�??��?��͊�??��?��Ɏ�??��?��??��?��??��?��Ă�??��?��??��?��
	# ??��?��??��?��??��?��??��?��āA??��?��??��?��??��?��̃^??��?��X??��?��N??��?��??��?��??��?��??��?��RUN??��?��??��?��??��?��??��?��K??��?��v??��?��͖�??��?��??��?��
	if $[ ! $(.size cntwork.OS) ] $(.setstr cntwork.OS ${worktime.OS});
	KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
	return;
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : task.OSworktime.proc

#==============================================================================


#??��?��b??��?��P??��?��ʏ�??��?��??��?��(OnSecondChange)====================================================

#??��?��b??��?��??��?��??��?��ς�邲??��?��Ɓi??��?��܂�P??��?��b??��?��??��?��??��?��Ɓj??��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�

#??��?��d??��?��Ȃ�(TalkKasanari)??��?��A??��?��??��?��??��?��؂�(TalkMikire)
#??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N(Talkevent)??��?��̏�??��?��??��?��??��?��Ɏg??��?��??��?��??��?��Ă�??��?��܂�

event.OnSecondChange : $(
	# OS??��?��N??��?��??��?��??��?��??��?��??��?��Ԃ�??��?��擾
	.setstr worktime.OS $(IntReference 0);
	# ??��?��??��?��??��?��ۂ̔�??��?��b??��?��R??��?��[??��?��??��?��??��?��͂�??��?��??��?��??��?��̐ӔC??��?��ōs??��?��??��?��??��?��B
	if $[ $(isNotFreezing) && $(KTM.GetMailNo AITalk) ] $(
		# ??��?��??��?��??��?��[??��?��??��?��??��?��{??��?��b??��?��N??��?��X??��?��ɉ�??��?��??��?��??��?��??��?��??��?��??��?��΁A??��?��??��?��??��?��̃G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��b??��?��??��?��??��?��??��?��
		Talk $(KTM.GetMailMessage AITalk);
		while $(KTM.GetMailNo AITalk) $(
			KTM.DeleteMail AITalk;
		);
	);
)

#??��?��֘A??��?��^??��?��X??��?��N??��?��̋N??��?��??��?��

System.Callback.OnLoad : $(
	# ??��?��??��?��??��?��??��?��Ƃ̏d??��?��??��?��??��?��??��?��??��?��
	KTM.RunTask $(
		KTM.CreateTask
		"TimeTalkCheck"
		task.timetalkcheck.cond
		task.timetalkcheck.proc
		KTM.RANK1
	);
	# ??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N
	KTM.RunTask $(
		KTM.CreateTask
		"AITalk"
		task.TalkEvent.cond
		task.TalkEvent.proc
		KTM.RANK1
		task.TalkEvent.init
	);
	# ??��?��??��?��??��?��؂�
	KTM.RunTask $(
		KTM.CreateTask
		"MikireTalk"
		task.TalkMikire.cond
		task.TalkMikire.proc
		KTM.RANK1
		task.TalkMikire.init
	);
	# ??��?��d??��?��Ȃ�
	KTM.RunTask $(
		KTM.CreateTask
		"KasanariTalk"
		task.TalkKasanari.cond
		task.TalkKasanari.proc
		KTM.RANK1
		task.TalkKasanari.init
	);
	# ??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��NMutex??��?��??��?��??��?��??��?��
	KTM.CreateMutex AITalk;
	silent;
)

#??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N(TalkEvent)---------------------------------------------------------

task.TalkEvent.init : $(
	if $[ ${interval} < 1 || $(.size interval) == 0 ] $(
		.setstr interval ${interval.default};
	);
	resetTalkcount;
	.setstr kp.cnttalkevent 0;
)

task.TalkEvent.cond : $[ $(isNotFreezing) && $(isRandomtalkOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkEvent.proc : $(
	# ??��?��g??��?��[??��?��N??��?��r??��?��??��?��??��?��ł�??��?��??��?��΁A??��?��J??��?��E??��?��??��?��??��?��g??��?��??��?��??��?��N??��?��??��?��??��?��A??��?��??��?��??��?��ċA??��?��??��?��
	if $[ ${System.Request.Status} == "talking" ] $(resetTalkcount; return);
	SecureDec cnttalk 1 0;
	.setstr @interval $(GetInteger kp.currentinterval 0);
	SecureInc kp.cnttalkevent 1 ${@interval};
	# ??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N??��?��??��?��??��?��??��?��??��?��荞�݂ŉ�??��?��??��?��??��?��??��?��??��?��ꂽ??��?��?��???��?��A??��?��??��?��??��?��荞�ݏI??��?��??��?��??��?��??��?��57??��?��b??��?��Ŏ�??��?��??��?��??��?��g??��?��[??��?��N
	if $[ ${kp.cnttalkevent} >= ${@interval} && ${cnttalk} > 57 ] $(
		.setstr cnttalk 57;
	);
	# ??��?��??��?��??��?��b??��?��^??��?��C??��?��~??��?��??��?��??��?��O??��?��łȂ�??��?��??��?��΋A??��?��??��?��
	if ${cnttalk} $(return);
	if $(KTM.LockMutex AITalk) $(
		# ??��?��??��?��??��?��b??��?��^??��?��C??��?��~??��?��??��?��??��?��O??��?��ŁAAITalk Mutex??��?��m??��?��ې�??��?��??��?��
		if $(.size talkqueue) $(
			# ??��?��??��?��U??��?��??��?��??��?��??��?��??��?��??��?��ɕϊ�
			.setstr tempsentence $(.shift talkqueue);
			.setstr @talk "!tempsentence";
		) else $(
			# ??��?��??��?��??��?��??��?��??��?��ɗ�??��?��??��?��?��???��?��A??��?��\??��?��??��?��?��??��?��͏�??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��Atempsentence??��?��͕s??��?��v
			if $(.size tempsentence) $(.clear tempsentence);
			.setstr @talk "sentence";
		);
		KTM.PostMail AITalk ${@talk};
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
		.setstr kp.cnttalkevent 0;
	);
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	task.TalkEvent.init,
	task.TalkEvent.cond,
	task.TalkEvent.proc
)

#??��?��??��?��??��?��؂�(TalkMikire)------------------------------------------------------------

task.TalkMikire.init : $(.setstr flagmikire 0 ; .setstr cntmikire 5)

task.TalkMikire.cond : $[ $(isNotFreezing) && $(isMikireOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkMikire.proc : $(
	if ${System.Request.Reference1} $(
		# mikire1
		# ??��?��??��?��??��?��؂�Ă�??��?��??��?��
		SecureDec cntmikire 1 0;
		# ??��?��܂�??��?��P??��?��\??��?��??��?��??��?��??��?��??��?��??��?��΋A??��?��??��?��
		if ${cntmikire} $(return);
		# ??��?��??��?��??��?��؂�g??��?��[??��?��N
		.setstr flagmikire 1;
		.setstr cntmikire 60;
		.setstr @talk "TalkMikire";
	) else $(
		# mikire2
		# ??��?��??��?��??��?��؂�??��?��??��?��??��?��?
		.setstr cntmikire 5;
		# ??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��؂�ĂȂ�??��?��??��?��΋A??��?��??��?��
		if $[ ! $(GetInteger flagmikire) ] $(return);
		# ??��?��??��?��??��?��؂�??��?��??��?��??��?��
		.setstr flagmikire 0;
		.setstr @talk "TalkMikirez";
	);
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk ${@talk};
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
	);
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	task.TalkMikire.init,
	task.TalkMikire.cond,
	talk.TalkMikire.proc
)

#??��?��d??��?��Ȃ�(TalkKasanari)----------------------------------------------------------

task.TalkKasanari.init : $(.setstr cntkasanari 8)

task.TalkKasanari.cond : $[ $(isNotFreezing) && $(isKasanariOn) && $(KTM.ReferMutex AITalk) < 0 ]

task.TalkKasanari.proc : $(
	if $[ ! ${System.Request.Reference2} ] $(
		# ??��?��d??��?��Ȃ�??��?��Ă�??��?��Ȃ�
		.setstr cntkasanari 8;
		return;
	);
	# ??��?��d??��?��Ȃ�??��?��Ă�??��?��??��?��?
	SecureDec cntkasanari 1 0;
	# ??��?��܂�??��?��P??��?��\??��?��??��?��??��?��??��?��??��?��??��?��΋A??��?��??��?��
	if ${cntkasanari} $(return);
	# ??��?��d??��?��Ȃ�??��?��Ă�??��?��??��?��
	.setstr cntkasanari 60;
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk "TalkKasanari";
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
	);
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	task.TalkKasanari.init,
	task.TalkKasanari.cond,
	task.TalkKasanari.proc
)

#??��?��??��?��??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��g??��?��[??��?��N??��?��??��?��??��?��݃`??��?��F??��?��b??��?��N------------------------------------------------
#??��?��??��?��??��?��??��?��OnMinuteChange??��?��Ńg??��?��[??��?��N??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��̂Ȃ�A??��?��g??��?��[??��?��N??��?��J??��?��E??��?��??��?��??��?��^??��?��??��?��??��?��N??��?��??��?��??��?��A??��?��??��?��??��?��??��?��
#??��?��g??��?��[??��?��N??��?��??��?��??��?��A??��?��??��?��??��?��??��?��??��?��邱??��?��Ƃ�??��?��??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��

# ??��?��t??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��ł͂Ȃ�??��?��A??��?��??��?��??��?��??��?��40??��?��b??��?��̎�??��?��Ƀ`??��?��F??��?��b??��?��N
task.timetalkcheck.cond : $[ $(isNotFreezing) && $(KPdate %r) == 40 ]

task.timetalkcheck.proc : $(
	.setstr kp.nowtime $[ $(KPdate %s) + 20 ];
	.setstr @talkentry $(EntrySearch "kp.timetalk");
	if $[ $(.length ${@talkentry}) != 0 ] $(resetTalkcount);
	.clear kp.nowtime;
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : task.timetalkcheck.cond, task.timetalkcheck.proc

#==============================================================================


#??��?��??��?��??��?��??��?��??��?��_??��?��??��?��??��?��g??��?��[??��?��N??��?��??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g(OnOKTalkCtrl)======================================
#??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N??��?��̏ꍇ??��?��??��?��??��?��ŁA??��?��??��?��??��?��??��?��??��?��_??��?��??��?��??��?��g??��?��[??��?��N??��?��^??��?��C??��?��}??��?��[??��?��??��?��t??��?��??��?��??��?��[??��?��Y??��?��t??��?��??��?��??��?��O??��?��??��?��\![raise]??��?��^??��?��O??��?��??��?��
#??��?��??��?��??��?��䂷??��?��??��?��ۂɎg??��?��??��?��??��?��A??��?��Ǝ�??��?��??��?��`??��?��C??��?��x??��?��??��?��??��?��g??��?��ł�??��?��BOpenKEEPS??��?��??��?��??��?��??��?��??��?��??��?��Ghost ID(kp.gid)??��?��ƁA
#Reference0??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��ɂ̂݋@??��?��\??��?��??��?��??��?��܂�??��?��B

event.OnOKTalkCtrl : $(
	if $[ $(Reference 0) != ${kp.gid} ] $(return);
	#if $[ $(.tolower ${System.Request.SecurityLevel}) != "local" ] $(return);

	.setstr @cmd $(Reference 1);
	if $[ ${@cmd} == "stop" ] $(
		RandomtalkOff;
	) else if $[ ${@cmd} == "start" ] $(
		RandomtalkOn;
	) else if $[ ${@cmd} == "freeze" ] $(
		RandomtalkOff;
		setFreeze;
	) else if $[ ${@cmd} == "reset" ] $(
		RandomtalkOn;
		resetFreeze;
	);
	silent;
)

#==============================================================================

#(OnFirstBoot)=========================================================

event.OnFirstBoot : $(
	if ${kp.isfirstboot} $(
		# ??��?��??��?��??��?��??��?��Ő^??��?��̏�??��?��??��?��N??��?��??��?��??��?��Ȃ̂Ńp??��?��??��?��??��?��??��?��??��?��[??��?��^??��?��??��?��??��?��??��?��??��?��??��?��
		FirstInitCond;
		.setstr kp.isfirstboot 0;
	);
	InitCond;
	# ??��?��??��?��??��?��܂łɏ�??��?��??��?��??��?��ꂽ??��?��??��?��??��?��Ƃ�??��?��??��?��??��?��邩??��?��??��?��??��?��??��?��
	if $(NonNegReference 0) $(
		.setstr kp.modifier "Vanished";
		.setstr count.delete $(NonNegReference 0);
	);
	# ??��?��??��?��??��?��??��?��A
	GetifExist kp.callback.OnFirstBoot;
	TalkSafeSearch "kp.onfirstboot";
	.clear kp.modifier;
)

=kis
function FirstInitCond $(
	.setstr SnowballName ${WhitecatNames};
	.setstr ToonyName ${GreywhitecatNames};
	.setstr FirestarName ${OrangecatNames};
	.setstr RomeoName ${BlackcatNames};
	.setstr GrayName ${GreycatNames};
	.setstr GreystripeName ${GreystripecatNames};
	.setstr RandomCat "none";
	.setstr CurrentCat "none";
	.setstr CurrentCat2 "none";
	.setstr food "empty";
	.setstr mode "dryempty";
	.setstr count.boot 0;
	.setstr count.delete 0;
	.setstr time.desktop.total 0;
	.setstr time.iconize.total 0;
	if $[ $(.size user) == 0 ] $(.setstr username ${username.default});
);
=end

kp.onfirstboot (
	TalkFirstboot.${count.delete}.${timezone},
	TalkFirstboot.${count.delete},
	TalkFirstboot.${kp.modifier}.${timezone},
	TalkFirstboot.${kp.modifier},
	TalkFirstboot.${timezone},
	TalkFirstboot,
	TalkGeneral
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onfirstboot

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : FirstInitCond

#==============================================================================


#??��?��ʏ�N??��?��??��?��(OnBoot)==============================================================

event.OnBoot : $(
	if $[ ! ${kp.bootmutex} ] $(
		# OnGhostCalled??��?��Ŕ�??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��??��?��OnBoot??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��A??��?��??��?��??��?��ɋN??��?��??��?��??��?��??��?��??��?��??��?��??��?��ς�
		InitCond;
		GetifExist kp.callback.OnBoot;
	);
	BootCondSearch;
	TalkSafeSearch "kp.onboot"$(if $(isCrashed) "2");
	.clear kp.modifier;
)

kp.onboot (
	TalkBootup.${timezone}.$(KPdate %m%d),
	TalkBootup.$(KPdate %m%d),
	TalkBootup.${kp.modifier},
	TalkBootup.${timezone},
	TalkBootup,
	TalkGeneral
)

# ??��?��N??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��??��?��̋N??��?��??��?��
# TalkCrashed??��?��ȊO??��?��??��?��kp.onboot??��?��Ƌ�??��?��??��?��
=kis
.setstr kp.onboot2 "TalkCrashed";
.copy kp.onboot kp.onboot2;
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onboot,kp.onboot2

#==============================================================================


#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��̕ύX(OnGhostChanged/OnGhostCalled)==========================

event.OnGhostChanged : $(
	# ??��?��ċN??��?��??��?��??��?��??��?��??��?��ۂ�??��?��??��?��?��o??��?��??��?��??��?��??��?��̂́AInitCond??��?��̑O??��?��??��?��??��?��??��?��(closemode??��?��??��?��??��?��ς�邩??��?��??��?��)
	.setstr @isRebooted $(isRebooted);
	if ${@isRebooted} $(
		# ??��?��ċN??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��(??��?��O??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��)
		resetFreeze;
		InheritCond;
		.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});
	) else $(
		# ??��?��ʏ�̐ؑ֋N??��?��??��?��
		InitCond;
	);
	BootCondSearch;
	GhostChangedCommon "ghostchanged" ${@isRebooted};
	.clear kp.modifier;
)

event.OnGhostCalled : $(
	#??��?��S??��?��[??��?��X??��?��g??��?��Ăяo??��?��??��?��??��?��̏ꍇ??��?��A??��?��ċN??��?��??��?��??��?��͗L??��?��蓾??��?��Ȃ�
	InitCond;
	BootCondSearch;
	GhostChangedCommon "ghostcalled" 0;
	.clear kp.modifier;
)

=kis
# OnGhostChanged/OnGhostCalled??��?��??��?��??��?��ʏ�??��?��??��?��
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ghostchanged/ghostcalled
# ??��?��??��?��2??��?��??��?��??��?��??��?��: ??��?��ċN??��?��??��?��??��?��Ȃ�^??��?��A??��?��Ⴄ??��?��Ȃ�U
function GhostChangedCommon $(
	if $[ $(.size @arg) != 3 ] $(return);

	.setstr beforeghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr beforename $(NormReference 2);
	);
	SearchKeyword "kp."$@arg[1]"words" $(Reference 1);
	GetifExist kp.callback.OnGhostChanged;
	TalkSafeSearch "kp.on"$@arg[1]$(
		if $(isCrashed)
			"2"
		else if $@arg[2]
			"3"
	);
	.clear scriptwords;
	.clear beforeghost;
	.clear beforename;
);
=end

# ??��?��S??��?��[??��?��X??��?��g??��?��؂�ւ�??��?��n??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?�� ??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��
# ??��?��??��?��2??��?��??��?��??��?��??��?��: ??��?��`??��?��??��?��??��?��??��?��ꂽ??��?��??��?��??��?��b??��?��Z??��?��[??��?��W
# ??��?��??��?��??��?��l:    ***ghost,***name??��?��͎�??��?��O??��?��ɃZ??��?��b??��?��g??��?��̂�??��?��??��?��
#          ??��?��Y??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��΁Ascriptwords??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��ɃL??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��Z??��?��b??��?��g??��?��??��?��??��?��??��?��
=kis
function SearchKeyword $(
	if $[ $(.size @arg) != 3 ] $(return);

	# ??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��??��?��
	.setstr @ghostwords $(EntrySearch $@arg[1]);
	if $[ $(.length ${@ghostwords}) != 0 ] $(
		# script1
		# ??��?��??��?��??��?��O??��?��̃S??��?��[??��?��X??��?��g??��?��ւ̃R??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��݂�??��?��??��?��
		.setstr @ghostscript $(StringUserNormalize $@arg[2]);
		# script2
		loop $(EntrySize ${@ghostwords}) $(
			.setstr @i ${-1};
			.setstr scriptwords $(EntryRefer ${@ghostwords} ${@i});
			if $[ ${@ghostscript} =~ ${scriptwords} ] $(break);
			.clear scriptwords;
		);
	);
);
=end

# ??��?��S??��?��[??��?��X??��?��g??��?��̃t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanged.ghostname (
	TalkGhostChangedEx.${beforeghost}.${beforename}.$(KPdate %m%d).${scriptwords},
	TalkGhostChangedEx.${beforeghost}.${beforename}.$(KPdate %m%d),
	TalkGhostChangedEx.${beforeghost}.${beforename}.${scriptwords},
	TalkGhostChangedEx.${beforeghost}.${beforename}
)
kp.onghostcalled.ghostname (
	TalkGhostCalledEx.${beforeghost}.${beforename}.$(KPdate %m%d).${scriptwords},
	TalkGhostCalledEx.${beforeghost}.${beforename}.$(KPdate %m%d),
	TalkGhostCalledEx.${beforeghost}.${beforename}.${scriptwords},
	TalkGhostCalledEx.${beforeghost}.${beforename}
)

# ??��?��ʏ�̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanged.normal (
	TalkGhostChanged.${beforeghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostChanged.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostChanged.${beforeghost}.$(KPdate %m%d),
	TalkGhostChanged.${beforeghost}.${scriptwords},
	TalkGhostChanged.__other__.$(KPdate %m%d),
	TalkGhostChanged.__other__.${scriptwords},
	TalkGhostChanged.${beforeghost}
)
kp.onghostcalled.normal (
	TalkGhostCalled.${beforeghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostCalled.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostCalled.${beforeghost}.$(KPdate %m%d),
	TalkGhostCalled.${beforeghost}.${scriptwords},
	TalkGhostCalled.__other__.$(KPdate %m%d),
	TalkGhostCalled.__other__.${scriptwords},
	TalkGhostCalled.${beforeghost}
)

# ??��?��ėp??��?��I??��?��Ȑ؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanged.general (
	TalkGhostChanged
)
kp.onghostcalled.general (
	TalkGhostCalled
)

# ??��?��??��?��??��?��Ԋ֌W??��?��̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanged.timetalk (
	TalkGhostChanged.${kp.modifier}
)
kp.onghostcalled.timetalk (
	TalkGhostCalled.${kp.modifier}
)

# ??��?��t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.ghostchangedwords.ghostname (
	GhostChangedWords.${beforeghost}.${beforename}
)
kp.ghostcalledwords.ghostname (
	GhostCalledWords.${beforeghost}.${beforename}
)

# ??��?��ʏ�̃L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.ghostchangedwords.normal (
	GhostChangedWords.${beforeghost},
	GhostChangedWords.__other__
)
kp.ghostcalledwords.normal (
	GhostCalledWords.${beforeghost},
	GhostCalledWords.__other__
)

#??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�ɉ�??��?��??��?��??��?��āA??��?��S??��?��[??��?��X??��?��g??��?��ؑ֎�??��?��g??��?��[??��?��N??��?��̗D??��?��?��???��?��ʂ�ݒ�
=kis
if ${kp.config.useghostchangetimefirst} $(
	.copy kp.onghostchanged.timetalk kp.onghostchanged;
	.copy kp.onghostcalled.timetalk kp.onghostcalled;
);
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostchanged.ghostname kp.onghostchanged;
	.copy kp.ghostchangedwords.ghostname kp.ghostchangedwords;
	.copy kp.onghostcalled.ghostname kp.onghostcalled;
	.copy kp.ghostcalledwords.ghostname kp.ghostcalledwords;
);
.copy kp.onghostchanged.normal kp.onghostchanged;
.copy kp.onghostcalled.normal kp.onghostcalled;
if $[ ! ${kp.config.useghostchangetimefirst} ] $(
	.copy kp.onghostchanged.timetalk kp.onghostchanged;
	.copy kp.onghostcalled.timetalk kp.onghostcalled;
);
# changed/called??��?��n??��?��??��?��??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��??��?��??��?��??��?��??��?��?��???��?��AOnBoot??��?��??��?��??��?��??��?��??��?��ɂ�??��?��??��?��p??��?��??��?��??��?��??��?��??��?��݂�
.copy kp.onghostchanged.general kp.onghostchanged;
.copy kp.onboot kp.onghostchanged;
.copy kp.ghostchangedwords.normal kp.ghostchangedwords;
.copy kp.onghostcalled.general kp.onghostcalled;
.copy kp.onboot kp.onghostcalled;
.copy kp.ghostcalledwords.normal kp.ghostcalledwords;
=end

# ??��?��N??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��??��?��
# TalkCrashed??��?��ȊO??��?��??��?��kp.onghostchanged??��?��Ƌ�??��?��??��?��
=kis
.setstr kp.onghostchanged2 "TalkCrashed";
.copy kp.onghostchanged kp.onghostchanged2;
.setstr kp.onghostcalled2 "TalkCrashed";
.copy kp.onghostcalled kp.onghostcalled2;
=end

# ??��?��ċN??��?��??��?��??��?��??��?��
# TalkRebooted??��?��??��?��??��?��D??��?��悳??��?��??��?��??��?��ȊO??��?��??��?��kp.onghostchanged??��?��Ƌ�??��?��??��?��
=kis
.setstr kp.onghostchanged3 "TalkRebooted";
.copy kp.onghostchanged kp.onghostchanged3;
# OnGhostCalled??��?��͍ċN??��?��??��?��??��?��ŗ�??��?��鎖�??��?��??��?��L??��?��蓾??��?��Ȃ�??��?��̂ŁA??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��̕K??��?��v??��?��Ȃ�
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onghostchanged,
	kp.onghostchanged2,
	kp.onghostchanged3,
	ghostchangedwords,
	kp.onghostcalled,
	kp.onghostcalled2,
	ghostcalledwords
)

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : GhostChangedCommon, SearchKeyword

#==============================================================================


#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��Ăяo??��?��??��?��??��?��??��?��??��?��??��?��(OnGhostCallComplete)=================================

event.OnGhostCallComplete : $(
	.setstr nextghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr nextname $(NormReference 2);
	);
	SearchKeyword "kp.ghostcallcompletewords" $(Reference 1);
	if $[ ${System.Request.Status} == "talking" ] $(
		# ??��?��??��?��??��?��??��?��??��?��OnGhostCalling??��?��??��?��??��?��I??��?��??��?��??��?��??��?��ĂȂ�
		.setstr @talkentry $(EntrySearch "kp.onghostcallcomplete");
		if $[ $(.length ${@talkentry}) != 0 ] $(
			Sys.SaveHeader ${kp.onghostcallcompleteheader};
			KTM.PostMail OnGhostCallComplete ${@talkentry};
			KTM.RunTask ${kp.onghostcallcompletetask};
			return;
		);
	) else $(
		# ??��?��g??��?��[??��?��N??��?��??��?��??��?��ł͂Ȃ�??��?��̂ŕ�??��?��ʂɉ�??��?��??��?��
		TalkSearch "kp.onghostcallcomplete";
	);
	.clear scriptwords;
	.clear nextghost;
	.clear nextname;
)

# ??��?��\??��?��??��?��??��?��??��?��??��?��I??��?��??��?��??��?��??��?��??��?��??��?��̂�??��?��??��?��??��?��v??��?��??��?��??��?��??��?��ĉ�??��?��??��?��??��?��g??��?��[??��?��N??��?��??��?��??��?��??��?��??��?��??��?��??��?��^??��?��X??��?��N
task.GhostCallComplete.init : $(.setstr $(KTM.Local counter) 5)

task.GhostCallComplete.cond : $[ ${System.Request.Status} != "talking" ]

task.GhostCallComplete.proc : $(
	# ??��?��g??��?��[??��?��N??��?��t??��?��??��?��??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��ɂȂ�??��?��??��?��5??��?��b??��?��??��?��܂ő҂�
	SecureDec $(KTM.Local counter) 1 0;
	if ${$(KTM.Local counter)} $(return);

	# ??��?��g??��?��[??��?��N??��?��??��?��??��?��??��?��??��?��\
	if $(KTM.LockMutex AITalk) $(
		KTM.PostMail AITalk "!task.GhostCallComplete.procsub";
		# 5??��?��b??��?��ҋ@??��?��J??��?��E??��?��??��?��??��?��^??��?��??��?��??��?��
		.setstr $(KTM.Local counter) 5;
		KTM.PostMail SYSTEM M_RLS_MTX AITalk;
		KTM.PostMail SYSTEM M_STOP ${kp.onghostcallcompletetask};
	);
)

# ??��?��??��?��??��?��ۂɃg??��?��[??��?��N??��?��??��?��??��?��??��?��T??��?��u??��?��v??��?��??��?��??��?��V??��?��[??��?��W??��?��??��?��
task.GhostCallComplete.procsub : $(
	# ??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��͍Ō�̂�??��?��̂�??��?��??��?��??��?��??��?��??��?��L??��?��??��?��??��?��Ȃ̂ŁA??��?��??��?��??��?��??��?��ȊO??��?��??��?��ǂݔ�΂�
	while $(KTM.GetMailNo OnGhostCallComplete) $(
		.setstr @talk $(KTM.GetMailMessage OnGhostCallComplete);
		KTM.DeleteMail OnGhostCallComplete;
	);
	# ??��?��w??��?��b??��?��_??��?��??��?��OnGhostCallComplete??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��̏�Ԃɕ�??��?��??��?��??��?��??��?��??��?��A??��?��??��?��??��?��b??��?��??��?��??��?��??��?��
	Sys.LoadHeader ${kp.onghostcallcompleteheader};
	EntryRefer ${@talk};
	Sys.RewindHeader;
	.clear scriptwords;
	.clear nextghost;
	.clear nextname;
)

# ??��?��^??��?��X??��?��N??��?��̐�??��?��??��?��??��?��ƃw??��?��b??��?��_??��?��X??��?��^??��?��b??��?��N??��?��??��?��??��?��??��?��
=kis
.setstr kp.onghostcallcompletetask $(
	KTM.CreateTask
	"DelayedOnGhostCallComplete"
	task.GhostCallComplete.cond
	task.GhostCallComplete.proc
	KTM.RANK0
	task.GhostCallComplete.init
);
.setstr kp.onghostcallcompleteheader $(Sys.CreateHeaderHandle);
=end

# ??��?��S??��?��[??��?��X??��?��g??��?��̃t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostcallcomplete.ghostname (
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.$(KPdate %m%d).${scriptwords},
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostCallCompleteEx.${nextghost}.${nextname}.${scriptwords},
	TalkGhostCallCompleteEx.${nextghost}.${nextname}
)

# ??��?��ʏ�̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostcallcomplete.normal (
	TalkGhostCallComplete.${nextghost}.$(KPdate %m%d).${scriptwords},
	TalkGhostCallComplete.__other__.$(KPdate %m%d).${scriptwords},
	TalkGhostCallComplete.${nextghost}.$(KPdate %m%d),
	TalkGhostCallComplete.${nextghost}.${scriptwords},
	TalkGhostCallComplete.__other__.$(KPdate %m%d),
	TalkGhostCallComplete.__other__.${scriptwords},
	TalkGhostCallComplete.${nextghost}
)

# ??��?��ėp??��?��I??��?��Ȑ؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostcallcomplete.general (
	TalkGhostCallComplete,
	TalkGeneralComplete
)

# ??��?��t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.ghostcallcompletewords.ghostname (
	GhostCallCompleteWords.${nextghost}.${nextname}
)

# ??��?��ʏ�̃L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.ghostcallcompletewords.normal (
	GhostCallCompleteWords.${nextghost},
	GhostCallCompleteWords.__other__
)

#??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�ɉ�??��?��??��?��??��?��āA??��?��S??��?��[??��?��X??��?��g??��?��ؑ֎�??��?��g??��?��[??��?��N??��?��̗D??��?��?��???��?��ʂ�ݒ�
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostcallcomplete.ghostname kp.onghostcallcomplete;
	.copy kp.ghostcallcompletewords.ghostname kp.ghostcallcompletewords;
);
.copy kp.onghostcallcomplete.normal kp.onghostcallcomplete;
.copy kp.onghostcallcomplete.general kp.onghostcallcomplete;
.copy kp.ghostcallcompletewords.normal kp.ghostcallcompletewords;
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onghostcallcomplete,
	kp.ghostcallcompletewords,
	task.GhostCallComplete.init,
	task.GhostCallComplete.cond,
	task.GhostCallComplete.proc,
	task.GhostCallComplete.procsub,
	kp.onghostcallcompletetask,
	kp.onghostcallcompleteheader
)

#==============================================================================


#??��?��ʏ�N??��?��??��?��??��?��A??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��N??��?��??��?��??��?��??��?��??��?��??��?��================================================
#??��?��Z??��?��??��?��??��?��ԂōČĂяo??��?��??��?��??��?��??��?��??��?��ꂽ??��?��Ƃ�??��?��A??��?��??��?��??��?��邢??��?��͋v??��?��??��?��??��?��Ԃ�ɋN??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��̏�??��?��??��?��

# ??��?��N??��?��??��?��??��?��??��?��??��?��??��?��??��?��ۂ̊e??��?��??��?��??��?��??��?��??��?��??��?��??��?��ׂ�
=kis
function BootCondSearch $(
	.setstr kp.modifier $(ModifierSearch "kp.boot.short" $[ $(MinCalc) - ${endtime} ]);
	if $[ ${kp.modifier} == "nothing" ] $(
		.setstr kp.modifier $(ModifierSearch "kp.boot.long" $[ $(DayCalc) - ${endday} ]);
	);
);
=end

# ??��?��N??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��(!=??��?��??��?��??��?��[??��?��h??��?��??��?��)??��?��̃^??��?��C??��?��}??��?��E??��?��J??��?��E??��?��??��?��??��?��^??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��
=kis
function InitCond $(
	resetFreeze;
	KTM.PostMail "FreezeCheck" "M_MSG" ${System.Request.ID};
	# ??��?��x??��?��[??��?��X??��?��E??��?��F??��?��A??��?��??��?��??��?��i??��?��[
	.setstr kp.BaseWare $(KillDangerousTag ${System.Request.Sender});
	# ??��?��??��?��??��?��d??��?��N??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��h??��?��~??��?��p??��?��??��?��mutex??��?��`??��?��F??��?��b??��?��N
	if $(GetString kp.bootmutex) $(return);
	.setstr kp.bootmutex 1;
	.inc count.boot;
	.setstr time.desktop 0;
	.setstr time.iconize 0;
	.setstr minimizedtime 0;
	.setstr worktime 0;
	.setstr closemode 0;
	.setstr mousecount 0;
	.setstr res.phase 0;
	if $[!${mode}] $(setstr mode "none");
	if $[!${food}] $(setstr food "none");
	if $[!${mode}] $(setstr foodTimeOut "9999");
	if $[!${SnowballName}] $(setstr SnowballName ${WhitecatNames});
	if $[!${ToonyName}] $(setstr ToonyName ${GreywhitecatNames});
	if $[!${FirestarName}] $(setstr FirestarName ${OrangecatNames});
	if $[!${RomeoName}] $(setstr RomeoName ${BlackcatNames});
	if $[!${GrayName}] $(setstr GrayName ${GreycatNames});
	if $[!${GreystripeName}] $(setstr GreystripeName ${GreystripecatNames});
	if $[!${RandomCat}] $(setstr RandomCat "none");
	if $[!${CurrentCat}] $(setstr CurrentCat "none");
	if $[!${CatRate}] $(setstr CatRate "0");
	if $[!${ExitRate}] $(setstr ExitRate "5");
	if $[!${SilverFish}] $(setstr CurrentCat "0");
	SaveData;
);
=end

# OnGhostChanged??��?��ōċN??��?��??��?��??��?��??��?��??��?��ǂ�??��?��??��?��??��?��??��?��??��?��肷??��?��??��?��(??��?��ċN??��?��??��?��??��?��Ȃ�1)
=kis
function isRebooted $(
	if $[ $(Reference 0) == ${Character0} && ${closemode} == 3 ] $(
		if $[ $(Reference 2) == ${System.SelfName} ] $(
			return 1;
		) else if $[ $(Reference 2) == "" && $(MinCalc) - ${endtime} <= 3 ] $(
			return 1;
		);
	);
	return 0;
);
=end


# SSP??��?��̃S??��?��[??��?��X??��?��g??��?��L??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��??��?��??��?��??��?��o??��?��??��?��??��?��?��???��?��A??��?��ǂݍ�??��?��ݎ�??��?��R??��?��[??��?��??��?��??��?��o??��?��b??��?��N??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��Ăяo??��?��??��?��
event.OnCacheRestore : $(
	GetifExist kp.callback.OnLoad;
	# ??��?��t??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��??��?��??��?��ςȂ�??��?��??��?��??��?��??��?��^??��?��X??��?��N??��?��??��?��??��?��N??��?��??��?��
	split @tasklist $(KTM.Tasklist) "|";
	foreach @task @tasklist $(
		if $(.match_at ${@task} "FreezeCheck/") $(
			KTM.RunTask $(.substr ${@task} 12);
			return;
		);
	);
)

# ??��?��N??��?��??��?��??��?��??��?��A??��?��??��?��??��?��??��?��??��?��ƃt??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��??��?��??��?��ςȂ�??��?��ɂȂ邱??��?��Ƃ�??��?��??��?��??��?��??��?��??��?��??��?��??��?��^??��?��X??��?��N

task.freezecheck.init : $(
	if $[ $(GetInteger closemode) == 3 ] $(
		# ??��?��x??��?��??��?��??��?��??��?��??��?��[??��?��h??��?��??��?��Ȃ̂�??��?��??��?��??��?��炩??��?��Ȃ̂ŁA??��?��??��?��??��?��??��?��??��?��Ƀt??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
		.setstr $(KTM.Local counter) 58;
	) else if $[ $(GetInteger closemode) == 2 ] $(
		# ??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��??��?��??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��ōċN??��?��??��?��??��?��??��?��??��?��??��?��
		InheritCond;
		.dec count.boot 1 0;
	) else $(
		.setstr $(KTM.Local counter) 0;
	);
)

task.freezecheck.proc : $(
	if $[ $(isNotFreezing) || $(KTM.GetMailNo FreezeCheck) ] $(
		# ??��?��??��?��??��?��[??��?��??��?��??��?��{??��?��b??��?��N??��?��X??��?��ɒʒm??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��A??��?��??��?��??��?��e??��?��??��?��?��?��?��??��?��u??��?��t??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��ĂȂ�??��?��v??��?��ƌ�??��?��??��?��
		KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
		# ??��?��ēx??��?��^??��?��X??��?��N??��?��??��?��??��?��N??��?��??��?��??��?��??��?��??��?��??��?��̂̓L??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��??��?��??��?��??��?��o??��?��??��?��??��?��??��?��??��?��Ɛ�??��?��??��?��ł�??��?��??��?��
		# ??��?��??��?��??��?��??��?��ɔ�??��?��??��?��??��?��A??��?��^??��?��X??��?��N??��?��??��?��Ԃ�??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
		.setstr $(KTM.Local counter) 0;
		while $(KTM.GetMailNo FreezeCheck) $(KTM.DeleteMail FreezeCheck);
		return;
	);
	.inc $(KTM.Local counter);
	if $[ ${$(KTM.Local counter)} == 60 ] $(
		# ??��?��N??��?��??��?��??��?��??��?��??��?��??��?��60??��?��b??��?��ԃt??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��??��?��??��?��ςȂ�??��?��A??��?��??��?��??��?��?��???��?��??��?��??��?��??��?��[??��?��h??��?��ゾ??��?��??��?��??��?��??��?��
		# ??��?��t??��?��??��?��??��?��[??��?��Y??��?��??��?��??��?��??��?��??��?��ƋN??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��s??��?��??��?��
		resetFreeze;
		InheritCond;
		return;
	);
)

# ??��?��^??��?��X??��?��N??��?��̋N??��?��??��?��
System.Callback.OnLoad : $(
	# ??��?��t??��?��??��?��??��?��[??��?��Y??��?��Ď�??��?��^??��?��X??��?��N??��?��??��?��??��?��N??��?��??��?��
	KTM.RunTask $(
		KTM.CreateTask
		"FreezeCheck"
		KTM.TRUE
		task.freezecheck.proc
		KTM.RANK4
		task.freezecheck.init
	)
)

# ??��?��^??��?��C??��?��}??��?��E??��?��J??��?��E??��?��??��?��??��?��^??��?��??��?��??��?��̌p??��?��??��?��
# InitCond??��?��??��?��菭??��?��??��?��??��?��ア??��?��B??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��??��?��??��?��̍ċN??��?��??��?��??��?��p??��?��B
=kis
function InheritCond $(
	KTM.PostMail "SYSTEM" "M_STOP" ${KTM.tid};
	# ??��?��??��?��??��?��d??��?��N??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��h??��?��~??��?��p??��?��??��?��mutex??��?��`??��?��F??��?��b??��?��N
	if $(GetString kp.bootmutex) $(return);
	.setstr kp.bootmutex 1;
	SecureInc count.boot;
	# ??��?��??��?��??��?��̃P??��?��[??��?��X??��?��ɂȂ�̂�???��?��??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��Ɛ�??��?��??��?��ł�??��?��??��?��̂ŁA??��?��??��?��??��?��Ԃ�??��?��p??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
	SecureInc time.iconize $(GetInteger time.iconize.before);
	SecureInc time.desktop $(GetInteger time.desktop.before);
	.setstr minimizedtime 0;
	if $(GetString parawork) $(
		.setstr worktime $[ ( ${time.desktop} + ${time.iconize} ) / 60 ];
		SecureDec cntwork $[ ( ${time.desktop} + ${time.iconize} ) % 60 ];
	 ) else $(
		.setstr worktime 0;
	);
	.setstr closemode 0;
	.setstr mousecount 0;
	.setstr res.phase 0;
	SaveData;
);
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : task.freezecheck.init, task.freezecheck.proc

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : BootCondSearch,InitCond,InheritCond

#==============================================================================



#??��?��I??��?��??��?��??��?��n??��?��??��?��??��?��??��?��??��?��Q******************************************************************

#??��?��I??��?��??��?��(OnClose)=================================================================

event.OnClose : $(
	SetCloseCond;
	.setstr closemode 1;
	CloseCondSearch;
	TalkSafeSearch "kp.onclose";
	)\w9\w9\-

kp.onclose (
	TalkClose.${timezone}.$(KPdate %m%d),
	TalkClose.$(KPdate %m%d),
	TalkClose.${kp.modifier},
	TalkClose.${timezone},
	TalkClose,
	TalkGeneral,
	!kp.onclosedefault
)

kp.onclosedefault : \1\s[10]\0\s[0]

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onclose, kp.onclosedefault

#==============================================================================


#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��֕ύX??��?��A??��?��Ăяo??��?��??��?��(OnGhostChanging/OnGhostCalling)==================

event.OnGhostChanging : $(
	SetCloseCond;
	.setstr closemode 1;
	if $[ $(Reference 0) == ${Character0} && ( ! $(Reference 2) || $(Reference 2) == ${System.SelfName} ) ] $(
		# ??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��͎�??��?��??��?��??��?��Ɛ�??��?��??��?��??��?��o??��?��??��?��??��?��??��?��
		.setstr closemode 3;
	);
	CloseCondSearch;
	GhostChangingCommon "ghostchanging";
	.clear kp.modifier;
)

event.OnGhostCalling : $(
	GhostChangingCommon "ghostcalling";
	.clear kp.modifier;
)

=kis
# OnGhostChanging/OnGhostCalling??��?��??��?��??��?��ʏ�??��?��??��?��
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ghostchanging/ghostcalling
function GhostChangingCommon $(
	if $[ $(.size @arg) != 2 ] $(return);

	if $[ ${System.Request.Reference1} == "automatic" ] $(
		.setstr kp.modifier "Auto";
	);
	.setstr nextghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr nextname $(NormReference 2);
	);
	TalkSafeSearch "kp.on"$@arg[1]$(
		if $[ ${closemode} == 3 ]
			"2"
	);
	.clear nextghost;
	.clear nextname;
);
=end

# ??��?��S??��?��[??��?��X??��?��g??��?��̃t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanging.ghostname (
	TalkGhostChangingEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostChangingEx.${nextghost}.${nextname}
)
kp.onghostcalling.ghostname (
	TalkGhostCallingEx.${nextghost}.${nextname}.$(KPdate %m%d),
	TalkGhostCallingEx.${nextghost}.${nextname}
)

# ??��?��ʏ�̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanging.normal (
	TalkGhostChanging.${nextghost}.$(KPdate %m%d),
	TalkGhostChanging.__other__.$(KPdate %m%d),
	TalkGhostChanging.${nextghost}
)
kp.onghostcalling.normal (
	TalkGhostCalling.${nextghost}.$(KPdate %m%d),
	TalkGhostCalling.__other__.$(KPdate %m%d),
	TalkGhostCalling.${nextghost}
)

# ??��?��ėp??��?��I??��?��Ȑ؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanging.general (
	TalkGhostChanging
)
kp.onghostcalling.general (
	TalkGhostCalling,
	TalkGeneralBegin
)

# ??��?��??��?��??��?��Ԋ֌W??��?��̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onghostchanging.timetalk (
	TalkGhostChanging.${kp.modifier}
)
kp.onghostcalling.timetalk (
	TalkGhostCalling.${kp.modifier}
)

#??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�ɉ�??��?��??��?��??��?��āA??��?��S??��?��[??��?��X??��?��g??��?��ؑ֎�??��?��g??��?��[??��?��N??��?��̗D??��?��?��???��?��ʂ�ݒ�
=kis
if ${kp.config.useghostchangetimefirst} $(
	.copy kp.onghostchanging.timetalk kp.onghostchanging;
	.copy kp.onghostcalling.timetalk kp.onghostcalling;
);
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onghostchanging.ghostname kp.onghostchanging;
	.copy kp.onghostcalling.ghostname kp.onghostcalling;
);
.copy kp.onghostchanging.normal kp.onghostchanging;
.copy kp.onghostcalling.normal kp.onghostcalling;
if $[ ! ${kp.config.useghostchangetimefirst} ] $(
	.copy kp.onghostchanging.timetalk kp.onghostchanging;
	.copy kp.onghostcalling.timetalk kp.onghostcalling;
);
# OnGhostChanging??��?��̔�??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��??��?��??��?��??��?��??��?��?��???��?��AOnClose??��?��̔�??��?��??��?��??��?��ő�p??��?��??��?��??��?��??��?��??��?��݂�
# OnGhostCalling??��?��͑�p??��?��??��?��??��?��Ȃ�
.copy kp.onghostchanging.general kp.onghostchanging;
.copy kp.onclose onghostchanging;
.copy kp.onghostcalling.general kp.onghostcalling;
=end

# ??��?��ċN??��?��??��?��??��?��??��?��
# TalkRebooting??��?��??��?��??��?��D??��?��悳??��?��??��?��??��?��ȊO??��?��??��?��kp.onghostchanged??��?��Ƌ�??��?��??��?��
# OnGhostCalling??��?��??��?��??��?��͔�??��?��??��?��??��?��??��?��??��?��Ȃ�
=kis
.setstr kp.onghostchanging2 "TalkRebooting";
.copy kp.onghostchanging kp.onghostchanging2;
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onghostchanging,	kp.onghostchanging2,kp.onghostcalling

#==============================================================================


#??��?��^??��?��O??��?��ɂ�??��?��S??��?��[??��?��X??��?��g??��?��̏I??��?��??��?��??��?��̃t??��?��b??��?��N==============================================

event2.OnTranslate : $(
	.setstr @ref0 $(GetString System.Request.Reference0 0);
	# ??��?��I??��?��??��?��??��?��Ɋ֌W??��?��??��?��??��?��??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��΋A??��?��??��?��
	if $[	$(.match ${@ref0} "\\![change,ghost,") < 0
		&&	$(.match ${@ref0} "\\-") < 0
		&&	$(.match ${@ref0} "\\![reload,shiori]") < 0
		&&	$(.match ${@ref0} "\\![reload,ghost]") < 0
	] $(return);
	.setstr @ref0len $(.length ${@ref0});
	.setstr @i 0;
	while $[ ${@i} < ${@ref0len} ] $(
		.setstr @c $(sslex_char_at ${@ref0} ${@i});
		if $(.match_at ${@c} "\\![change,ghost,") $(
			# ??��?��S??��?��[??��?��X??��?��g??��?��؂�ւ�??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��
			if $[ $(.setstr @pos $(GetCloseParenthesis ${@c}) ; .entry @pos) > 0 ] $(
				# ??��?��??��?��??��?��ʂ͕�??��?��Ă�??��?��??��?��(=??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��)
				.setstr @ghost $(.substr ${@c} 16 $[ ${@pos} - 16 ]);
				if $[ ${System.OwnerGhost} == ${@ghost} ] $(
					# ??��?��S??��?��[??��?��X??��?��g??��?��؂�ւ�??��?��ɂ�??��?��ċN??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
					.setstr @exit 3;
					break;
				) else if ${(System.InstalledGhost+kp.specialghostname)&@ghost} $(
					# ??��?��L??��?��??��?��??��?��ȃS??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
					.setstr @exit 1;
					break;
				);
			);
		) else if $[ ${@c} == "\\-" ] $(
			# ??��?��I??��?��??��?��??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��
			.setstr @exit 1;
			break;
		) else if $[ ${@c} == "\\![reload,shiori]" || ${@c} == "\\![reload,ghost]" ] $(
			#??��?��??��?��??��?��??��?��??��?��[??��?��h??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��
			.setstr @exit 3;
			break;
		);
		.inc @i $(.length ${@c});
	);
	# @exit??��?��t??��?��??��?��??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��??��?��??��?��I??��?��??��?��??��?��??��?��??��?��??��?��
	if ${@exit} $(SetCloseCond ; .setstr closemode ${@exit});
)

# ??��?��??��?��??��?��??��?��ȋ@??��?��\??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��?��?
kp.specialghostname : random, sequential, lastinstalled

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.specialghostname

#==============================================================================


#??��?��I??��?��??��?��??��?��n??��?��??��?��??��?��ʏ�??��?��??��?��================================================================
#??��?��Ăяo??��?��??��?��??��?��??��?��Ă�??��?��??��?��Z??��?��??��?��??��?��Ԃł̏I??��?��??��?��??��?��A??��?��܂�??��?��͐؂�ւ�

=kis
function CloseCondSearch $(
	.setstr kp.modifier $(ModifierSearch "kp.close.short" ${ghosttime.now});
);
=end

=kis
#??��?��I??��?��??��?��??��?��??��?��??��?��̏�??��?��??��?��(??��?��I??��?��??��?��??��?��??��?��??��?��ԁA??��?��I??��?��??��?��??��?��??��?��??��?��A??��?��A??��?��C??��?��R??��?��??��?��??��?��??��?��??��?��??��?��??��?��ԁA??��?��f??��?��X??��?��N??��?��g??��?��b??��?��v??��?��??��?��??��?��??��?��)??��?��??��?��??��?��Z??��?��b??��?��g
function SetCloseCond $(
	setFreeze;
	.setstr endtime $(MinCalc);
	.setstr endday $(DayCalc);
	if $(.size time.iconize) $(
		.setstr time.iconize.before $(GetInteger time.iconize);
	);
	if $(.size time.desktop) $(
		.setstr time.desktop.before $(GetInteger time.desktop);
	);
	# ??��?��??��?��??��?��d??��?��N??��?��??��?��??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��h??��?��~??��?��p??��?��??��?��mutex
	.setstr kp.bootmutex 0;
	# ??��?��N??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��t??��?��??��?��??��?��O??��?��̃N??��?��??��?��??��?��A
	.setstr kp.iscrashed 0;
	# ??��?��??��?��??��?��??��?��N??��?��??��?��??��?��t??��?��??��?��??��?��O??��?��̃N??��?��??��?��??��?��A
	.setstr kp.isfirstboot 0;
);
=end

# ??��?��I??��?��??��?��??��?��n??��?��??��?��??��?��ʃZ??��?��[??��?��u??��?��??��?��??��?��??��?��(??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��??��?��??��?��ċN??��?��??��?��??��?��܂�)
# SSP??��?��̃S??��?��[??��?��X??��?��g??��?��L??��?��??��?��??��?��b??��?��V??��?��??��?��??��?��ɓ�??��?��??��?��??��?��??��?��(OnCacheSuspend)??��?��?��???��?��??��?��??��?��܂�
System.Callback.OnUnload , event.OnCacheSuspend : $(
	# closemode=0: ??��?��??��?��??��?��??��?��??��?��??��?��??��?��L??��?��^??��?��??��?��??��?��Ă�??��?��Ȃ�??��?��A??��?��??��?��??��?��??��?��Şx??��?��??��?��??��?��??��?��??��?��[??��?��h
	# closemode=1: ??��?��??��?��??��?��??��?��??��?��͋L??��?��^??��?��ς݁A??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��ȊO
	# closemode=2: ??��?��??��?��??��?��??��?��??��?��??��?��??��?��L??��?��^??��?��??��?��??��?��Ă�??��?��Ȃ�??��?��A??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��??��?��??��?��??��?��
	# closemode=3: ??��?��??��?��??��?��??��?��??��?��͋L??��?��^??��?��ς݁A??��?��^??��?��O??��?��ɂ�??��?��x??��?��??��?��??��?��??��?��??��?��[??��?��h??��?��??��?��
	# ??��?��??��?��??��?��??��?��ȊO:    closemode??��?��??��?��NULL??��?��??��?��??��?��A??��?��ُ�I??��?��??��?��
	.setstr @closemode $(GetInteger closemode);
	if  $[ ${@closemode} == 0 ] $(
		.setstr closemode 3;
		SetCloseCond;
		Backup;
	) else if $[ ${@closemode} == 1 ] $(
		SaveData;
		ClearData;
	) else if $[ ${@closemode} == 2 ] $(
		SetCloseCond;
		Backup;
	) else if $[ ${@closemode} == 3 ] $(
		Backup;
	) else $(
		SetCloseCond;
		SaveData;
		ClearData;
	);
	LogMsg (
		$(if $[ ${System.Request.ID} =~ "Cache" ] "Suspend" else "Unload")
		" at "$(.date %s)
	) "closemode='"${@closemode}"'";
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : dataclearparam

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : CloseCondSearch,SetCloseCond

#==============================================================================


#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��̋N??��?��??��?��/??��?��I??��?��??��?��*******************************************************

#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��??��?��??��?��N??��?��??��?��(OnOtherGhostBooted)========================================

event.OnOtherGhostBooted : $(
	.setstr bootedghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr bootedname $(NormReference 2);
	);
	SearchKeyword "kp.otherghostbootedwords" $(Reference 1);
	TalkSearch "kp.onotherghostbooted";
	.clear scriptwords;
	.clear bootedghost;
	.clear bootedname;
)

# ??��?��S??��?��[??��?��X??��?��g??��?��̃t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostbooted.ghostname (
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.$(KPdate %m%d),
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}.${scriptwords},
	TalkOtherGhostBootedEx.${bootedghost}.${bootedname}
)

# ??��?��ʏ�̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostbooted.normal (
	TalkOtherGhostBooted.${bootedghost}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBooted.__other__.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostBooted.${bootedghost}.$(KPdate %m%d),
	TalkOtherGhostBooted.${bootedghost}.${scriptwords},
	TalkOtherGhostBooted.__other__.$(KPdate %m%d),
	TalkOtherGhostBooted.__other__.${scriptwords},
	TalkOtherGhostBooted.${bootedghost}
)

# ??��?��ėp??��?��I??��?��Ȑ؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostbooted.general (
	TalkOtherGhostBooted,
	TalkGeneral
)

# ??��?��t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.otherghostbootedwords.ghostname (
	OtherGhostBootedWords.${bootedghost}.${bootedname}
)

# ??��?��ʏ�̃L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.otherghostbootedwords.normal (
	OtherGhostBootedWords.${bootedghost},
	OtherGhostBootedWords.__other__
)

#??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�ɉ�??��?��??��?��??��?��āA??��?��S??��?��[??��?��X??��?��g??��?��ؑ֎�??��?��g??��?��[??��?��N??��?��̗D??��?��?��???��?��ʂ�ݒ�
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onotherghostbooted.ghostname kp.onotherghostbooted;
	.copy kp.otherghostbootedwords.ghostname kp.otherghostbootedwords;
);
.copy kp.onotherghostbooted.normal kp.onotherghostbooted;
.copy kp.onotherghostbooted.general kp.onotherghostbooted;
.copy kp.otherghostbootedwords.normal kp.otherghostbootedwords;
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onotherghostbooted, kp.otherghostbootedwords

#==============================================================================


#??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��??��?��??��?��I??��?��??��?��(OnOtherGhostClosed)========================================

event.OnOtherGhostClosed : $(
	.setstr closedghost $(NormReference 0);
	if $[ $(Reference 2) != "" ] $(
		.setstr closedname $(NormReference 2);
	);
	SearchKeyword "kp.otherghostclosedwords" $(Reference 1);
	TalkSearch "kp.onotherghostclosed";
	.clear scriptwords;
	.clear closedghost;
	.clear closedname;
)

# ??��?��S??��?��[??��?��X??��?��g??��?��̃t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostclosed.ghostname (
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.$(KPdate %m%d),
	TalkOtherGhostClosedEx.${closedghost}.${closedname}.${scriptwords},
	TalkOtherGhostClosedEx.${closedghost}.${closedname}
)

# ??��?��ʏ�̐؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostclosed.normal (
	TalkOtherGhostClosed.${closedghost}.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosed.__other__.$(KPdate %m%d).${scriptwords},
	TalkOtherGhostClosed.${closedghost}.$(KPdate %m%d),
	TalkOtherGhostClosed.${closedghost}.${scriptwords},
	TalkOtherGhostClosed.__other__.$(KPdate %m%d),
	TalkOtherGhostClosed.__other__.${scriptwords},
	TalkOtherGhostClosed.${closedghost}
)

# ??��?��ėp??��?��I??��?��Ȑ؂�ւ�??��?��??��?��??��?��??��?��
kp.onotherghostclosed.general (
	TalkOtherGhostClosed,
	TalkGeneral
)

# ??��?��t??��?��??��?��??��?��l??��?��[??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.otherghostclosedwords.ghostname (
	OtherGhostClosedWords.${closedghost}.${closedname}
)

# ??��?��ʏ�̃L??��?��[??��?��??��?��??��?��[??��?��h??��?��??��?��??��?��X??��?��g
kp.otherghostclosedwords.normal (
	OtherGhostClosedWords.${closedghost},
	OtherGhostClosedWords.__other__
)

#??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�ɉ�??��?��??��?��??��?��āA??��?��S??��?��[??��?��X??��?��g??��?��ؑ֎�??��?��g??��?��[??��?��N??��?��̗D??��?��?��???��?��ʂ�ݒ�
=kis
if ${kp.config.useghostchangeghostname} $(
	.copy kp.onotherghostclosed.ghostname kp.onotherghostclosed;
	.copy kp.otherghostclosedwords.ghostname kp.otherghostclosedwords;
);
.copy kp.onotherghostclosed.normal kp.onotherghostclosed;
.copy kp.onotherghostclosed.general kp.onotherghostclosed;
.copy kp.otherghostclosedwords.normal kp.otherghostclosedwords;
=end

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onotherghostclosed, kp.otherghostclosedwords

#==============================================================================


#??��?��}??��?��E??��?��X??��?��??��?��??��?��??��?��??��?��n??��?��??��?��??��?��??��?��??��?��Q************************************************************

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��Ń_??��?��u??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N(OnMouseDoubleClick)==============================

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��Ń_??��?��u??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N??��?��??��?��??��?��??��?��??��?��ۂɎ�??��?��s??��?��??��?��??��?��??��?��܂�
#??��?��??��?��??��?��??��?��??��?��o??��?��??��?��??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��??��?���??��?��??��?��??��?��??��?��??��?��Ɏg??��?��??��?��??��?��܂�
#??��?��??��?��??��?��??��?��??��?��̈�ŃV??��?��??��?��??��?��O??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N??��?��ƃ_??��?��u??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N??��?��̋�??��?��??��?��??��?��͏o??��?��??��?��??��?��Ȃ�??��?��̂Œ�??��?��??��?��
#??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��V??��?��??��?��??��?��O??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N??��?��??��?��??��?��D??��?��悳??��?��??��?��܂�

event.OnMouseDoubleClick : $(
	if $(isNotFreezing) $(
		SetMouseCond useother;
		TalkSearch "kp.onmousedoubleclick";
		ClearMouseCond;
	);
)

kp.onmousedoubleclick (
	C${characterscope}Double.${mousezone}.${surfacenum},
	C${characterscope}Double.${mousezone},
	C${characterscope}Doubleclick
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onmousedoubleclick

#==============================================================================


#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��ŃV??��?��??��?��??��?��O??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N(OnMouseClick)==================================

#??��?��̈�w??��?��??��?��i??��?��??��?��:Bust,Face??��?��j??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��͖�??��?��??��?��??��?��??��?��??��?��??��?��܂�
#??��?��܂�??��?��A??��?��??��?��??��?��??��?��??��?��̈�ł̃_??��?��u??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N??��?��Ƃ̋�??��?��??��?��??��?��͏o??��?��??��?��??��?��܂�??��?��??��?��

event.OnMouseClick : $(
	if $(isNotFreezing) $(
		if $[ $(Reference 4) == "" && ! $(Reference 5) ] $(return);
		SetMouseCond;
		TalkSearch "kp.onmousesingleclick"$(IntReference 5);
		ClearMouseCond;
	);
)

# ??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N
kp.onmousesingleclick0 ( 
	C${characterscope}Single.${mousezone}.${surfacenum},
	C${characterscope}Single.${mousezone},
	C${characterscope}Singleclick
)

# ??��?��E??��?��N??��?��??��?��??��?��b??��?��N
kp.onmousesingleclick1 ( 
	C${characterscope}SingleRight.${mousezone}.${surfacenum},
	C${characterscope}SingleRight.${mousezone},
	C${characterscope}SingleclickRight
)

# ??��?��??��?��??��?��??��?��/??��?��z??��?��C??��?��[??��?��??��?��??��?��N??��?��??��?��??��?��b??��?��N
kp.onmousesingleclick2 ( 
	C${characterscope}SingleMiddle.${mousezone}.${surfacenum},
	C${characterscope}SingleWheel.${mousezone}.${surfacenum},
	C${characterscope}SingleMiddle.${mousezone},
	C${characterscope}SingleWheel.${mousezone},
	C${characterscope}SingleclickMiddle,
	C${characterscope}SingleclickWheel
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onmousesingleclick0,
	kp.onmousesingleclick1,
	kp.onmousesingleclick2
)

#==============================================================================


#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��ł̃}??��?��E??��?��X??��?��J??��?��[??��?��\??��?��??��?��??��?��ړ�(OnMouseMove)===============================

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��̏�Ń}??��?��E??��?��X??��?��J??��?��[??��?��\??��?��??��?��??��?��??��?��?��??��?��??��?��??��?��??��?��??��?��ۂɎ�??��?��s??��?��??��?��??��?��??��?��܂�
#??��?��??��?��??��?��??��?��??��?��ł⋹??��?��??��?��??��?��??��?��??��?��ȂǂɎg??��?��??��?��??��?��Ă�??��?��܂�

event.OnMouseMove : $(
	if $(isNotFreezing) $(
		if ${System.Request.Reference4} $(
			# ??��?��??��?��??��?��蔻??��?��??��?��̈�??��?��??��?��ɃJ??��?��[??��?��\??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
			SetMouseCond;
			# beforemousestate??��?��??��?��??��?��??��?��??��?��S??��?��??��?��
			.setstr beforemousestate $(GetString beforemousestate);
			if $[ ${characterscope}"/"${mousezone} == ${beforemousestate} ] $(
				# ??��?��J??��?��[??��?��\??��?��??��?��??��?��͑O??��?��??��?��Ɠ�??��?��??��?��??��?��̈�??��?��??��?��ɂ�??��?��??��?��
				SecureInc mousecount;
				# stroke.limit??��?��??��?��??��?��??��?��??��?��S??��?��??��?��
				.setstr stroke.limit $(NonNegative $(GetString stroke.limit));
				if $[ ${stroke.limit} == ${mousecount} ] $(
					# ??��?��J??��?��E??��?��??��?��??��?��g??��?��??��?��??��?��ݒ肵??��?��??��?��limit??��?��ɒB??��?��??��?��??��?��??��?��??��?��̂Ńg??��?��[??��?��N
					TalkSearch "kp.onmousemove.stroke";
					NextStrokeSearch;
				);
			) else $(
				# ??��?��J??��?��[??��?��\??��?��??��?��??��?��͑O??��?��??��?��ƈႤ??��?��̈�ɂ�??��?��??��?��
				.setstr beforemousestate ${characterscope}"/"${mousezone};
				FirstStrokeSearch;
			);
			ClearMouseCond;
		) else $(
			# ??��?��??��?��??��?��蔻??��?��??��?��̈�O
			.setstr mousecount 0;
		);
	);
)

=kis
# ??��?��??��?��??��?��??��?��limit??��?��??��?��??��?��??��?��??��?��??��?��??��?��E??��?��ݒ�(NextStrokeSearch)
# mousecount??��?��͈�??��?��S??��?��??��?��??��?��??��?��??��?��Ă�??��?��邱??��?��Ƃ�??��?��O??��?��??��?��
function NextStrokeSearch $(
	# ??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��擾
	.setstr @option $(EntryName $(EntrySearch "kp.onmousemove.option"));
	# tmp.stroke??��?��??��?��res.phase??��?��??��?��??��?��??��?��??��?��S??��?��??��?��
	.setstr tmp.stroke $(GetString tmp.stroke);
	.setstr res.phase $(NonNegative $(GetString res.phase));
	# res.phase??��?��??��?��??��?��V??��?��t??��?��g
	if $[ $(.find ${@option} "loopall") >= 0 ] $(
		# phase??��?��??��?��??��?��??��?��??��?��[??��?��v??��?��??��?��??��?��??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
		.setstr mousecount $[ ${mousecount} % $(NonNegative $(GetString ${tmp.stroke} "-1")) ];
		.setstr res.phase $[ ( ${res.phase} + 1 ) % $(.size ${tmp.stroke}) ];
	) else $(
		# phase??��?��͏�??��?��??��?��ŖO??��?��a
		if $[ $(.find ${@option} "looplast") >= 0 && ${res.phase} == $(.size ${tmp.stroke}) - 1 ] $(
			# ??��?��Ō�??��?��phase??��?��?��???��?��??��?��[??��?��v??��?��??��?��??��?��??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
			.setstr mousecount 0;
		);
		# phase??��?��??��?��??��?��??��?��??��?��??��?��ŖO??��?��a??��?��??��?��??��?��??��?��??��?���??��?��??��?��
		SecureInc res.phase 1 $[ $(.size ${tmp.stroke}) - 1 ];
	);
	.setstr stroke.limit $(NonNegative $(GetString ${tmp.stroke} ${res.phase}));
);
=end

=kis
# ??��?��ŏ�??��?��??��?��limit??��?��??��?��??��?��??��?��??��?��??��?��??��?��E??��?��ݒ�(FirstStrokeSearch)
function FirstStrokeSearch $(
	.setstr mousecount 0;
	.setstr res.phase 0;
	.setstr tmp.stroke $(EntryName $(EntrySearch "kp.onmousemove.limit"));
	if $[ $(.length ${tmp.stroke}) == 0 ] $(
		# limit??��?��͐ݒ肳??��?��??��?��Ă�??��?��Ȃ�??��?��̂ŁA??��?��f??��?��t??��?��H??��?��??��?��??��?��g??��?��l??��?��??��?��ݒ�
		.setstr tmp.stroke "kp.onmousemove.defaultlimit";
	);
	.setstr stroke.limit $(NonNegative $(GetString ${tmp.stroke} 0));
);
=end

# limit??��?��ݒ肪??��?��Ȃ�??��?��?��???��?��̃f??��?��t??��?��H??��?��??��?��??��?��g
kp.onmousemove.defaultlimit : 1

# limit
kp.onmousemove.limit (
	C${characterscope}Stroke.limit.${mousezone}.${surfacenum},
	C${characterscope}Stroke.limit.${mousezone}
)

# ??��?��g??��?��[??��?��N
kp.onmousemove.stroke (
	C${characterscope}Stroke.${res.phase}.${mousezone}.${surfacenum},
	C${characterscope}Stroke.${res.phase}.${mousezone},
	C${characterscope}Stroke.${mousezone}.${surfacenum},
	C${characterscope}Stroke.${mousezone}
)

# ??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��ݒ�
kp.onmousemove.option (
	C${characterscope}Stroke.option.${mousezone}.${surfacenum},
	C${characterscope}Stroke.option.${mousezone},
	C${characterscope}Stroke.option
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onmousemove.defaultlimit,
	kp.onmousemove.limit,
	kp.onmousemove.stroke,
	kp.onmousemove.option
)

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : FirstStrokeSearch, NextStrokeSearch

#==============================================================================


#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��Ń}??��?��E??��?��X??��?��z??��?��C??��?��[??��?��??��?��??��?��??��?��](OnMouseWheel)================================

event.OnMouseWheel : $(
	if $(isNotFreezing) $(
		SetMouseCond useother;
		TalkSearch "kp.onmousewheel";
		ClearMouseCond;
	);
)

kp.onmousewheel (
	C${characterscope}Wheel.${kp.wheelvalue}.${mousezone}.${surfacenum},
	C${characterscope}Wheel.${kp.wheelvalue}.${mousezone},
	C${characterscope}Wheel.Both.${mousezone}.${surfacenum},
	C${characterscope}Wheel.Both.${mousezone},
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onmousewheel

#==============================================================================


#??��?��}??��?��E??��?��X??��?��n??��?��??��?��??��?��??��?��??��?��??��?��??��?��ʊ֐�==========================================================

# ??��?��??��?��??��?��ʏ�??��?��??��?��??��?��??��?��??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��ɃZ??��?��b??��?��g(SetMouseCond)
# ??��?��??��?��1??��?��??��?��??��?��??��?�� : ??��?��uuseother??��?��v??��?��Ȃ�Reference4??��?��??��?��NULL??��?��̎�mousezone??��?��??��?��??��?��u__other__??��?��v??��?��ɂ�??��?��??��?��
#           ??��?��ȗ�??��?��\??��?��B
=kis
function SetMouseCond $(
	.setstr characterscope $(NonNegReference 3);
	.setstr surfacenum $(GetInteger SurfaceC${characterscope});
	.setstr mousezone $(EntNamReference 4);
	# useother??��?��I??��?��v??��?��V??��?��??��?��??��?��??��?��??��?��Łu__other__??��?��v??��?��??��?��t??��?��??��?��
	if $[ $@arg[1] == "useother" && ! ${System.Request.Reference4} ] $(
		.setstr mousezone "__other__";
	);
	# Reference2??��?��??��?��??��?��??��?��??��?��݂�??��?��??��?��?��???��?��A??��?��z??��?��C??��?��[??��?��??��?��??��?��??��?��]??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��s
	if ${System.Request.Reference2} $(
		if $[ $(IntReference 2) > 0 ] $(
			.setstr kp.wheelvalue "Plus";
		) else $(
			.setstr kp.wheelvalue "Minus";
		);
	);
);
=end

# ??��?��??��?��??��?��ʏ�??��?��??��?��??��?��??��?��??��?��N??��?��??��?��??��?��A(ClearMouseCond)
=kis
function ClearMouseCond $(
	.clear characterscope;
	.clear surfacenum;
	.clear mousezone;
	.clear kp.wheelvalue;
);
=end

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : SetMouseCond, ClearMouseCond

#==============================================================================


#??��?��e??��?��??��?��??��?��ԕω�??��?��n****************************************************************

#??��?��ŏ�??��?��??��?��??��?��֘A(OnWindowState...)==================================================
#freeze??��?��ɂ�??��?��}??��?��??��?��??��?��??��?��??��?��g??��?��??��?��??��?��iWinAMP??��?��??��?��??��?��Ŕ�??��?��??��?��??��?��??��?��??��?��??��?��\??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��ׁj

#??��?��ŏ�??��?��??��?��??��?��J??��?��n(OnWindowStateMinimize)---------------------------------------------

event.OnWindowStateMinimize : $(
	setFreeze;
	.setstr iconizing 1;
	.setstr minimizedtime 0;
	GetifExist kp.callback.OnWindowStateMinimize;
	silent;
)

#??��?��ŏ�??��?��??��?��??��?��??��?��??��?��畜�A(OnWindowStateRestore)------------------------------------------

event.OnWindowStateRestore : $(
	resetFreeze;
	.setstr iconizing 0;
	GetifExist kp.callback.OnWindowStateRestore;
	.setstr kp.modifier $(ModifierSearch "kp.minimizedtime" ${minimizedtime});
	TalkSafeSearch "kp.onwindowstaterestore";
	.clear kp.modifier;
)

kp.onwindowstaterestore (
	TalkRestore.${kp.modifier},
	TalkRestore,
	TalkGeneral
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onwindowstaterestore

#==============================================================================


#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��??��?��??��?��??��?��??��?��(OnSurface...)==============================================

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��??��?��ԍ�??��?��擾(OnSurfaceChange)---------------------------------------

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��??��?��ς�??��?��??��?��??��?��??��?��ۂɎ�??��?��s??��?��??��?��??��?��??��?��A\0,\1??��?��??��?��??��?��ꂼ??��?��??��?��̃T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��??��?��
#SurfaceC(0/1)??��?��Ɋi??��?��[??��?��??��?��??��?��??��?��܂�??��?��B

event.OnSurfaceChange : $(
	.setstr SurfaceC0 $(IntReference 0);
	.setstr SurfaceC1 $(IntReference 1);
	# SSP??��?��g??��?��??��?��??��?��??��?��Reference2??��?��ɑΉ�
	.clear @msg;
	.split @msg $(Reference 2) ",";
	if $[ $(.size @msg) > 1 ] $(
		# ??��?��Ӗ�??��?��̂�??��?��?��???��?��b??��?��Z??��?��[??��?��W??��?��??��?��??��?��??��?��??��?��??��?��
		.setstr SurfaceC$(NonNegative $@msg[0]) $(Integer $@msg[1]);
	);
)

#MATERIA??��?��̏ꍇOnSurfaceChange??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��ׁAOnTranslate??��?��ő�֏�??��?��??��?��
#Thanx to ??��?��??��?��??��?��??��?��?��???��?��??��?��??��?��??��?��??��?��??��?��??��?��(akira-k@blue.interq.or.jp) ??��?��coriginal code

# event2.OnTranslate??��?��́Aevent.OnTranslate??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��ɒǉ�??��?��??��?��??��?��??��?��??��?��
event2.OnTranslate : $(
	if $[ ${System.Request.Sender} != "embryo" ] $(return);
	SSParser ${System.Request.Reference0};
)

=kis
# ??��?��??��?��??��?��??��?��??��?��??��?��X??��?��N??��?��??��?��??��?��v??��?��g??��?��??��?��??��?��??��?��͂�??��?��A??��?��e??��?��L??��?��??��?��??��?��??��?��??��?��̍Ō�̃T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��??��?��??��?��擾??��?��??��?��??��?��??��?��
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��X??��?��N??��?��??��?��??��?��v??��?��g
# ??��?��߂�l : ??��?��Ȃ�(SurfaceC*??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��ɃT??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��??��?��??��?��i??��?��[)
function SSParser $(
	if $[ $(.size @arg) != 2 ] $(return);

	# ??��?��f??��?��t??��?��H??��?��??��?��??��?��g??��?��??��?��\0??��?��??��?��
	.setstr @side 0;
	.setstr @i 0;
	.setstr @length $(.length $@arg[1]);
	while $[ ${@i} < ${@length} ] $(
		.setstr @c $(sslex_char_at $@arg[1] ${@i});
		if $[ $(.length ${@c}) > 1 ] $(
			# ??��?��??��?��͑ΏےP??��?��??��?��??��?��@word??��?��??��?��
			.setstr @word $(substr ${@c} 1);
			if $(.match_at ${@word} "e") $(
				# ??��?��I??��?��??��?��??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��̂ŉ�͑ł�??��?��؂�
				break;
			) else if $[ $(.match_at ${@word} "0") || $(.match_at ${@word} "h") ] $(
				# ??��?��??��?��??��?��??��?��??��?��瑤??��?��??��?��??��?��??��?��??��?��??��?��
				.setstr @side 0;
			) else if $[ $(.match_at ${@word} "1") || $(.match_at ${@word} "u") ] $(
				# ??��?��??��?��??��?��ɂイ??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
				.setstr @side 1;
			) else if $(.match_at ${@word} "p[") $(
				# \p[]??��?��^??��?��O??��?��??��?��??��?��??��?��??��?��??��?��
				.setstr @side $(
					.substr ${@word}"]" 2 $[ $(GetCloseParenthesis ${@word}"]" 1) - 2 ]
				);
				# ??��?��X??��?��R??��?��[??��?��v??��?��ԍ�??��?��͕K??��?��??��?��??��?��??��?��??��?��??��?��??��?��
				.setstr @side $(NonNegative ${@side});
			) else if $(.match_at ${@word} "s[") $(
				# ??��?��T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��擾
				.setstr SurfaceC${@side} $(
					.substr ${@word}"]" 2 $[ $(GetCloseParenthesis ${@word}"]" 1) - 2 ]
				);
				# ??��?��T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��͐�??��?��??��?��??��?��̔�
				.setstr SurfaceC${@side} $(Integer ${SurfaceC${@side}});
			);
		);
		.inc @i $(.length ${@c});
	);
);
=end

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : SSParser

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��??��?��A(OnSurfaceRestore)----------------------------------------------

#??��?��T??��?��[??��?��t??��?��B??��?��X??��?��??��?��??��?��C??��?��??��?��??��?��M??��?��??��?��??��?��??��?��??��?��[??��?��ȏ�Ԃ�??��?��??��?��i??��?��ʏ�@\0:??��?��T??��?��[??��?��t??��?��B??��?��X0 \1:??��?��T??��?��[??��?��t??��?��B??��?��X10??��?��j
#??��?��߂�^??��?��C??��?��~??��?��??��?��??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��Ƃ�??��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�
#??��?��^??��?��O??��?��ȊO??��?��̕�??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��̂݁A??��?��g??��?��[??��?��N??��?��J??��?��E??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��Z??��?��b??��?��g??��?��??��?��??��?��܂�??��?��B

event.OnSurfaceRestore : $(
	.setstr kp.surfacec0 $(IntReference 0);
	.setstr kp.surfacec1 $(IntReference 1);
	# ??��?��ȉ�??��?��ATalkSearch??��?��̕ό`
	.setstr @talkentry $(EntrySearch "kp.onsurfacerestore");
	if $[ $(.length ${@talkentry}) != 0 ] $(
		.setstr @str $(EntryRefer ${@talkentry});
		#??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N??��?��t??��?��??��?��??��?��O??��?��??��?��??��?��f??��?��t??��?��H??��?��??��?��??��?��g??��?��ł̓N??��?��??��?��??��?��A
		.clear kp.internaltalkflag;
		if $[ $(.length ${@str}) != 0 ] $(
			# ??��?��O??��?��??��?��SSTP??��?��g??��?��[??��?��N??��?��ł͂Ȃ�??��?��A??��?��??��?��??��?��??��?��??��?��g??��?��[??��?��N??��?��ł�??��?��??��?��؋�??��?��̃t??��?��??��?��??��?��O??��?��??��?��Ă�
			.setstr kp.internaltalkflag 1;
			# ??��?��^??��?��O??��?��ȊO??��?��??��?��b??��?��??��?��??��?��??��?��??��?��?��???��?��̂݁A??��?��g??��?��[??��?��N??��?��J??��?��E??��?��??��?��??��?��g??��?��??��?��??��?��??��?��??��?��Z??��?��b??��?��g
			if $(GetPlainText ${@str}) $(resetTalkcount);
			.entry @str;
		);
	);
	.clear kp.surfacec0;
	.clear kp.surfacec1;
)

kp.onsurfacerestore (
	TalkReturn.${kp.surfacec0}_${kp.surfacec1},
	TalkReturn.${kp.surfacec1},
	TalkReturn.${kp.surfacec0},
	TalkReturn
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onsurfacerestore

#==============================================================================


#??��?��C??��?��x??��?��??��?��??��?��g??��?��??��?��??��?��s??��?��n??��?��??��?��??��?��??��?��??��?��Q**********************************************************

#Vanish??��?��??��?��??��?��??��?��??��?��֘A(OnVanish...)===================================================
#freeze??��?��t??��?��??��?��??��?��O??��?��ݒ�

event.OnVanishSelecting : $(
	setFreeze;
	Talk "TalkVanishSelecting";
)
event.OnVanishSelected : $(
	setFreeze;
	Talk "TalkVanishSelected";
)
event.OnVanishCancel : $(
	resetFreeze;
	Talk "TalkVanishCancel";
)
event.OnVanishButtonHold : $(
	resetFreeze;
	Talk "TalkVanishButtonHold";
)

#??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��??��?��Vanish??��?��??��?��??��?��??��?��Ă�??��?��??��?��̌�??��?��--------------------------------------------

event.OnVanished : $(
	if $[ ! ${kp.bootmutex} ] $(
		# SSP??��?��ł́A??��?��N??��?��??��?��??��?��??��?��??��?��ɑ�??��?��̃S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��ł�??��?��Ă�OnVanished??��?��??��?��??��?��??��?��??��?��??��?��
		InitCond;
		GetifExist kp.callback.OnGhostChanged;
	);
	.setstr beforeghost $(StringNormalize $(VanishedGhostSearch));
	TalkSafeSearch "kp.onghostchanged.vanish";
	.clear beforeghost;
)

kp.onghostchanged.vanish (
	TalkOtherGhostVanished.${beforeghost},
	TalkOtherGhostVanished
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onghostchanged.vanish

=kis
# MATERIA583??��?��̃o??��?��O??��?��ŁA??��?��??��?��??��?��O??��?��??��?��Vanish??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��ʒm??��?��??��?��??��?��??��?��Ȃ�??��?��??��?��??��?��΍�
# vanish??��?��??��?��??��?��O??��?��ŏ�??��?��œ�??��?��??��?��??��?��??��?��??��?��ł�??��?��V??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��??��?��T??��?��??��?��??��?��A??��?��??��?��??��?��??��?��??��?��Ԃ�??��?��B
# MATERIA??��?��ȊO??��?��ł�OnVanished??��?��??��?��??��?��̂�??��?��??��?��??��?��Ȃ�??��?��??��?��??��?��A??��?��O??��?��̈�Reference0??��?��??��?��Ԃ�
function VanishedGhostSearch $(
	if $[ ${System.Request.Sender} != "embryo" ] $(
		return ${System.Request.Reference0};
	);

	.setstr @time "2000/01/0100:00:00";
	.textload @line "..\\..\\..\\..\\log\\vanish.txt";
	foreach @i @line $(
		.clear @j;
		.split @j ${@i} $(.chr 1);
		.clear @k;
		.split @k $@j[-1] " ";
		if $[ $(.compare $@k[0]$@k[2] ${@time}) >= 0 ] $(
			.setstr @time $@k[0]$@k[2];
			.setstr @ghost $@j[0];
		);
	);
	return ${@ghost};
);
=end

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : VanishedGhostSearch

#==============================================================================


##InputBox??��?��ɂ�??��?��??��?��??��?��́iOnUserInput??��?��j============================================

event.OnUserInput : $(
	Talk $(
		if $[ ${System.Request.Reference1} == "timeout" ]
			"TalkInputTimeOut."
		else
			"TalkInput."
	)$(EntNamReference 0);
)

#==============================================================================


#??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��i\q??��?��j??��?��ɂ�??��?��I??��?��??��?��??��?��??��?��??��?��I??��?��??��?��(OnChoiceSelect)================================
#??��?��u\q??��?��v??��?��ɂ�??��?��I??��?��??��?��??��?��??��?��??��?��??��?��??��?��I??��?��??��?��??��?��??��?��??��?��ꂽ??��?��Ƃ�??��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�

event.OnChoiceSelect : $(
	if $(.size kp.menuformname) $(
		# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��
		.setstr @menuformname $(.encode_entryname ${kp.menuformname});
		.clear kp.menuformname;
		.setstr kp.menuidcounter 0;
		Talk "MenuForm."${@menuformname};
	) else if $(.size kp.MenuGroup) $(
		# ??��?��I??��?��??��?��??��?��??��?��??��?��̕�??��?��ł�??��?��??��?��ɑI??��?��??��?��??��?��??��?��??��?��O??��?��??��?��??��?��[??��?��v??��?��??��?��??��?��ݒ肳??��?��??��?��邩??��?��??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��̂ŁA
		# ??��?��㗝�G??��?��??��?��??��?��g??��?��??��?��??��?��Ɉڂ�??��?��Ă�??��?��??��?��??��?��??��?��??��?��
		.setstr kp.MenuGroup2 $(.encode_entryname ${kp.MenuGroup});
		.clear kp.MenuGroup;
		TalkSearch "kp.onchoiceselect";
		.clear kp.MenuGroup2;
	) else $(
		Talk "Select."$(EntNamReference 0);
	);
)

=kis
# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��O??��?��??��?��??��?��[??��?��v??��?��??��?��ݒ肷??��?��??��?��
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��O??��?��??��?��??��?��[??��?��v
# ??��?��߂�l:  ??��?��Ȃ�
# ??��?��??��?��??��?��l:    ??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��̏ꍇ??��?��A??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��O??��?��??��?��??��?��[??��?��v??��?��??��?��??��?��N??��?��??��?��??��?��A??��?��??��?��??��?��??��?��
function setMenuGroup $(
	if $[ $(.size @arg) <= 1 ] $(
		.clear kp.MenuGroup;
	) else $(
		.setstr kp.MenuGroup $(.encode_entryname $@arg[1]);
	);
);
=end

=kis
# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��J??��?��n??��?��??��?��錾
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��߂�??��?��Ă�??��?��?��???��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��??��?��
# ??��?��߂�l:  ??��?��Ȃ�
function MenuForm $(
	if $[ $(.size @arg) != 2 ] $(return);
	.setstr kp.menuformname $@arg[1];
	.setstr kp.menuidcounter 0;
);
=end

=kis
# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��p??��?��??��?��\q??��?��^??��?��O??��?��ȈՓ�??��?��͗p??��?��R??��?��}??��?��??��?��??��?��h
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��I??��?��??��?��??��?��??��?��??��?��̓�??��?��e
# ??��?��??��?��??��?��l:    ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��ɖ߂�??��?��Ă�??��?��鎞�A??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��J??��?��n??��?��??��?��??��?��??��?��n??��?��ԖڂȂ�
#          ID??��?��??��?��n-1??��?��??��?��??��?��A??��?��??��?��??��?��Ă�??��?��??��?��B
function Menu.q $(
	if $[ $(.size @arg) != 2 ] $(return);
	.setstr kp.menuidcounter $(GetInteger kp.menuidcounter);
	.setstr @i ${kp.menuidcounter};
	.inc kp.menuidcounter;
	return "\\q["$@arg[1]","${@i}"]";
);
=end

=kis
# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��p??��?��??��?��\q??��?��^??��?��O??��?��ȈՓ�??��?��͗p??��?��R??��?��}??��?��??��?��??��?��h(ID??��?��t)
# ??��?��??��?��1??��?��??��?��??��?��??��?��: ??��?��I??��?��??��?��??��?��??��?��??��?��̓�??��?��e
# ??��?��??��?��2??��?��??��?��??��?��??��?��: ??��?��I??��?��??��?��??��?��??��?��??��?��??��?��ID
# ??��?��??��?��??��?��l:    ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��ɖ߂�??��?��Ă�??��?��鎞�A??��?��w??��?��肵??��?��??��?��ID??��?��??��?��??��?��??��?��??��?��??��?��
function Menu.q.id $(
	if $[ $(.size @arg) != 3 ] $(return);
	SecureInc kp.menuidcounter;
	return "\\q["$@arg[1]","$@arg[2]"]";
);
=end

# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��p??��?��̃J??��?��E??��?��??��?��??��?��^
kp.menuidcounter : 0

kp.onchoiceselect (
	Select.${kp.MenuGroup2}.$(EntNamReference 0),
	Select.$(EntNamReference 0)
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onchoiceselect

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : setMenuGroup

#==============================================================================


#??��?��I??��?��??��?��??��?��??��?��??��?��^??��?��C??��?��??��?��??��?��A??��?��E??��?��g??��?��iOnChoiceTimeout??��?��j=========================================
#??��?��u\q??��?��v??��?��ɂ�??��?��I??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��莞�ԕ�??��?��u??��?��??��?��??��?��ꂽ??��?��Ƃ�??��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�
#??��?��w??��?��b??��?��h??��?��??��?��??��?��C??��?��??��?��??��?��Z??��?��??��?��??��?��T??��?��[??��?��̑I??��?��??��?��??��?��??��?��??��?��??��?��??��?��u??��?��??��?��??��?��??��?��??��?��??��?��Ăяo??��?��??��?��??��?��??��?��??��?��ׁAfreeze??��?��t??��?��??��?��??��?��O??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��
#??��?��??��?��??��?��܂�

event.OnChoiceTimeout : $(
	resetFreeze;
	if $(.size kp.menuformname) $(
		# ??��?��??��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��
		# ??��?��^??��?��C??��?��??��?��??��?��A??��?��E??��?��g??��?��̕�??��?��ł�??��?��??��?��?��???��?��??��?��j??��?��??��?��??��?��[??��?��t??��?��H??��?��[??��?��??��?��??��?��??��?��??��?��ݒ肳??��?��??��?��邩??��?��??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��̂ŁA
		# ??��?��㗝�G??��?��??��?��??��?��g??��?��??��?��??��?��ɓ�??��?��e??��?��??��?��??��?��ڂ�??��?��Ă�??��?��??��?��??��?��??��?��??��?��
		.setstr kp.menuformname2 $(.encode_entryname ${kp.menuformname});
		.clear kp.menuformname;
		.setstr kp.menuidcounter 0;
		TalkSearch "kp.onchoicetimeout";
		.clear kp.menuformname2;
	) else if $(.size kp.MenuGroup) $(
		# ??��?��^??��?��C??��?��??��?��??��?��A??��?��E??��?��g??��?��̕�??��?��ł�??��?��??��?��ɑI??��?��??��?��??��?��??��?��??��?��O??��?��??��?��??��?��[??��?��v??��?��??��?��??��?��ݒ肳??��?��??��?��邩??��?��??��?��??��?��??��?��??��?��??��?��Ȃ�??��?��̂ŁA
		# ??��?��㗝�G??��?��??��?��??��?��g??��?��??��?��??��?��ɓ�??��?��e??��?��??��?��??��?��ڂ�??��?��Ă�??��?��??��?��??��?��??��?��??��?��
		.setstr kp.MenuGroup2 $(.encode_entryname ${kp.MenuGroup});
		.clear kp.MenuGroup;
		TalkSearch "kp.onchoicetimeout2";
		.clear kp.MenuGroup2;
	) else $(
		Talk "TalkTimeout";
	);
)

kp.onchoicetimeout (
	MenuFormTimeout.${kp.menuformname2},
	TalkTimeout,
	TalkGeneral
)

kp.onchoicetimeout2 (
	TalkTimeout.${kp.MenuGroup2},
	TalkTimeout,
	TalkGeneral
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onchoicetimeout, kp.onchoicetimeout2

#==============================================================================


#??��?��I??��?��??��?��??��?��??��?��??��?��??��?��Ƀ}??��?��E??��?��X??��?��J??��?��[??��?��\??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��/??��?��O??��?��ꂽ(OnChoiceEnter)========================
#??��?��I??��?��??��?��??��?��??��?��??��?��̏�Ƀ}??��?��E??��?��X??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��?��???��?��ƊO??��?��ꂽ??��?��?��???��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�
#??��?��??��?��??��?��T??��?��C??��?��??��?��??��?��??��?��??��?��g??��?��C??��?��x??��?��??��?��??��?��g??��?��ł�

event.OnChoiceEnter : $(
	if $(.size System.Request.Reference0) $(
		# ??��?��I??��?��??��?��??��?��??��?��??��?��Ƀ}??��?��E??��?��X??��?��??��?��??��?��??��?��??��?��??��?��??��?��
		.setstr @choice $(EntNamReference 1);
	) else $(
		# ??��?��I??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��}??��?��E??��?��X??��?��??��?��??��?��O??��?��ꂽ
		.setstr @choice "NotSelected";
	);
	if $(.size kp.MenuGroup) $(
		EntryRefer Selecting.$(.encode_entryname ${kp.MenuGroup}).${@choice};
	) else $(
		EntryRefer Selecting.${@choice};
	);
)

#==============================================================================


#??��?��L??��?��??��?��??��?��??��?��??��?��N??��?��^??��?��^??��?��A??��?��??��?��??��?��J??��?��[(\_a)??��?��̑I??��?��??��?��(OnAnchorSelect)===============================
# ??��?��u\_a??��?��v??��?��ɂ�??��?��L??��?��??��?��??��?��??��?��??��?��N??��?��^??��?��^??��?��A??��?��??��?��??��?��J??��?��[??��?��??��?��??��?��I??��?��??��?��??��?��??��?��??��?��ꂽ??��?��Ƃ�??��?��Ɏ�??��?��s??��?��??��?��??��?��??��?��܂�

event.OnAnchorSelect : $(Talk "Anchor."$(EntNamReference 0))

#==============================================================================


#??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��n??��?��??��?��??��?��??��?��??��?��Q**********************************************************

#??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��֘A(OnUpdate...)=============================================
#??��?��C??��?��x??��?��??��?��??��?��g??��?��J??��?��n??��?��??��?��??��?��??��?��freeze??��?��t??��?��??��?��??��?��O(1)??��?��??��?��ĂāA??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��0??��?��ɖ߂�??��?��Ă�??��?��??��?��??��?��??��?��??��?��??��?��

#??��?��X??��?��V??��?��J??��?��n(OnUpdateBegin)-------------------------------------------------------

event.OnUpdateBegin : $(
	setFreeze;
	if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
		TalkSearch "kp.onupdatebegin";
	) else $(
		TalkSearch "kp.onupdatebegin.system";
	);
)

kp.onupdatebegin (
	TalkUpdateBegin,
	TalkGeneralBegin
)

kp.onupdatebegin.system (
	SystemupdateBegin.$(NormReference 3),
	SystemupdateBegin,
	TalkGeneralBegin
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onupdatebegin, kp.onupdatebegin.system

#??��?��X??��?��V??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��(OnUpdateReady)---------------------------------------------------

event.OnUpdateReady : $(
	setFreeze;
	.setstr UpdateFileTotal $(AdjustOrigin $(NonNegReference 0));
	if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
		TalkSearch "kp.onupdateready";
	) else $(
		TalkSearch "kp.onupdateready.system";
	);
)

kp.onupdateready (
	TalkUpdateReady,
	TalkGeneral
)

kp.onupdateready.system (
	SystemupdateReady.$(NormReference 3),
	SystemupdateReady,
	TalkGeneral
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onupdateready, kp.onupdateready.system

#??��?��X??��?��V??��?��??��?��??��?��e??��?��_??��?��E??��?��??��?��??��?��??��?��??��?��[??��?��h??��?��J??��?��n(OnUpdate.OnDownloadBegin)----------------------------

event.OnUpdate.OnDownloadBegin : $(
	.setstr closemode 2;
	.setstr UpdateFileNo $(AdjustOrigin $(NonNegReference 1));
	TalkSearch "kp.onupdate.ondownloadbegin";
)

kp.onupdate.ondownloadbegin (
	TalkDownloadBegin,
	TalkGeneralBegin
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.onupdate.ondownloadbegin

#MD5??��?��ƍ�??��?��J??��?��n/??��?��??��?��??��?��??��?��/??��?��??��?��??��?��s---------------------------------------------------------

event.OnUpdate.OnMD5CompareBegin: $(TalkSearch "kp.onupdate.onmd5comparebegin")

kp.onupdate.onmd5comparebegin (
	TalkMD5Begin,
	TalkGeneralBegin
)

event.OnUpdate.OnMD5CompareComplete : $(TalkSearch "kp.onpudate.onmd5comparecomplete")

kp.onpudate.onmd5comparecomplete (
	TalkMD5Complete,
	TalkGeneralComplete
)

event.OnUpdate.OnMD5CompareFailure : $(TalkSearch "kp.onupdate.onmd5comparefailure")

kp.onupdate.onmd5comparefailure (
	TalkMD5Fail,
	TalkGeneralfail
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onupdate.onmd5comparebegin,
	kp.onpudate.onmd5comparecomplete,
	kp.onupdate.onmd5comparefailure
)

#??��?��X??��?��V??��?��??��?��??��?��??��?��(OnUpdateComplete)----------------------------------------------------

event.OnUpdateComplete : $(
	resetFreeze;
	if $[ ${System.Request.Reference0} == "none" ] $(
		.setstr closemode 0;
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
			TalkSearch "kp.onupdatecomplete.none";
		) else $(
			TalkSearch "kp.onupdatecomplete1";
		);
	) else $(
		# ??��?��l??��?��b??��?��g??��?��??��?��??��?��[??��?��N??��?��X??��?��V??��?��??��?��??��?��??��?��??��?��́A??��?��ċN??��?��??��?��??��?��Ɠ�??��?��??��?��
		GetifExist kp.callback.OnUpdateComplete;
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ] $(
			TalkSearch "kp.onupdatecomplete.changed";
		) else $(
			TalkSearch "kp.onupdatecomplete2";
		);
	);
	.clear UpdateFileNo;
	.clear UpdateFileTotal;
)

kp.onupdatecomplete.none (
	TalkUpdatecomplete.none,
	TalkGeneralComplete
)

kp.onupdatecomplete1 (
	SystemupdateNoupdate.$(NormReference 3),
	SystemupdateNoupdate,
	TalkGeneralComplete
)

kp.onupdatecomplete.changed (
	TalkUpdatecomplete.changed,
	TalkGeneralComplete
)

kp.onupdatecomplete2 (
	SystemupdateCompleted.$(NormReference 3),
	SystemupdateCompleted,
	TalkGeneralComplete
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect (
	kp.onupdatecomplete.none,
	kp.onupdatecomplete1,
	kp.onupdatecomplete.changed,
	kp.onupdatecomplete2
)

#??��?��X??��?��V??��?��??��?��??��?��s(OnUpdateFailure)-----------------------------------------------------

event.OnUpdateFailure : $(
	resetFreeze;
	TalkSearch $(
		if $[ $(SReference 3) == "" || $(SReference 3) == "ghost" ]
			"kp.dataupdateerror1"
		else
			"kp.dateupdateerror2"
	);
	.clear UpdateFileNo;
	.clear UpdateFileTotal;
)

kp.dataupdateerror1 (
	TalkUpdatefail.$(NormReference 0),
	TalkUpdatefail.etc,
	TalkGeneralfail
)

kp.dataupdateerror2 (
	SystemupdateFailed.$(NormReference 3).$(NormReference 0),
	SystemupdateFailed.$(NormReference 3).etc,
	SystemupdateFailed.$(NormReference 0),
	SystemupdateFailed.etc,
	TalkGeneralfail
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.dataupdateerror1 , kp.dataupdateerror2

#==============================================================================


#==============================================================================
#??��?��ȏ�GET SHIORI/3.0??��?��C??��?��x??��?��??��?��??��?��g
#==============================================================================


#==============================================================================
#??��?��ȉ�NOTIFY SHIORI/3.0
#==============================================================================

#??��?��??��?��??��?��ȃS??��?��[??��?��X??��?��g??��?��??��?��??��?��擾(ownerghostname)============================================
#Reference0??��?��Ɂu??��?��??��?��??��?��ȃS??��?��[??��?��X??��?��g??��?��??��?��??��?��v
#??��?��S??��?��[??��?��X??��?��g??��?��؂�ւ�??��?��ɂ�??��?��ċN??��?��??��?��??��?��̌�??��?��o??��?��??��?��??��?��x??��?��??��?��??��?��??��?��ړI??��?��Ŏ擾
notify.ownerghostname : $(
	.setstr System.OwnerGhost $(SReference 0);
	if $[ ${Character0} != ${System.OwnerGhost} ] $(
		# Character0??��?��Ɩ{??��?��̒ʒm??��?��??��?��\0??��?��??��?��??��?��??��?��??��?��??��?��v??��?��??��?��??��?��Ȃ�??��?��̂ŁA??��?��??��?��??��?��??��?��??��?��I??��?��Ɉ�v??��?��??��?��??��?��??��?��??��?��??��?��
		LogMsg "Character0 is NOT equal to the ghost name!";
		.setstr Character0 ${System.OwnerGhost};
	);
	.get "Execute.Ownerghostname";
)

#==============================================================================


#??��?��E??��?��B??��?��??��?��??��?��h??��?��E??��?��n??��?��??��?��??��?��h??��?��??��?��??��?��ʒm(hwnd)==================================================
#Reference0??��?��Ɂu??��?��??��?��??��?��??��?��??��?��瑤??��?��T??��?��[??��?��t??��?��B??��?��X[??��?��o??��?��C??��?��g??��?��l1]??��?��??��?��??��?��ɂイ??��?��??��?��??��?��T??��?��[??��?��t??��?��B??��?��X??��?��v
#Reference1??��?��Ɂu??��?��??��?��??��?��??��?��??��?��瑤??��?��o??��?��??��?��??��?��[??��?��??��?��[??��?��o??��?��C??��?��g??��?��l1]??��?��??��?��??��?��ɂイ??��?��??��?��??��?��o??��?��??��?��??��?��[??��?��??��?��??��?��v
#??��?��??��?��??��?��ꂼ??��?��??��?��o??��?��C??��?��g??��?��l1??��?��ŕ�??��?��??��?��??��?��??��?��??��?��??��?��System.Hwnd.shell??��?��ASystem.Hwnd.balloon??��?��Ɋi??��?��[
#??��?��i??��?��[??��?��??��?��AExecute.Hwnd??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.hwnd : $(
	.clear System.Hwnd.shell;
	.clear System.Hwnd.balloon;
	.split System.Hwnd.shell ${System.Request.Reference0} $(.chr 1);
	.split System.Hwnd.balloon ${System.Request.Reference1} $(.chr 1);
	.get "Execute.Hwnd";
)

#==============================================================================

#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��ς݃S??��?��[??��?��X??��?��g(installedghostname)==================================
#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��̐�??��?��??��?��??��?��??��?��Reference??��?��ɒʒm??��?��??��?��??��?��??��?��??��?��B
#MATERIA??��?��̓o??��?��O??��?��ł�??��?��ꂪ??��?��??��?��??��?��??��?��??��?��Ă�??��?��Ȃ�??��?��??��?��??��?��߁A??��?��??��?��??��?��͂Ŋl??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��
#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��ς݃S??��?��[??��?��X??��?��g??��?��??��?��System.InstalledGhost??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��Ɋi??��?��[??��?��??��?��??��?��??��?��
#??��?��i??��?��[??��?��??��?��AExecute.Installedghostname??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.installedghostname : $(
	.clear System.InstalledGhost;

	if $[ ${System.Request.Sender} != "embryo" ] $(
		# MATERIA??��?��ȊO
		.setstr @i 0;
		while $(.size System.Request.Reference${@i}) $(
			.pushstr System.InstalledGhost $(SReference ${@i});
			.inc @i;
		);
	) else $(
		# MATERIA
		GetInstalledGhost;
	);
	.get "Execute.Installedghostname";
)


# ??��?��e??��?��S??��?��[??��?��X??��?��g??��?��??��?��ghost\master\descript.txt??��?��??��?��??��?��??��?��A??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��σS??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��擾
=kis
function GetInstalledGhost $(
	.readdir @ghostdirs $(.cncpath ../../..);
	foreach @i @ghostdirs $(
		if $(.size @text) $(.clear @text);
		.textload @text $(.cncpath ../../../${@i}/ghost/master/descript.txt);
		loop $(.size @text) $(
			.setstr @j ${-1};
			if $(.match_at $@text[${@j}] "sakura.name,") $(
				.pushstr System.InstalledGhost $(.substr $@text[${@j}] 12);
				break;
			);
		);
	);
);
=end

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : GetInstalledGhost

#==============================================================================

#??��?��N??��?��??��?��??��?��??��?��??��?��̑�??��?��S??��?��[??��?��X??��?��g(otherghostname)============================================
#??��?��??��?��??��?��??��?��??��?��N??��?��??��?��??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��̐�??��?��??��?��??��?��??��?��Reference??��?��ɒʒm??��?��??��?��??��?��??��?��??��?��B
#System.OtherGhost??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��ɃS??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��??��?��??��?��ASystem.OtherGhostEx??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��??��?��
#??��?��u??��?��S??��?��[??��?��X??��?��g??��?��??��?��[??��?��o??��?��C??��?��g??��?��l1]??��?��??��?��??��?��??��?��??��?��??��?��T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�[??��?��o??��?��C??��?��g??��?��l1]??��?��??��?��??��?��ɂイ??��?��T??��?��[??��?��t??��?��B??��?��X??��?��ԍ�??��?��v
#??��?��??��?��??��?��i??��?��[??��?��??��?��??��?��??��?��B
#??��?��i??��?��[??��?��??��?��AExecute.Otherghostname??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.otherghostname : $(
	#.clear System.OtherGhost;
	#.clear System.OtherGhostEx;
	.move System.OtherGhost @otherghost;
	.move System.OtherGhostEx @otherghostex;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.clear @ghost;
		.split @ghost $(SReference ${@i}) $(.chr 1);
		.pushstr System.OtherGhost $@ghost[0];
		.pushstr System.OtherGhostEx $(SReference ${@i});
		.inc @i;
	);
	.copy System.OtherGhost @newotherghost;
	.copy System.OtherGhostEx @newotherghostex;
:rem
	if $[ ! $(GetString kp.onotherghostclosedflag) ] $(
		#??��?��V??��?��??��?��??��?��ɋN??��?��??��?��??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��A??��?��I??��?��??��?��??��?��??��?��??��?��??��?��??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��??��?��??��?��o
		.setstr @i 0;
		while $[ ${@i} < $(size @newotherghostex) ] $(
			.setstr @pos $(.find @otherghostex $(.getcode @newotherghost[${@i}]));
			if $[ ${@pos} >= 0 ] $(
				# ??��?��??��?��??��?��??��?��??��?��Ƃ�??��?��??��?��S??��?��[??��?��X??��?��g??��?��?��???��?��??��?��X??��?��g??��?��??��?��??��?��??��?��O??��?��??��?��
				.clear @otherghost[${@pos}];
				.clear @otherghostex[${@pos}];
				.clear @newotherghost[${@i}];
				.clear @newotherghostex[${@i}];
			) else $(
				.inc @i;
			);
		);
		#??��?��??��?��??��?��??��?��??��?��͂�??��?��??��?��??��?��܂�#
	);
	.clear kp.onotherghostclosedflag;
:endrem
	.get "Execute.Otherghostname";
)

#==============================================================================

#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��ς݃V??��?��F??��?��??��?��(installedshellname)====================================
#??��?��N??��?��??��?��??��?��??��?��??��?��̃S??��?��[??��?��X??��?��g??��?��ɃC??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��V??��?��F??��?��??��?��??��?��̐�??��?��??��?��??��?��??��?��Reference??��?��ɒʒm??��?��??��?��??��?��??��?��??��?��B
#System.InstalledShell??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��ɃV??��?��F??��?��??��?��??��?��??��?��??��?��??��?��??��?��i??��?��[??��?��??��?��??��?��??��?��B
#??��?��i??��?��[??��?��??��?��AExecute.Installedshellname??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.installedshellname : $(
	.clear System.InstalledShell;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.pushstr System.InstalledShell $(SReference ${@i});
		.inc @i;
	);
	.get "Execute.Installedshellname";
)

#==============================================================================

#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��ς݃o??��?��??��?��??��?��[??��?��??��?��(installedballoonname)================================
#??��?��C??��?��??��?��??��?��X??��?��g??��?��[??��?��??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��o??��?��??��?��??��?��[??��?��??��?��??��?��̐�??��?��??��?��??��?��??��?��Reference??��?��ɒʒm??��?��??��?��??��?��??��?��??��?��B
#System.InstalledBalloon??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��Ƀo??��?��??��?��??��?��[??��?��??��?��??��?��??��?��??��?��??��?��??��?��i??��?��[??��?��??��?��??��?��??��?��B
#??��?��i??��?��[??��?��??��?��AExecute.Installedballoonname??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.installedballoonname : $(
	.clear System.InstalledBalloon;

	.setstr @i 0;
	while $(.size System.Request.Reference${@i}) $(
		.pushstr System.InstalledBalloon $(SReference ${@i});
		.inc @i;
	);
	.get "Execute.Installedballoonname";
)

#==============================================================================

#Unique ID??��?��ʒm(uniqueid)=======================================================
#??��?��S??��?��[??��?��X??��?��g??��?��ɋU??��?��??��?��??��?��??��?��??��?��ɂ�??��?��??��?��ID??��?��??��?��^??��?��??��?��??��?��??��?��BSSTP??��?��œ�??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��ۂɕK??��?��v??��?��B
#System.UniqueId??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��Ɋi??��?��[??��?��??��?��??��?��??��?��B
#??��?��i??��?��[??��?��??��?��AExecute.Uniqueid??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��
notify.uniqueid : $(
	.setstr System.UniqueId ${System.Request.Reference0};
	.get "Execute.Uniqueid";
)

#==============================================================================

#??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��ʒm(OnNotifySelfInfo)============================================
#??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��g??��?��Ɋւ�??��?��??��?��??��?��??��?��(\0??��?��??��?��??��?��A\1??��?��??��?��??��?��A??��?��V??��?��F??��?��??��?��??��?��??��?��??��?��??��?��)??��?��??��?��??��?��ʒm??��?��??��?��??��?��??��?��??��?��B
#??��?��??��?��??��?��i??��?��[??��?��??��?��AExecute.SelfInfo??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��

notify.OnNotifySelfInfo : $(
	if $[ ! ${System.SelfName} ] $(.setstr System.SelfName $(SReference 0));
	if $[ ! ${Character0} ] $(.setstr Character0 $(SReference1));
	if $[ ! ${Character1} ] $(.setstr Character1 $(SReference2));
	.setstr System.Shell $(SReference 3);
	.setstr System.ShellPath $(Reference 4);
	.setstr System.Balloon $(SReference 5);
	.setstr System.BalloonPath $(Reference 6);
	.get "Execute.SelfInfo";
)

=kis
# SSP??��?��ȊO??��?��??��?��OnNotifySelfInfo??��?��??��?��??��?��??��?��??��?��??��?��??��?��??��?��邽??��?��߂̃R??��?��}??��?��??��?��??��?��h
function GetDescript $(
	.textload @fin descript.txt;
	if $[ $(.size @fin) == 0 ] $(return);

	.setstr @done 0;
	loop $(.size @fin) $(
		.setstr @i ${-1};
		.setstr @str $@fin[${@i}];
		loop $(.size kp.getdescript.tosearch) $(
			.setstr @j ${-1};
			.setstr @entry $kp.getdescript.tosearch[${@j}];
			if $(.match_at ${@str} ${@entry}) $(
				.setstr $kp.getdescript.toset[${@j}] $(.substr ${@str} $(.length ${@entry}));
				.inc @done;
				break;
			);
		);
		if $[ ${@done} == $(.size kp.getdescript.tosearch) ] $(return);
	);
);
=end

kp.getdescript.tosearch (
	"name,",
	"sakura.name,",
	"kero.name,"
)

kp.getdescript.toset (
	"System.SelfName",
	"Character0",
	"Character1"
)

# ??��?��ی�ΏۃG??��?��??��?��??��?��g??��?��??��?��??��?��ł�??��?��邱??��?��Ƃ�錾
kp.EntryToProtect : kp.getdescript.tosearch, kp.getdescript.tset

# ??��?��ی�Ώۊ֐�??��?��ł�??��?��邱??��?��Ƃ�錾
kp.FunctionToProtect : GetDescript

#==============================================================================

#OS??��?��??��?��??��?��ʒm(OnNotifyOSInfo)====================================================
#??��?��S??��?��[??��?��X??��?��g??��?��??��?��??��?��N??��?��??��?��??��?��??��?��??��?��Ă�??��?��??��?��OS??��?��̏�??��?��ʒm??��?��??��?��??��?��??��?��??��?��B
#??��?��??��?��??��?��i??��?��[??��?��??��?��AExecute.OSInfo??��?��G??��?��??��?��??��?��g??��?��??��?��??��?��̏�??��?��??��?��??��?��??��?��??��?��??��?��??��?��s??��?��??��?��??��?��??��?��

notify.OnNotifyOSInfo : $(
	.split @vername $(SReference 0) ",";
	.setstr System.OS.Name $@vername[0];
	.setstr System.OS.Version  $@vername[1];
	.setstr worktime.OS $[ $(IntReference 3) / 60 ];
	.setstr cntwork.OS ${worktime.OS};
	.get "Execute.OSInfo";
)

# ??��?��V??��?��X??��?��e??��?��??��?��??��?��??��?��??��?��̏�??��?��??��?��??��?��l
System.OS.Name    : "UNKNOWN"
System.OS.Version : "0.00"

#==============================================================================


#==============================================================================
#??��?��ȏ�NOTIFY SHIORI/3.0
#==============================================================================
